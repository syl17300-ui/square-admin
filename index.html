<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Square | Admin Console</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Pretendard:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:          #050810;
      --bg2:         #080c17;
      --panel:       #0f1528;
      --panel2:      #151c35;
      --panel3:      #1a2340;
      --border:      rgba(58,72,130,.70);
      --border2:     rgba(58,72,130,.40);
      --text:        #e8eeff;
      --text2:       #d0d8f0;
      --muted:       #8a95bd;
      --muted2:      #5e6890;

      --neon:        #3b9eff;
      --neon-glow:   rgba(59,158,255,.18);
      --neon-soft:   rgba(59,158,255,.08);
      --neon2:       #5ec8ff;
      --neon-text:   #8dcfff;

      --gold:        #c9a227;
      --gold2:       #f0cb5a;
      --gold-soft:   rgba(201,162,39,.10);
      --green:       #2dcc85;
      --green-soft:  rgba(45,204,133,.10);
      --red:         #f05252;
      --red-soft:    rgba(240,82,82,.10);
      --gray-soft:   rgba(122,133,171,.10);

      --shadow-sm:   0 2px 8px rgba(0,0,0,.35);
      --shadow:      0 8px 32px rgba(0,0,0,.50);
      --shadow-lg:   0 20px 60px rgba(0,0,0,.60);
      --radius:      16px;
      --radius2:     12px;
      --radius3:     8px;
      --focus:       0 0 0 3px rgba(59,158,255,.28);

      --bgImg: url('chip-bg.png');
    }

    *, *::before, *::after {
      box-sizing: border-box;
      animation: none !important;
      transition: none !important;
    }

    html { height:100%; background: var(--bg); }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Pretendard", "Apple SD Gothic Neo", "Noto Sans KR", ui-sans-serif, system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.5;
      letter-spacing: -.15px;
      color: var(--text);
      overflow-x: hidden;

      background:
        /* 네온 빛 번짐 */
        radial-gradient(ellipse 1100px 600px at 15% 5%,  rgba(59,158,255,.10) 0%, transparent 65%),
        radial-gradient(ellipse 700px 500px at 88% 20%,  rgba(94,200,255,.07) 0%, transparent 60%),
        radial-gradient(ellipse 800px 600px at 55% 110%, rgba(59,158,255,.06) 0%, transparent 55%),
        /* 격자 */
        linear-gradient(rgba(255,255,255,.028) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.028) 1px, transparent 1px),
        linear-gradient(rgba(59,158,255,.018) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59,158,255,.018) 1px, transparent 1px),
        /* 배경 */
        linear-gradient(160deg, #060a18 0%, #050810 60%, #070b1a 100%),
        var(--bgImg);

      background-size:
        auto, auto, auto,
        72px 72px, 72px 72px,
        18px 18px, 18px 18px,
        auto,
        cover;

      background-position: center,center,center, 0 0,0 0, 0 0,0 0, center, center;
      background-repeat: no-repeat,no-repeat,no-repeat, repeat,repeat, repeat,repeat, no-repeat, no-repeat;
    }

    a { color: inherit; text-decoration: none; }

    /* ───── 스크롤바 ───── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--panel); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted2); }

    /* ────────────────────────────────────────
       TOPBAR
    ──────────────────────────────────────── */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      background: rgba(5,8,16,.75);
      border-bottom: 1px solid var(--border2);
      box-shadow: 0 1px 0 rgba(59,158,255,.06), var(--shadow-sm);
    }

    .topbar-inner {
      max-width: 1520px; margin: 0 auto;
      padding: 0 28px;
      height: 62px;
      display: flex; align-items: center; justify-content: space-between; gap: 20px;
    }

    /* ─ 브랜드 ─ */
    .brand {
      display: flex; align-items: center; gap: 14px;
      flex-shrink: 0;
    }

    .logoMark {
      width: 38px; height: 38px;
      border-radius: 9px;
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);
      position: relative;
      flex-shrink: 0;
      overflow: hidden;
      box-shadow: 
        0 0 0 2px rgba(59,130,246,.20),
        0 4px 12px rgba(30,58,138,.35),
        inset 0 1px 1px rgba(255,255,255,.15);
    }
    
    /* 정사각형 모양 3개 (스퀘어 컨셉) */
    .logoMark::before {
      content: "";
      position: absolute;
      width: 8px; height: 8px;
      background: rgba(255,255,255,.90);
      border-radius: 2px;
      top: 7px; left: 7px;
      box-shadow: 
        14px 0 0 rgba(255,255,255,.90),
        0 14px 0 rgba(255,255,255,.90),
        14px 14px 0 rgba(96,165,250,.85);
    }
    
    .logoMark::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(59,130,246,.15) 100%);
    }

    .brandTitle { display: flex; flex-direction: column; gap: 1px; }
    .brandTitle .t1 {
      font-size: 15px; font-weight: 800;
      color: #fff;
      letter-spacing: .1px;
    }
    .brandTitle .t2 {
      font-size: 11px; font-weight: 500;
      color: var(--muted);
      letter-spacing: .4px;
      font-family: "DM Mono", monospace;
    }

    /* ─ 네비 ─ */
    .nav { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }

    .tab {
      padding: 7px 14px;
      border-radius: var(--radius3);
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      font-family: inherit;
      letter-spacing: -.1px;
    }
    .tab:hover {
      color: var(--text2);
      background: rgba(255,255,255,.04);
      border-color: var(--border2);
    }
    .tab.active {
      color: var(--neon-text);
      background: var(--neon-soft);
      border-color: rgba(59,158,255,.30);
      font-weight: 700;
    }

    /* ─ 유저박스 ─ */
    .userBox {
      display: flex; align-items: center; gap: 10px;
      flex-shrink: 0;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 9px;
      padding: 7px 13px;
      border-radius: 99px;
      border: 1px solid var(--border2);
      background: rgba(12,17,34,.80);
      font-size: 13px; font-weight: 600;
      color: var(--text2);
      white-space: nowrap;
    }
    .pill .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 0 3px var(--green-soft), 0 0 8px var(--green);
      flex-shrink: 0;
    }

    /* ────────────────────────────────────────
       BUTTONS
    ──────────────────────────────────────── */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 5px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text2);
      padding: 10px 16px;
      border-radius: var(--radius3);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      font-family: inherit;
      letter-spacing: -.1px;
    }
    .btn:hover { background: var(--panel3); border-color: var(--border); color: var(--text); }
    .btn:active { opacity: .8; }
    .btn[disabled] { opacity: .4; cursor: not-allowed; }

    .btnNeon {
      background: linear-gradient(135deg, #3b9eff, #1e7ae0);
      border-color: rgba(59,158,255,.50);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 2px 12px rgba(59,158,255,.25), inset 0 1px 0 rgba(255,255,255,.15);
    }
    .btnNeon:hover {
      background: linear-gradient(135deg, #4daeff, #2888f0);
      box-shadow: 0 4px 20px rgba(59,158,255,.38);
      color: #fff;
    }

    .btnRed {
      background: var(--red-soft);
      border-color: rgba(240,82,82,.30);
      color: #ffb8b8;
    }
    .btnRed:hover { background: rgba(240,82,82,.16); color: #ffd4d4; }

    .btnGreen {
      background: var(--green-soft);
      border-color: rgba(45,204,133,.30);
      color: #a8ffdb;
    }
    .btnGreen:hover { background: rgba(45,204,133,.16); color: #c4ffe8; }

    .mini { padding: 8px 14px; border-radius: 7px; font-size: 13px; }

    /* ────────────────────────────────────────
       LAYOUT
    ──────────────────────────────────────── */
    .wrap { max-width: 1620px; margin: 0 auto; padding: 20px 24px; }

    .grid { display: grid; gap: 16px; }

    /* ────────────────────────────────────────
       CARD
    ──────────────────────────────────────── */
    .card {
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      background: rgba(10,14,30,.70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.03) inset,
        var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(12px);
    }

    .cardHeader {
      padding: 14px 18px;
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
      border-bottom: 1px solid var(--border2);
      background: linear-gradient(180deg, rgba(59,158,255,.04) 0%, transparent 100%);
    }

    .cardHeader .h { display: flex; flex-direction: column; gap: 3px; }
    .cardHeader .h .title {
      font-size: 16px; font-weight: 800;
      color: #fff;
      letter-spacing: -.3px;
    }
    .cardHeader .h .sub {
      font-size: 11px; font-weight: 500;
      color: var(--muted);
      letter-spacing: .1px;
    }

    .cardBody { padding: 16px 18px; }

    .rightActions {
      display: flex; gap: 8px; flex-wrap: wrap;
      justify-content: flex-end; align-items: center;
    }

    /* ────────────────────────────────────────
       FORMS
    ──────────────────────────────────────── */
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .field { flex: 1; min-width: 200px; }

    .label {
      font-size: 10px; font-weight: 700;
      color: var(--muted);
      letter-spacing: .6px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      border-radius: var(--radius3);
      border: 1px solid var(--border);
      background: rgba(5,8,18,.70);
      color: var(--text);
      outline: none;
      font-weight: 500;
      font-size: 14px;
      font-family: inherit;
      letter-spacing: -.1px;
    }
    .input::placeholder { color: var(--muted2); }
    .input:focus, select:focus, textarea:focus {
      box-shadow: var(--focus);
      border-color: rgba(59,158,255,.55);
      background: rgba(5,8,18,.90);
    }
    textarea { min-height: 90px; resize: vertical; }

    .hint {
      font-size: 12px; color: var(--muted);
      margin-top: 8px;
      line-height: 1.65;
      font-weight: 500;
    }

    .hr { height: 1px; background: var(--border2); margin: 18px 0; }

    /* ────────────────────────────────────────
       TABLE
    ──────────────────────────────────────── */
    .tableScroll {
      overflow: auto;
      max-height: calc(100vh - 320px);
      border-top: 1px solid var(--border2);
      margin-top: 16px;
    }

    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 15px; }

    thead th {
      text-align: left;
      font-size: 13px; font-weight: 700;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 13px 15px;
      border-bottom: 1px solid var(--border2);
      background: rgba(6,10,24,.85);
      position: sticky; top: 0; z-index: 2;
      white-space: nowrap;
    }

    tbody td {
      padding: 14px 15px;
      border-bottom: 1px solid rgba(48,62,110,.25);
      vertical-align: middle;
      white-space: nowrap;
      font-weight: 500;
      color: var(--text2);
      font-size: 15px;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: rgba(59,158,255,.04); }

    /* ────────────────────────────────────────
       TAGS / CHIPS
    ──────────────────────────────────────── */
    .tag {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 5px 11px;
      border-radius: 99px;
      border: 1px solid var(--border2);
      background: rgba(6,10,24,.70);
      color: var(--text2);
      font-weight: 600;
      white-space: nowrap;
      font-size: 13px;
      line-height: 1;
      letter-spacing: -.1px;
    }
    .tag.gold {
      border-color: rgba(201,162,39,.45);
      background: var(--gold-soft);
      color: #f0cb5a;
    }
    .tag.gray {
      border-color: rgba(122,133,171,.25);
      background: var(--gray-soft);
      color: var(--muted);
    }
    .tag.green {
      border-color: rgba(45,204,133,.35);
      background: var(--green-soft);
      color: #5dffc0;
    }
    .tag.red {
      border-color: rgba(240,82,82,.35);
      background: var(--red-soft);
      color: #ff9a9a;
    }
    .tag.blue {
      border-color: rgba(59,158,255,.35);
      background: var(--neon-soft);
      color: var(--neon-text);
    }
    .tag.purple {
      border-color: rgba(168,85,247,.35);
      background: rgba(168,85,247,.10);
      color: #d8b4fe;
    }
    .tag.orange {
      border-color: rgba(251,146,60,.35);
      background: rgba(251,146,60,.10);
      color: #fdba74;
    }
    .tag.cyan {
      border-color: rgba(34,211,238,.35);
      background: rgba(34,211,238,.10);
      color: #67e8f9;
    }
    .typeTag { font-weight: 700; }

    /* ────────────────────────────────────────
       KPI
    ──────────────────────────────────────── */
    .kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

    @media (max-width: 980px) {
      .kpi { grid-template-columns: repeat(2,1fr); }
      .topbar-inner { flex-wrap: wrap; justify-content: center; height: auto; padding: 14px 20px; }
    }

    .kpi .box {
      border: 1px solid var(--border2);
      background: rgba(8,12,26,.60);
      border-radius: var(--radius2);
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
      cursor: default;
    }
    .kpi .box.clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .kpi .box.clickable:hover {
      background: rgba(12,16,30,.75);
      border-color: var(--border);
      transform: translateY(-1px);
    }
    .kpi .box::before {
      content: "";
      position: absolute; top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--neon) 0%, transparent 70%);
      opacity: .6;
    }
    .kpi .box .v {
      font-size: 28px; font-weight: 800;
      color: #fff;
      letter-spacing: -1px;
      line-height: 1;
      font-family: "DM Mono", monospace;
    }
    .kpi .box .k {
      font-size: 11px; color: var(--muted);
      font-weight: 600; margin-top: 8px;
      letter-spacing: .4px;
      text-transform: uppercase;
    }

    /* ────────────────────────────────────────
       LOGIN
    ──────────────────────────────────────── */
    .loginWrap {
      min-height: 100vh;
      display: grid; place-items: center;
      padding: 24px;
    }

    .loginCard {
      width: min(460px, 96vw);
      border: 1px solid var(--border2);
      border-radius: 20px;
      background: rgba(10,14,30,.85);
      box-shadow: var(--shadow-lg), 0 0 80px rgba(59,158,255,.06);
      overflow: hidden;
      backdrop-filter: blur(20px);
    }

    .loginTop {
      padding: 24px 24px 20px;
      border-bottom: 1px solid var(--border2);
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(180deg, rgba(59,158,255,.05) 0%, transparent 100%);
    }
    .loginTop .t .a {
      font-size: 26px; font-weight: 900;
      color: #fff;
      letter-spacing: -.5px;
    }
    .loginTop .t .b { display: none; }

    .loginBody { padding: 22px 24px; }

    /* ────────────────────────────────────────
       TOAST
    ──────────────────────────────────────── */
    .toast {
      position: fixed; right: 20px; bottom: 20px; z-index: 999;
      padding: 14px 18px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(12,17,34,.96);
      box-shadow: var(--shadow), 0 0 0 1px rgba(59,158,255,.10) inset;
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      display: none;
      max-width: 420px;
      backdrop-filter: blur(16px);
    }
    .toast.show { display: block; }
    .toast .s { color: var(--muted); font-weight: 500; font-size: 12px; margin-top: 6px; line-height: 1.5; }

    /* ────────────────────────────────────────
       MISC
    ──────────────────────────────────────── */
    .tInput {
      width: 100%; min-width: 200px;
      padding: 9px 11px;
      border-radius: var(--radius3);
      border: 1px solid var(--border);
      background: rgba(5,8,18,.80);
      color: var(--text);
      outline: none;
      font-weight: 500;
      font-size: 13px;
      font-family: inherit;
    }
    .tInput:focus {
      box-shadow: var(--focus);
      border-color: rgba(59,158,255,.55);
    }

    .colLink {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: bottom;
      color: var(--neon-text);
      font-family: "DM Mono", monospace;
      font-size: 12px;
    }

    .chk {
      width: 16px; height: 16px;
      accent-color: var(--neon);
      cursor: pointer;
    }

    .actionBar {
      display: flex; gap: 8px; flex-wrap: wrap;
      align-items: center; justify-content: flex-end;
    }

    .expSoon { color: var(--red) !important; font-weight: 700 !important; }

    .linkCell { white-space: normal !important; line-height: 1.45; }
    .linkCell .k {
      color: var(--muted2); font-weight: 600; font-size: 11px;
      margin-right: 5px; letter-spacing: .3px;
    }
    .linkCell .v {
      display: inline-block;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: bottom;
      white-space: nowrap;
      color: var(--neon-text);
      font-family: "DM Mono", monospace;
      font-size: 12px;
    }

    .twoInputs { display: flex; flex-direction: column; gap: 8px; min-width: 240px; }

    .muted { color: var(--muted); }

    .foot {
      padding: 16px 28px;
      color: var(--muted2);
      font-size: 11px;
      text-align: center;
      letter-spacing: .3px;
      border-top: 1px solid var(--border2);
      margin-top: 8px;
    }

    /* ─ 인라인 badge ─ */
    .slotHintBold { color: var(--text); font-weight: 700; }

    /* ────────────────────────────────────────
       MODAL
    ──────────────────────────────────────── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }

    .modal-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      max-width: 480px;
      width: 100%;
      overflow: hidden;
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border2);
      background: linear-gradient(180deg, rgba(59,158,255,.05) 0%, transparent 100%);
    }
    .modal-header .title {
      font-size: 17px; font-weight: 800;
      color: #fff;
    }
    .modal-header .sub {
      font-size: 12px; color: var(--muted);
      margin-top: 4px;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border2);
      display: flex; gap: 8px; justify-content: flex-end;
    }

    .modal-field {
      margin-bottom: 16px;
    }
    .modal-field:last-child { margin-bottom: 0; }
    .modal-label {
      font-size: 12px; font-weight: 700;
      color: var(--text2);
      margin-bottom: 8px;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius3);
      border: 1px solid var(--border);
      background: rgba(5,8,18,.70);
      color: var(--text);
      outline: none;
      font-weight: 500;
      font-size: 14px;
      font-family: inherit;
    }
    .modal-input:focus {
      box-shadow: var(--focus);
      border-color: rgba(59,158,255,.55);
    }
    .modal-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius3);
      border: 1px solid var(--border);
      background: rgba(5,8,18,.70);
      color: var(--text);
      outline: none;
      font-weight: 500;
      font-size: 14px;
      font-family: inherit;
    }
    .modal-select:focus {
      box-shadow: var(--focus);
      border-color: rgba(59,158,255,.55);
    }
  </style>
</head>

<body>
  <div id="loginView" class="loginWrap" style="display:none">
    <div class="loginCard">
      <div class="loginTop">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="t">
          <div class="a">Square</div>
          <div class="b"></div>
        </div>
      </div>
      <div class="loginBody">
        <div class="row">
          <div class="field">
            <div class="label" style="font-size:16px;font-weight:700">아이디 또는 이메일</div>
            <input id="loginId" class="input" placeholder="syl17300 또는 @square.local" autocomplete="username" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="field">
            <div class="label" style="font-size:16px;font-weight:700">비밀번호</div>
            <input id="loginPw" class="input" type="password" placeholder="비밀번호" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;align-items:center;margin-top:16px">
          <button class="btn btnNeon" onclick="login()">로그인</button>
        </div>
      </div>
    </div>
  </div>

  <div id="appView" style="display:none">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logoMark" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="t1">스퀘어</div>
            <div class="t2">Admin Console</div>
          </div>
        </div>

        <div class="nav" id="navTabs"></div>

        <div class="userBox">
          <div class="pill">
            <div class="dot"></div>
            <span id="whoText">-</span>
          </div>
          <button class="btn mini" onclick="logout()">로그아웃</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div id="page_dash" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">대시보드</div>
              <div class="sub">슬롯 운영 현황</div>
            </div>
            <div class="rightActions">
              <button class="btn mini" onclick="refresh()">새로고침</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="kpi" id="kpi"></div>
          </div>
        </div>
      </div>

      <div id="page_slots" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯관리</div>
            </div>
            <div class="rightActions">
              <div class="actionBar" id="slotBulkBar"></div>
              <button class="btn mini" onclick="refresh()">새로고침</button>
            </div>
          </div>

          <div class="cardBody" style="padding-bottom:0">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">검색</div>
                <input id="slotSearch" class="input" placeholder="키워드 / 사용자ID / 링크 일부 / 스토어ID" oninput="renderSlotsPage()" />
              </div>
              <div class="field" style="min-width:200px">
                <div class="label">필터</div>
                <select id="slotFilter" onchange="renderSlotsPage()">
                  <option value="ALL">전체</option>
                  <option value="OPENED">오픈됨</option>
                  <option value="SAVED">정상</option>
                  <option value="ALLOCATED">부여됨(숨김)</option>
                  <option value="EXPIRING">만료 예정</option>
                  <option value="EXPIRED">만료</option>
                </select>
              </div>
              <div class="field" style="min-width:200px">
                <div class="label">사용자</div>
                <select id="slotUserFilter" onchange="renderSlotsPage()"></select>
              </div>
            </div>
            <div class="hint" id="slotHint"></div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:40px">선택</th>
                  <th style="width:60px">번호</th>
                  <th style="width:140px">사용자</th>
                  <th style="width:85px">타입</th>
                  <th style="width:120px">스토어ID</th>
                  <th style="width:95px">시작일</th>
                  <th style="width:95px">만료일</th>
                  <th style="width:75px">상태</th>
                  <th style="width:80px">수정</th>
                  <th style="width:120px">메인키워드</th>
                  <th style="width:120px">조합키워드1</th>
                  <th style="width:120px">조합키워드2</th>
                  <th style="width:160px">링크</th>
                  <th style="width:110px">메모</th>
                  <th style="width:240px">관리</th>
                </tr>
              </thead>
              <tbody id="slotTbody"></tbody>
            </table>
          </div>

          <div class="cardBody">
            <div class="smallNote" style="display:none"></div>
          </div>
        </div>
      </div>

      <div id="page_assign" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯부여</div>
              <div class="sub">기본 시작일: 내일</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">관리자 전용</span>
            </div>
          </div>
          <div class="cardBody">
            <div class="row">
              <div class="field">
                <div class="label">사용자(광고주/대행사/총판사 ID)</div>
                <select id="assign_user"></select>
              </div>
              <div class="field">
                <div class="label">슬롯타입</div>
                <select id="assign_type">
                  <option value="스퀘어(단일)">스퀘어(단일)</option>
                  <option value="스퀘어(원부)">스퀘어(원부)</option>
                </select>
              </div>
              <div class="field" style="min-width:160px">
                <div class="label">수량</div>
                <input id="assign_qty" class="input" type="number" min="1" value="10" />
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="field">
                <div class="label">시작일</div>
                <input id="assign_start" class="input" type="date" onchange="syncAssignEndFromStart()" />
              </div>
              <div class="field">
                <div class="label">만료일</div>
                <input id="assign_end" class="input" type="date" />
              </div>
              <div class="field" style="min-width:340px;display:flex;align-items:flex-end;gap:8px;justify-content:flex-end">
                <button class="btn mini" onclick="quickDays(1)">+1일</button>
                <button class="btn mini" onclick="quickDays(7)">+7일</button>
                <button class="btn mini" onclick="quickDays(10)">+10일</button>
                <button class="btn btnNeon" onclick="allocateSlots()">슬롯부여</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page_users" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">사용자 관리</div>
              <div class="sub">✅ 마스터 계정은 관리자(ADMIN) 계정도 생성/수정 가능</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">관리자 전용</span>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:240px">
                <div class="label">아이디(요청 아이디)</div>
                <input id="u_id" class="input" placeholder="예: brother_topbiz" />
              </div>
              <div class="field" style="min-width:200px">
                <div class="label">비밀번호</div>
                <input id="u_pw" class="input" placeholder="예: 1234" />
              </div>
              <div class="field" style="min-width:200px">
                <div class="label">역할</div>
                <select id="u_role">
                  <option value="ADVERTISER">광고주</option>
                  <option value="AGENCY">대행사</option>
                  <option value="DISTRIBUTOR">총판사</option>
                </select>
              </div>
              <div class="field" style="min-width:280px">
                <div class="label">업체명(필수)</div>
                <input id="u_company" class="input" placeholder="예: 브라더탑비즈" />
              </div>
              <div class="field" style="min-width:160px;display:flex;align-items:flex-end;justify-content:flex-end">
                <button class="btn btnNeon" onclick="createUser()">등록하기</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="tableScroll" style="max-height:55vh;margin-top:0">
              <table>
                <thead>
                  <tr>
                    <th style="width:240px">아이디</th>
                    <th style="width:160px">역할</th>
                    <th>업체명</th>
                    <th style="width:220px">비밀번호</th>
                    <th style="width:200px">수정</th>
                    <th style="width:140px">삭제</th>
                  </tr>
                </thead>
                <tbody id="userTbody"></tbody>
              </table>
            </div>
            <div class="hint" style="margin-top:14px">※ 이 페이지는 Supabase Auth + profiles 테이블 기반입니다. (호환: app_users 있으면 자동 fallback)</div>
          </div>
        </div>
      </div>

      <div id="page_cleanup" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯 삭제</div>
              <div class="sub">철회 대기 슬롯만 표시</div>
            </div>
            <div class="rightActions">
              <div class="actionBar" id="cleanupBulkBar"></div>
              <button class="btn mini" onclick="renderCleanup()">새로고침</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">검색</div>
                <input id="cleanSearch" class="input" placeholder="사용자ID / 키워드 / 링크 일부 / 스토어ID" oninput="renderCleanup()" />
              </div>
              <div class="field" style="min-width:200px">
                <div class="label">사용자</div>
                <select id="cleanUser" onchange="renderCleanup()"></select>
              </div>
            </div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:48px">선택</th>
                  <th style="width:72px">번호</th>
                  <th style="width:240px">사용자</th>
                  <th style="width:100px">타입</th>
                  <th style="width:190px">스토어ID</th>
                  <th style="width:120px">상태</th>
                  <th>키워드</th>
                  <th style="width:230px">링크</th>
                  <th>메모</th>
                  <th style="width:130px">완전삭제</th>
                </tr>
              </thead>
              <tbody id="cleanTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="page_logs" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">로그</div>
              <div class="sub">최근 동작 로그</div>
            </div>
          </div>
          <div class="cardBody">
            <div id="logBox" class="muted" style="font-family:'DM Mono',monospace;font-size:12px;line-height:1.8;white-space:pre-wrap;font-weight:500"></div>
          </div>
        </div>
      </div>

      <div class="foot">© Square Admin Console · Supabase Auth + DB</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- 연장 모달 -->
  <div id="extendModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div class="title">슬롯 연장</div>
        <div class="sub">연장할 일수를 입력하세요</div>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <div class="modal-label">연장할 일수 (숫자만 입력)</div>
          <input type="number" id="extendDaysInput" class="modal-input" min="1" value="7" placeholder="예: 7" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn mini" onclick="closeExtendModal()">취소</button>
        <button class="btn mini btnNeon" onclick="confirmExtend()">확인</button>
      </div>
    </div>
  </div>

  <!-- supabase-js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * 0) Supabase 연결값
     ***********************/
    const SUPABASE_URL = "https://wavosfsnwwrcmcsgvlho.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhdm9zZnNud3dyY21jc2d2bGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjgwNjEsImV4cCI6MjA4NTkwNDA2MX0.5hh7b9u12aCDTuGtjQycVzBEkplnotDvLkmt5DmJ8eU";

    const EMAIL_DOMAIN = "square.local";
    const MASTER_ID = "syl17300";
    const PROFILE_TABLE_PRIMARY = "profiles";
    const PROFILE_TABLE_FALLBACK = "app_users";
    const EDGE_CREATE_USER = "admin-create-user";
    const EDGE_DELETE_USER = "admin-delete-user";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ Supabase 세션 자동 갱신
    sb.auth.onAuthStateChange((event, session) => {
      if (event === 'TOKEN_REFRESHED') {
        console.log('✅ 세션 자동 갱신됨');
      } else if (event === 'SIGNED_OUT') {
        console.log('세션 만료됨');
      }
    });

    /***********************
     * 1) 유틸
     ***********************/
    function nowISO(){ return new Date().toISOString(); }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function toast(title, sub){
      const el = document.getElementById("toast");
      el.innerHTML = `<div>${escapeHtml(title)}</div>${sub ? `<div class="s">${escapeHtml(sub)}</div>` : ""}`;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 3000);
    }

    function fmtDT(iso){
      if(!iso) return "-";
      const d = new Date(iso);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function toEmail(input){
      const v = (input || "").trim().toLowerCase();
      if(!v) return "";
      if(v.includes("@")) return v;
      return `${v}@${EMAIL_DOMAIN}`;
    }

    function addDaysToDateStr(dateStr, days){
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }

    function isExpiringTomorrow(endDateStr){
      if(!endDateStr) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const end = new Date(endDateStr + "T00:00:00"); end.setHours(0,0,0,0);
      const diffDays = Math.round((end - today) / (24*60*60*1000));
      return diffDays === 1;
    }

    function extractStoreId(link){
      const u = (link || "").trim();
      if(!u) return "";
      let m = u.match(/smartstore\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      m = u.match(/storefarm\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      return "";
    }

    async function getAccessToken(){
      const { data, error } = await sb.auth.getSession();
      if(error) return null;
      return data?.session?.access_token || null;
    }

    /***********************
     * 2) 상태(메모리)
     ***********************/
    const ROLE_LABEL = {
      "MASTER":"마스터","ADMIN":"관리자","ADVERTISER":"광고주","AGENCY":"대행사","DISTRIBUTOR":"총판사"
    };

    function isAdminLike(p){ return !!p && (p.role === "ADMIN" || p.role === "MASTER"); }
    function isMasterAccount(p){
      return !!p && (p.role === "MASTER" || p.is_master === true || p.login_id === MASTER_ID);
    }

    const PAGES = [
      { key:"dash",    label:"대시보드",   roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"slots",   label:"슬롯관리",   roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"assign",  label:"슬롯부여",   roles:["ADMIN","MASTER"] },
      { key:"users",   label:"사용자 관리", roles:["ADMIN","MASTER"] },
      { key:"cleanup", label:"슬롯 삭제",  roles:["ADMIN","MASTER"] },
      { key:"logs",    label:"로그",       roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
    ];
    let activePage = "dash";

    const editingSlotIds = new Set();
    const slotDrafts = new Map();
    const editingUserIds = new Set();
    const userDrafts = new Map();

    // ✅ 체크박스 선택 관리
    const selectedSlotIds = new Set();
    const selectedCleanupIds = new Set();

    // ✅ 연장 모달 관련
    let extendTargetId = null;
    let extendTargetIds = [];

    // ✅ 조합키워드 전역 메모리 저장소 (슬롯ID별로 저장)
    const keywordMemory = new Map();

    // ✅ localStorage에서 조합키워드 불러오기
    function loadKeywordMemory(){
      try {
        const saved = localStorage.getItem('slotKeywords');
        if(saved){
          const data = JSON.parse(saved);
          Object.keys(data).forEach(id => {
            keywordMemory.set(id, data[id]);
          });
        }
      } catch(e) {
        console.error('조합키워드 불러오기 실패:', e);
      }
    }

    // ✅ localStorage에 조합키워드 저장
    function saveKeywordMemory(){
      try {
        const data = {};
        keywordMemory.forEach((value, key) => {
          data[key] = value;
        });
        localStorage.setItem('slotKeywords', JSON.stringify(data));
      } catch(e) {
        console.error('조합키워드 저장 실패:', e);
      }
    }

    // 페이지 로드 시 조합키워드 복원
    loadKeywordMemory();

    const TYPE_DISPLAY_MAP = {
      "리워드(단일)": "스퀘어(단일)","리워드(원부)": "스퀘어(원부)",
      "리워드1": "스퀘어(단일)","리워드2": "스퀘어(원부)"
    };
    function typeDisplay(v){
      const t = (v || "").trim();
      return TYPE_DISPLAY_MAP[t] || t || "스퀘어(단일)";
    }
    function isTypeWonbu(typeVal){ return typeDisplay(typeVal).includes("원부"); }

    // ✅ 조합키워드 옵션
    const KEYWORD_OPTIONS = [
      { value: "Not applied", label: "Not applied[미적용]" },
      { value: "Attribute value", label: "Attribute value[속성값]" },
      { value: "Tag value", label: "Tag value[태그값]" },
      { value: "Suffix", label: "Suffix[접미사]" },
      { value: "Prefix", label: "Prefix[접두사]" },
      { value: "Review", label: "Review[리뷰키워드]" },
      { value: "Option", label: "Option[옵션키워드]" },
      { value: "Q&A keyword", label: "Q&A keyword[Q&A키워드]" }
    ];

    // ✅ 조합키워드별 색깔 매핑
    function getKeywordColor(value){
      const colorMap = {
        "Not applied": "gray",
        "Attribute value": "blue",
        "Tag value": "green",
        "Suffix": "purple",
        "Prefix": "orange",
        "Review": "gold",
        "Option": "red",
        "Q&A keyword": "cyan"
      };
      return colorMap[value] || "gray";
    }

    // 페이지 상태 저장/복원
    function savePageState(){
      localStorage.setItem('currentPage', activePage);
    }

    function loadPageState(){
      const saved = localStorage.getItem('currentPage');
      if(saved && PAGES.find(p => p.key === saved)){
        activePage = saved;
      }
    }

    let authUser = null;
    let profile = null;
    let usersCache = [];
    let slotsCache = [];

    const logArr = [];
    function logEvent(msg){
      logArr.unshift(`[${fmtDT(nowISO())}] ${msg}`);
      if(logArr.length > 400) logArr.pop();
    }

    /***********************
     * 3) DB 접근
     ***********************/
    async function fetchProfileFromTable(tableName){
      const { data, error } = await sb.from(tableName).select("*").eq("user_id", authUser.id).maybeSingle();
      return { data, error };
    }

    async function fetchMyProfile(){
      if(!authUser) return null;
      { const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_PRIMARY);
        if(!error) return data || null;
        console.warn("profiles load error:", error);
        toast("프로필 조회 실패", error.message || "profiles 조회 오류"); }
      { const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_FALLBACK);
        if(!error) { toast("호환 모드", "profiles 대신 app_users를 사용 중입니다."); return data || null; }
        console.warn("app_users load error:", error);
        toast("프로필 로드 실패", (error && error.message) ? error.message : "알 수 없는 오류");
        return null; }
    }

    async function fetchUsersIfAdmin(){
      if(!profile || !isAdminLike(profile)) { usersCache = [profile].filter(Boolean); return; }
      const { data, error } = await sb.from(PROFILE_TABLE_PRIMARY).select("*").order("created_at", { ascending: true });
      if(error){
        console.error(error); toast("사용자 목록 조회 실패", error.message);
        const { data: d2, error: e2 } = await sb.from(PROFILE_TABLE_FALLBACK).select("*").order("created_at", { ascending: true });
        if(!e2){ toast("호환 모드","사용자 목록을 app_users에서 불러옵니다."); usersCache = d2 || []; return; }
        usersCache = [profile].filter(Boolean); return;
      }
      usersCache = data || [];
    }

    async function fetchSlots(){
      const { data, error } = await sb.from("slots").select("*").order("no", { ascending: true });
      if(error){ console.error(error); toast("슬롯 조회 실패", error.message); slotsCache = []; return; }
      slotsCache = (data || []).map(normalizeSlotFromDb);
    }

    function normalizeSlotFromDb(r){
      return {
        id: r.id, no: r.no,
        userId: r.login_id || r.user_login_id || r.userId || r.user_id_login || r.user_login || r.userIdLogin || r.user_loginid || r.user_login_id || r.user_id,
        user_uid: r.user_id,
        type: r.type, startDate: r.start_date, endDate: r.end_date,
        opened: !!r.opened, saved: !!r.saved, hiddenByAdmin: !!r.hidden_by_admin,
        withdrawPending: !!r.withdraw_pending,
        keyword: r.keyword || "",
        keyword2: r.keyword2 || "Not applied",  // ✅ DB에서 불러오기
        keyword3: r.keyword3 || "Not applied",  // ✅ DB에서 불러오기
        link: r.link || "", catalogLink: r.catalog_link || "",
        memo: r.memo || "", storeId: r.store_id || "", expired: false, createdAt: r.created_at
      };
    }

    function computeExpired(s){
      const now = new Date();
      if(s.endDate){ const end = new Date(s.endDate + "T23:59:59"); return end < now; }
      return false;
    }

    function slotStateTag(s){
      const style = 'style="font-size:14px"';
      if(s.expired)         return `<span class="tag red" ${style}>만료</span>`;
      if(s.withdrawPending) return `<span class="tag gray" ${style}>철회 대기</span>`;
      if(s.hiddenByAdmin)   return `<span class="tag gray" ${style}>숨김</span>`;
      if(s.saved)           return `<span class="tag green" ${style}>정상</span>`;
      if(s.opened)          return `<span class="tag gold" ${style}>오픈됨</span>`;
      return `<span class="tag gray" ${style}>부여됨</span>`;
    }

    function storeIdTagHtml(s){
      const v = (s.storeId || "").trim();
      if(!v) return `<span class="muted">-</span>`;
      const cls = s.saved ? "green" : "gray";
      return `<span class="tag ${cls}" style="font-size:14px" title="${escapeHtml(v)}">${escapeHtml(v)}</span>`;
    }

    function ensureSlotDraft(slot){
      if(!slotDrafts.has(slot.id)){
        slotDrafts.set(slot.id, {
          kw: slot.keyword || "",
          kw2: slot.keyword2 || "Not applied",
          kw3: slot.keyword3 || "Not applied",
          link: slot.link || "",
          catalogLink: slot.catalogLink || "",
          memo: slot.memo || ""
        });
      }
      return slotDrafts.get(slot.id);
    }

    function renderLinkCellReadOnly(s){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){
        const url = s.link || "";
        if(!url) return `<span class="muted">-</span>`;
        const displayUrl = url.length > 35 ? url.substring(0, 35) + "..." : url;
        return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="colLink" style="color:var(--neon-text);text-decoration:none" title="${escapeHtml(url)}">${escapeHtml(displayUrl)}</a>`;
      }
      const a = s.link || "";
      const b = s.catalogLink || "";
      const displayA = a.length > 30 ? a.substring(0, 30) + "..." : a;
      const displayB = b.length > 30 ? b.substring(0, 30) + "..." : b;
      return `
        <div class="linkCell">
          <div><span class="k">상품</span>${a ? `<a href="${escapeHtml(a)}" target="_blank" rel="noopener noreferrer" class="v" style="color:var(--neon-text);text-decoration:none" title="${escapeHtml(a)}">${escapeHtml(displayA)}</a>` : `<span class="muted">-</span>`}</div>
          <div style="margin-top:5px"><span class="k">카탈로그</span>${b ? `<a href="${escapeHtml(b)}" target="_blank" rel="noopener noreferrer" class="v" style="color:var(--neon-text);text-decoration:none" title="${escapeHtml(b)}">${escapeHtml(displayB)}</a>` : `<span class="muted">-</span>`}</div>
        </div>
      `;
    }

    function renderLinkCellEditing(s, d){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){ return `<input class="tInput" style="min-width:220px" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="상품 링크" />`; }
      return `<div class="twoInputs">
        <input class="tInput" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="상품링크" />
        <input class="tInput" data-f="catalogLink" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.catalogLink)}" placeholder="카탈로그 링크" />
      </div>`;
    }

    /***********************
     * 4) 로그인/세션
     ***********************/
    async function login(){
      const raw = document.getElementById("loginId").value.trim();
      const pw = document.getElementById("loginPw").value.trim();
      if(!raw || !pw){ toast("입력 필요","아이디/비밀번호를 입력하세요."); return; }
      const email = toEmail(raw);
      logEvent(`로그인 시도: ${raw} → ${email}`);
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error){ console.error(error); toast("로그인 실패", error.message); return; }
      authUser = data.user;
      profile = await fetchMyProfile();
      if(!profile){
        logEvent(`프로필 로드 실패: uid=${authUser?.id || "-"}`);
        toast("프로필 없음/조회 실패", "Auth는 성공했지만 프로필을 불러오지 못했습니다.");
        await sb.auth.signOut(); authUser = null; return;
      }
      logEvent(`로그인: ${profile.login_id} (${profile.role}${isMasterAccount(profile) ? "/MASTER" : ""})`);
      await afterLoginBootstrap();
      activePage = "dash"; mount();
    }

    async function logout(){
      await sb.auth.signOut();
      authUser = null; profile = null; usersCache = []; slotsCache = [];
      activePage = "dash"; mount();
    }

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && document.getElementById("loginView").style.display!=="none"){ login(); }
    });

    async function afterLoginBootstrap(){
      await fetchUsersIfAdmin();
      await fetchSlots();
    }

    /***********************
     * 5) 화면 마운트/네비
     ***********************/
    function mount(){
      const isLoggedIn = !!profile;
      document.getElementById("loginView").style.display = isLoggedIn ? "none" : "grid";
      document.getElementById("appView").style.display = isLoggedIn ? "block" : "none";
      if(!isLoggedIn) return;

      // ✅ 저장된 페이지 복원
      loadPageState();

      const roleText = isMasterAccount(profile) ? "마스터 계정" : (ROLE_LABEL[profile.role] || profile.role);
      document.getElementById("whoText").textContent =
        `${profile.company_name ? profile.company_name + " " : ""}${profile.login_id} (${roleText})`;

      const nav = document.getElementById("navTabs");
      nav.innerHTML = "";
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      allowed.forEach(p=>{
        const b = document.createElement("button");
        b.className = "tab" + (p.key===activePage ? " active" : "");
        b.textContent = p.label;
        b.onclick = ()=>{ activePage = p.key; savePageState(); render(); };
        nav.appendChild(b);
      });

      const roleSel = document.getElementById("u_role");
      if(roleSel){
        const hasAdmin = [...roleSel.options].some(o=>o.value==="ADMIN");
        if(isMasterAccount(profile) && !hasAdmin){
          const opt = document.createElement("option");
          opt.value = "ADMIN"; opt.textContent = "관리자(ADMIN)";
          roleSel.appendChild(opt);
        }
      }
      render();
    }

    function showPage(key){
      for(const p of PAGES){
        const el = document.getElementById("page_"+p.key);
        if(el) el.style.display = (p.key===key) ? "grid" : "none";
      }
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      const nav = document.getElementById("navTabs");
      [...nav.children].forEach((node, idx)=>{ node.classList.toggle("active", allowed[idx]?.key === key); });
    }

    function render(){
      showPage(activePage);
      if(activePage==="dash")    renderDash();
      if(activePage==="slots")   renderSlotsPage();
      if(activePage==="assign")  renderAssign();
      if(activePage==="users")   renderUsers();
      if(activePage==="cleanup") renderCleanup();
      if(activePage==="logs")    renderLogs();
    }

    async function refresh(){
      if(!profile) return;
      await afterLoginBootstrap(); render(); toast("새로고침 완료");
    }

    /***********************
     * 6) 슬롯 표시/수정/관리
     ***********************/
    function visibleSlotsForUser(allSlots){
      const slots = allSlots.map(s=>({ ...s, expired: computeExpired(s) }));
      if(isAdminLike(profile)) return slots;
      return slots.filter(s =>
        (s.user_uid === authUser.id) && !s.hiddenByAdmin && !s.withdrawPending && (s.opened || s.saved)
      );
    }

    function renderSlotsPage(){
      // ✅ sessionStorage에서 slotDrafts 복원
      try {
        const saved = sessionStorage.getItem('slotDrafts');
        if(saved){
          const draftsObj = JSON.parse(saved);
          Object.keys(draftsObj).forEach(key => {
            slotDrafts.set(key, draftsObj[key]);
          });
          console.log('✅ Draft 복원됨:', slotDrafts.size, '개');
        }
      } catch(e) {
        console.error('Draft 복원 실패:', e);
      }
      
      // ✅ 현재 수정 중인 input 값들을 slotDrafts에 저장
      document.querySelectorAll('input[data-f], select[data-f]').forEach(inp => {
        const id = inp.getAttribute("data-id");
        const f = inp.getAttribute("data-f");
        if(id && f && slotDrafts.has(id)){
          const d = slotDrafts.get(id);
          if(f==="kw") d.kw = inp.value;
          if(f==="kw2") d.kw2 = inp.value;
          if(f==="kw3") d.kw3 = inp.value;
          if(f==="link") d.link = inp.value;
          if(f==="catalogLink") d.catalogLink = inp.value;
          if(f==="memo") d.memo = inp.value;
        }
      });
      
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const slots = visibleSlotsForUser(all);

      const uf = document.getElementById("slotUserFilter");
      if(isAdminLike(profile)){
        const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
        const current = uf.value || "ALL";
        uf.innerHTML = `<option value="ALL">전체</option>` +
          targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
        uf.value = current; uf.disabled = false;
      } else {
        uf.innerHTML = `<option value="${escapeHtml(authUser.id)}">${escapeHtml(profile.company_name ? `${profile.company_name}(${profile.login_id})` : profile.login_id)}</option>`;
        uf.value = authUser.id; uf.disabled = true;
      }

      const hint = document.getElementById("slotHint");
      hint.innerHTML = "";

      const q = (document.getElementById("slotSearch").value || "").trim().toLowerCase();
      const st = document.getElementById("slotFilter").value || "ALL";
      const ufi = document.getElementById("slotUserFilter").value || "ALL";

      let rows = [...slots];
      if(isAdminLike(profile) && ufi !== "ALL") rows = rows.filter(s => (s.user_uid === ufi));
      if(st !== "ALL"){
        if(st==="ALLOCATED") rows = rows.filter(s => !s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="OPENED")    rows = rows.filter(s => s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="SAVED")     rows = rows.filter(s => s.saved && !s.expired && !s.withdrawPending);
        if(st==="EXPIRING")  rows = rows.filter(s => !s.expired && isExpiringTomorrow(s.endDate));
        if(st==="EXPIRED")   rows = rows.filter(s => s.expired);
      }
      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          const uname = (isAdminLike(profile))
            ? (usersCache.find(u=>u.user_id===s.user_uid)?.company_name || "") + " " + (usersCache.find(u=>u.user_id===s.user_uid)?.login_id || "")
            : (profile.company_name||"") + " " + (profile.login_id||"");
          return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q) || uname.toLowerCase().includes(q);
        });
      }
      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      // ✅ 전체 슬롯에서의 순서 계산
      const allVisibleSlots = visibleSlotsForUser(all);
      const totalSlotMap = new Map();
      allVisibleSlots.forEach((slot, idx) => {
        totalSlotMap.set(slot.id, idx + 1);
      });

      // ✅ 일괄 작업 버튼 렌더링
      const bulkBar = document.getElementById("slotBulkBar");
      if(isAdminLike(profile)){
        const checkableSlots = rows.filter(s => !s.expired && !s.withdrawPending && (s.opened || s.saved));
        if(checkableSlots.length > 0){
          bulkBar.innerHTML = `
            <button class="btn mini" onclick="selectAllSlots()">전체선택</button>
            <button class="btn mini" onclick="invertSlotSelection()">반전</button>
            ${selectedSlotIds.size > 0 ? `
              <span class="tag gray" style="font-size:11px">${selectedSlotIds.size}개 선택됨</span>
              <button class="btn mini btnNeon" onclick="bulkExtendSlots()">선택 연장</button>
              <button class="btn mini btnRed" onclick="bulkWithdrawSlots()">선택 철회</button>
            ` : ''}
          `;
        } else {
          bulkBar.innerHTML = "";
        }
      } else {
        bulkBar.innerHTML = "";
      }

      const tb = document.getElementById("slotTbody");
      tb.innerHTML = "";

      // ✅ 표시 순서 번호
      let displayNumber = 1;

      for(const s of rows){
        const tr = document.createElement("tr");
        const canEdit = (!s.expired) && (!s.withdrawPending) &&
          (isAdminLike(profile) || s.user_uid === authUser.id) && (s.opened || s.saved);
        const isEditing = editingSlotIds.has(s.id);

        let manage = "";
        if(isAdminLike(profile)){
          const withdrawBtn = (!s.expired && !s.withdrawPending)
            ? `<button class="btn mini btnRed" data-act="withdraw" data-id="${escapeHtml(s.id)}">철회</button>` : "";
          const extendBtn = (!s.expired && !s.withdrawPending && s.opened && s.saved)
            ? `<button class="btn mini btnNeon" data-act="extend" data-id="${escapeHtml(s.id)}">연장</button>` : "";
          if(s.withdrawPending){ manage = `<span class="muted">철회 대기</span>`; }
          else if(s.hiddenByAdmin && !s.expired){
            manage = `<div style="display:flex;gap:4px;flex-wrap:nowrap"><button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">오픈</button>${extendBtn}${withdrawBtn}</div>`;
          } else if(!s.opened && !s.saved && !s.expired){
            manage = `<div style="display:flex;gap:4px;flex-wrap:nowrap"><button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">오픈</button>${extendBtn}${withdrawBtn}</div>`;
          } else if((s.opened || s.saved) && !s.expired){
            manage = `<div style="display:flex;gap:4px;flex-wrap:nowrap"><button class="btn mini" data-act="hide" data-id="${escapeHtml(s.id)}">숨김</button>${extendBtn}${withdrawBtn}</div>`;
          } else { manage = `<span class="muted">-</span>`; }
        } else {
          manage = s.expired ? `<span class="tag red">만료</span>` : `<span class="muted">-</span>`;
        }

        let editCell = `<span class="muted">-</span>`;
        if(canEdit){
          if(!isEditing){ editCell = `<button class="btn mini btnGreen" data-act="edit" data-id="${escapeHtml(s.id)}">수정</button>`; }
          else { editCell = `<div style="display:flex;gap:4px;flex-wrap:wrap"><button class="btn mini btnNeon" data-act="save" data-id="${escapeHtml(s.id)}">저장</button><button class="btn mini" data-act="cancel" data-id="${escapeHtml(s.id)}">취소</button></div>`; }
        }

        let kwCell, kw2Cell, kw3Cell, linkCell, memoCell;
        if(isEditing){
          const d = ensureSlotDraft(s);
          kwCell   = `<input class="tInput" data-f="kw"   data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.kw)}"   placeholder="메인키워드" />`;
          
          // 조합키워드1 select
          kw2Cell = `<select class="tInput" style="min-width:140px" data-f="kw2" data-id="${escapeHtml(s.id)}">
            ${KEYWORD_OPTIONS.map(opt => `<option value="${escapeHtml(opt.value)}" ${d.kw2===opt.value?"selected":""}>${escapeHtml(opt.label)}</option>`).join("")}
          </select>`;
          
          // 조합키워드2 select
          kw3Cell = `<select class="tInput" style="min-width:140px" data-f="kw3" data-id="${escapeHtml(s.id)}">
            ${KEYWORD_OPTIONS.map(opt => `<option value="${escapeHtml(opt.value)}" ${d.kw3===opt.value?"selected":""}>${escapeHtml(opt.label)}</option>`).join("")}
          </select>`;
          
          linkCell = renderLinkCellEditing(s, d);
          memoCell = `<input class="tInput" data-f="memo" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.memo)}" placeholder="메모" />`;
        } else {
          kwCell   = `${escapeHtml(s.keyword||"")}`;
          
          // ✅ 조합키워드 표시 (값별 색깔 + / 접두사)
          const kw2Display = s.keyword2 ? `/${s.keyword2}` : "";
          const kw3Display = s.keyword3 ? `/${s.keyword3}` : "";
          
          const kw2Color = getKeywordColor(s.keyword2);
          const kw3Color = getKeywordColor(s.keyword3);
          
          kw2Cell = kw2Display ? `<span class="tag ${kw2Color}" style="font-size:13px;padding:5px 10px;font-family:'DM Mono',monospace">${escapeHtml(kw2Display)}</span>` : `<span class="muted">-</span>`;
          kw3Cell = kw3Display ? `<span class="tag ${kw3Color}" style="font-size:13px;padding:5px 10px;font-family:'DM Mono',monospace">${escapeHtml(kw3Display)}</span>` : `<span class="muted">-</span>`;
          
          linkCell = renderLinkCellReadOnly(s);
          memoCell = `${escapeHtml(s.memo||"")}`;
        }

        const expSoon = isExpiringTomorrow(s.endDate);
        
        // ✅ 사용자 정보 분리
        const userObj = isAdminLike(profile) 
          ? usersCache.find(u=>u.user_id===s.user_uid) 
          : profile;
        const companyName = userObj?.company_name || "";
        const loginId = userObj?.login_id || "-";
        
        // ✅ 번호 2줄 (화면순서 / 전체순서)
        const totalNum = totalSlotMap.get(s.id) || "-";
        const numberCell = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px">
            <div style="font-family:'DM Mono',monospace;font-size:14px;color:var(--text);font-weight:700">${displayNumber}</div>
            <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">(${totalNum})</div>
          </div>
        `;

        // ✅ 사용자 2줄
        const userCell = companyName
          ? `<div style="font-weight:700;font-size:14px;line-height:1.4">${escapeHtml(companyName)}</div><div style="font-size:12px;color:var(--muted);line-height:1.4">(${escapeHtml(loginId)})</div>`
          : `<div style="font-weight:700;font-size:14px;line-height:1.4">${escapeHtml(loginId)}</div>`;

        // ✅ 체크박스 추가
        const canCheck = isAdminLike(profile) && !s.expired && !s.withdrawPending && (s.opened || s.saved);
        const checkCell = canCheck 
          ? `<input type="checkbox" class="chk" data-slot-id="${escapeHtml(s.id)}" ${selectedSlotIds.has(s.id) ? "checked" : ""} />`
          : `<span class="muted">-</span>`;

        tr.innerHTML = `
          <td>${checkCell}</td>
          <td>${numberCell}</td>
          <td>${userCell}</td>
          <td><span class="tag gold typeTag" style="font-size:13px">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td style="font-family:'DM Mono',monospace;font-size:13px">${escapeHtml(s.startDate||"-")}</td>
          <td style="font-family:'DM Mono',monospace;font-size:13px" class="${expSoon ? "expSoon" : ""}">${escapeHtml(s.endDate||"-")}</td>
          <td>${slotStateTag(s)}</td>
          <td>${editCell}</td>
          <td style="font-size:14px">${kwCell}</td>
          <td>${kw2Cell}</td>
          <td>${kw3Cell}</td>
          <td>${linkCell}</td>
          <td style="font-size:13px">${memoCell}</td>
          <td>${manage}</td>
        `;
        tb.appendChild(tr);
        displayNumber++; // 표시 번호 증가
      }

      // ✅ 체크박스 이벤트
      tb.querySelectorAll('.chk').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const sid = chk.getAttribute("data-slot-id");
          if(chk.checked) selectedSlotIds.add(sid);
          else selectedSlotIds.delete(sid);
          renderSlotsPage();
        });
      });

      tb.querySelectorAll('input[data-f], select[data-f]').forEach(inp=>{
        const handler = ()=>{
          const id = inp.getAttribute("data-id");
          const f = inp.getAttribute("data-f");
          if(!slotDrafts.has(id)) slotDrafts.set(id, {kw:"",kw2:"",kw3:"",link:"",catalogLink:"",memo:""});
          const d = slotDrafts.get(id);
          if(f==="kw") d.kw = inp.value;
          if(f==="kw2") d.kw2 = inp.value;
          if(f==="kw3") d.kw3 = inp.value;
          if(f==="link") d.link = inp.value;
          if(f==="catalogLink") d.catalogLink = inp.value;
          if(f==="memo") d.memo = inp.value;
          
          // ✅ sessionStorage에도 저장
          try {
            const draftsObj = {};
            slotDrafts.forEach((value, key) => {
              draftsObj[key] = value;
            });
            sessionStorage.setItem('slotDrafts', JSON.stringify(draftsObj));
            console.log('✅ Draft 저장됨:', id, f, inp.value);
          } catch(e) {
            console.error('Draft 저장 실패:', e);
          }
        };
        inp.addEventListener("input", handler);
        inp.addEventListener("change", handler);
      });

      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          console.log(`버튼 클릭: ${act}, ID: ${id}`);
          
          try {
            if(act==="edit"){ editingSlotIds.add(id); const s = slotsCache.find(x=>x.id===id); if(s) ensureSlotDraft(s); renderSlotsPage(); toast("수정 모드","저장/취소 가능"); return; }
            if(act==="cancel"){ editingSlotIds.delete(id); slotDrafts.delete(id); renderSlotsPage(); return; }
            if(act==="save")    { 
              console.log('저장 함수 호출 시작!'); 
              await saveSlotInline(id); 
              console.log('저장 함수 호출 끝!');
              return; 
            }
            if(act==="open")    { openSlot(id); return; }
            if(act==="hide")    { hideSlot(id); return; }
            if(act==="withdraw"){ withdrawSlot(id); return; }
            if(act==="extend")  { extendSlotUI(id); return; }
          } catch(error) {
            console.error('❌ 버튼 핸들러 에러:', error);
            toast("오류 발생", error.message);
          }
        });
      });
    }

    async function saveSlotInline(id){
      console.log('🔵 saveSlotInline 시작, ID:', id);
      
      const s = slotsCache.find(x=>x.id===id);
      console.log('🔵 슬롯 찾기:', s ? '성공' : '실패');
      if(!s){ toast("슬롯을 찾을 수 없음"); return; }
      
      console.log('🔵 만료 체크:', computeExpired(s));
      if(computeExpired(s)){ toast("만료된 슬롯"); return; }
      
      console.log('🔵 철회 대기 체크:', s.withdrawPending);
      if(s.withdrawPending){ toast("철회 대기 슬롯"); return; }
      
      const d = slotDrafts.get(id) || { kw: s.keyword||"", kw2: "Not applied", kw3: "Not applied", link: s.link||"", catalogLink: s.catalogLink||"", memo: s.memo||"" };
      console.log('🔵 Draft 데이터:', d);
      
      const kw = (d.kw || "").trim();
      const kw2 = (d.kw2 || "Not applied").trim();
      const kw3 = (d.kw3 || "Not applied").trim();
      
      console.log('🔵 변수 할당 전 - d.link:', d.link);
      console.log('🔵 d.link 타입:', typeof d.link);
      console.log('🔵 d.link 길이:', d.link ? d.link.length : 'null/undefined');
      
      const link = (d.link || "").trim();
      const catalogLink = (d.catalogLink || "").trim();
      const memo = (d.memo || "").trim();
      
      console.log('🔵 변수 할당 후 - link:', link);
      console.log('🔵 link 타입:', typeof link);
      console.log('🔵 link 길이:', link.length);
      
      const wonbu = isTypeWonbu(s.type);
      
      console.log('🔵 필수값 체크 - kw:', kw, 'link:', link);
      if(!kw || !link){ 
        console.log('❌ 필수값 누락!'); 
        toast("저장 실패","메인키워드/상품링크는 필수입니다."); 
        return; 
      }
      if(wonbu && !catalogLink){ 
        console.log('❌ 원부 카탈로그 링크 누락!'); 
        toast("저장 실패","원부 타입은 카탈로그 링크도 필수입니다."); 
        return; 
      }
      
      console.log('🔵 필수값 체크 통과!');
      
      // ✅ DB 저장 (조합키워드 포함!)
      const payload = { 
        keyword: kw, 
        keyword2: kw2,
        keyword3: kw3,
        link, 
        catalog_link: wonbu ? catalogLink : "", 
        memo, 
        opened: true, 
        saved: true, 
        hidden_by_admin: false, 
        withdraw_pending: false 
      };
      console.log('🔵 DB 저장 시작, payload:', payload);
      
      let error;
      try {
        const result = await sb.from("slots").update(payload).eq("id", id);
        error = result.error;
      } catch(err) {
        console.error('❌ DB 저장 중 예외:', err);
        toast("저장 실패", err.message);
        return;
      }
      
      console.log('🔵 DB 저장 결과 - error:', error);
      if(error){ 
        console.error('❌ Supabase 에러:', error); 
        toast("저장 실패", error.message); 
        return; 
      }
      
      console.log('🔵 로그 이벤트');
      logEvent(`슬롯 저장: no=${s.no}, kw=${kw}, kw2=${kw2}, kw3=${kw3}`);
      
      console.log('🔵 토스트 표시');
      toast("저장 완료");
      
      console.log('🔵 정리 작업');
      editingSlotIds.delete(id); 
      slotDrafts.delete(id);
      
      console.log('🔵 슬롯 재로드');
      await fetchSlots();
      console.log('🔵 화면 렌더링');
      renderSlotsPage();
      if(activePage==="dash") renderDash();
      console.log('🔵 saveSlotInline 완료!');
    }

    async function openSlot(id){
      const { error } = await sb.from("slots").update({ hidden_by_admin:false, withdraw_pending:false, opened:true }).eq("id", id);
      if(error){ toast("오픈 실패", error.message); return; }
      logEvent(`슬롯 오픈: slot=${id}`); toast("오픈 완료","사용자 화면에 노출됩니다.");
      await fetchSlots(); renderSlotsPage();
    }

    async function hideSlot(id){
      const { error } = await sb.from("slots").update({ hidden_by_admin:true, opened:false }).eq("id", id);
      if(error){ toast("숨김 실패", error.message); return; }
      logEvent(`슬롯 숨김: slot=${id}`); toast("숨김 처리","관리자에게만 보이게 숨김");
      editingSlotIds.delete(id); slotDrafts.delete(id);
      await fetchSlots(); renderSlotsPage();
    }

    async function withdrawSlot(id){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("슬롯 없음"); return; }
      if(computeExpired(s)){ toast("만료된 슬롯"); return; }
      const ok = confirm(`철회 처리(철회 대기)로 변경할까요?\n\n번호: ${s.no}\n\n* 사용자 화면 숨김\n* '슬롯 삭제'에만 표시`);
      if(!ok) return;
      const { error } = await sb.from("slots").update({ withdraw_pending:true, hidden_by_admin:true, opened:false, saved:false }).eq("id", id);
      if(error){ toast("철회 실패", error.message); return; }
      logEvent(`슬롯 철회대기: no=${s.no}`); toast("철회 대기",`번호 ${s.no} → 슬롯 삭제 메뉴로 이동`);
      editingSlotIds.delete(id); slotDrafts.delete(id);
      await fetchSlots(); renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    function askExtendDays(defaultVal="7"){
      const v = prompt("연장할 일수를 입력하세요 (예: 7)", defaultVal);
      if(v===null) return null;
      const d = parseInt(String(v).trim(), 10);
      if(!d || d < 1) return null;
      return d;
    }

    async function extendSlotUI(id){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("슬롯 없음"); return; }
      if(!(s.opened && s.saved)){ toast("연장 불가","오픈+저장완료 슬롯만 연장됩니다."); return; }
      
      extendTargetId = id;
      extendTargetIds = [];
      document.getElementById("extendModal").classList.add("show");
    }

    function closeExtendModal(){
      document.getElementById("extendModal").classList.remove("show");
      extendTargetId = null;
      extendTargetIds = [];
    }

    async function confirmExtend(){
      const days = parseInt(document.getElementById("extendDaysInput").value, 10);
      
      if(extendTargetIds.length > 0){
        // 일괄 연장
        for(const id of extendTargetIds){
          const s = slotsCache.find(x=>x.id===id);
          if(!s || !s.endDate) continue;
          const newEnd = addDaysToDateStr(s.endDate, days);
          await sb.from("slots").update({ end_date: newEnd }).eq("id", id);
        }
        logEvent(`일괄 연장: ${extendTargetIds.length}개, +${days}일`);
        toast("일괄 연장 완료",`${extendTargetIds.length}개 슬롯 +${days}일`);
        selectedSlotIds.clear();
      } else if(extendTargetId){
        // 단일 연장
        const s = slotsCache.find(x=>x.id===extendTargetId);
        if(!s){ closeExtendModal(); return; }
        const newEnd = addDaysToDateStr(s.endDate, days);
        const { error } = await sb.from("slots").update({ end_date: newEnd }).eq("id", extendTargetId);
        if(error){ toast("연장 실패", error.message); closeExtendModal(); return; }
        logEvent(`연장: no=${s.no}, +${days}일`);
        toast("연장 완료",`번호 ${s.no} +${days}일`);
      }
      
      closeExtendModal();
      await fetchSlots(); renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    // ✅ 일괄 연장
    async function bulkExtendSlots(){
      if(!isAdminLike(profile) || selectedSlotIds.size === 0){ toast("선택된 슬롯 없음"); return; }
      
      extendTargetId = null;
      extendTargetIds = Array.from(selectedSlotIds);
      document.getElementById("extendModal").classList.add("show");
    }

    // ✅ 일괄 철회
    async function bulkWithdrawSlots(){
      if(!isAdminLike(profile) || selectedSlotIds.size === 0){ toast("선택된 슬롯 없음"); return; }
      const ok = confirm(`선택한 ${selectedSlotIds.size}개 슬롯을 철회 처리할까요?\n\n※ 사용자 화면 숨김\n※ '슬롯 삭제'에만 표시`);
      if(!ok) return;

      for(const id of selectedSlotIds){
        await sb.from("slots").update({
          withdraw_pending:true, hidden_by_admin:true, opened:false, saved:false
        }).eq("id", id);
      }

      logEvent(`일괄 철회: ${selectedSlotIds.size}개`);
      toast("일괄 철회 완료",`${selectedSlotIds.size}개 슬롯 → 슬롯 삭제로 이동`);
      selectedSlotIds.clear();
      await fetchSlots(); renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    // ✅ 전체선택 (슬롯관리)
    function selectAllSlots(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const slots = visibleSlotsForUser(all);
      const q = (document.getElementById("slotSearch").value || "").trim().toLowerCase();
      const st = document.getElementById("slotFilter").value || "ALL";
      const ufi = document.getElementById("slotUserFilter").value || "ALL";

      let rows = [...slots];
      if(isAdminLike(profile) && ufi !== "ALL") rows = rows.filter(s => (s.user_uid === ufi));
      if(st !== "ALL"){
        if(st==="ALLOCATED") rows = rows.filter(s => !s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="OPENED")    rows = rows.filter(s => s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="SAVED")     rows = rows.filter(s => s.saved && !s.expired && !s.withdrawPending);
        if(st==="EXPIRED")   rows = rows.filter(s => s.expired);
      }
      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          const uname = (isAdminLike(profile))
            ? (usersCache.find(u=>u.user_id===s.user_uid)?.company_name || "") + " " + (usersCache.find(u=>u.user_id===s.user_uid)?.login_id || "")
            : (profile.company_name||"") + " " + (profile.login_id||"");
          return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q) || uname.toLowerCase().includes(q);
        });
      }

      const checkable = rows.filter(s => !s.expired && !s.withdrawPending && (s.opened || s.saved));
      checkable.forEach(s => selectedSlotIds.add(s.id));
      renderSlotsPage();
      toast("전체 선택", `${checkable.length}개 슬롯 선택됨`);
    }

    // ✅ 반전선택 (슬롯관리)
    function invertSlotSelection(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const slots = visibleSlotsForUser(all);
      const q = (document.getElementById("slotSearch").value || "").trim().toLowerCase();
      const st = document.getElementById("slotFilter").value || "ALL";
      const ufi = document.getElementById("slotUserFilter").value || "ALL";

      let rows = [...slots];
      if(isAdminLike(profile) && ufi !== "ALL") rows = rows.filter(s => (s.user_uid === ufi));
      if(st !== "ALL"){
        if(st==="ALLOCATED") rows = rows.filter(s => !s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="OPENED")    rows = rows.filter(s => s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="SAVED")     rows = rows.filter(s => s.saved && !s.expired && !s.withdrawPending);
        if(st==="EXPIRED")   rows = rows.filter(s => s.expired);
      }
      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          const uname = (isAdminLike(profile))
            ? (usersCache.find(u=>u.user_id===s.user_uid)?.company_name || "") + " " + (usersCache.find(u=>u.user_id===s.user_uid)?.login_id || "")
            : (profile.company_name||"") + " " + (profile.login_id||"");
          return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q) || uname.toLowerCase().includes(q);
        });
      }

      const checkable = rows.filter(s => !s.expired && !s.withdrawPending && (s.opened || s.saved));
      checkable.forEach(s => {
        if(selectedSlotIds.has(s.id)) selectedSlotIds.delete(s.id);
        else selectedSlotIds.add(s.id);
      });
      renderSlotsPage();
      toast("반전 선택", `${selectedSlotIds.size}개 슬롯 선택됨`);
    }

    /***********************
     * 7) 슬롯부여
     ***********************/
    function syncAssignEndFromStart(){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, 10);
    }

    function renderAssign(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }
      const sel = document.getElementById("assign_user");
      const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
      sel.innerHTML = targets.length
        ? targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)} (${ROLE_LABEL[u.role]||u.role})</option>`).join("")
        : `<option value="">(사용자 계정이 없습니다)</option>`;
      sel.disabled = targets.length===0;
      const st = document.getElementById("assign_start"), en = document.getElementById("assign_end");
      if(!st.value){ const d = new Date(); d.setDate(d.getDate()+1); st.value = d.toISOString().slice(0,10); }
      if(!en.value){ en.value = addDaysToDateStr(st.value, 10); }
    }

    function quickDays(n){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, n);
    }

    async function allocateSlots(){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      const uid = document.getElementById("assign_user").value;
      const type = document.getElementById("assign_type").value || "스퀘어(단일)";
      const qty = parseInt(document.getElementById("assign_qty").value || "0", 10);
      const start = document.getElementById("assign_start").value;
      const end = document.getElementById("assign_end").value;
      if(!uid){ toast("사용자 선택 필요"); return; }
      if(!qty || qty<1){ toast("수량은 1 이상"); return; }
      if(!start || !end){ toast("기간 입력 필요"); return; }
      const maxNo = (slotsCache || []).reduce((m,s)=>Math.max(m, s.no||0), 0);
      const newRows = [];
      for(let i=0;i<qty;i++){
        newRows.push({ id: crypto.randomUUID(), no: maxNo+i+1, user_id: uid, type, start_date: start, end_date: end,
          opened: false, saved: false, hidden_by_admin: false, withdraw_pending: false,
          keyword:"", link:"", catalog_link:"", memo:"", store_id:"", created_at: nowISO() });
      }
      const { error } = await sb.from("slots").insert(newRows);
      if(error){ console.error(error); toast("슬롯부여 실패", error.message); return; }
      logEvent(`슬롯부여: user=${uid}, qty=${qty}, 타입=${type}, 기간=${start}~${end}`);
      toast("슬롯부여 완료",`총 ${qty}개 생성됨 (슬롯관리에서 '오픈' 필요)`);
      await fetchSlots(); activePage = "slots"; render();
    }

    /***********************
     * 8) 사용자 관리
     ***********************/
    async function createUser(){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      const login_id = document.getElementById("u_id").value.trim();
      const password = document.getElementById("u_pw").value.trim();
      const role = document.getElementById("u_role").value;
      const company_name = document.getElementById("u_company").value.trim();
      if(!login_id || login_id.length < 2){ toast("아이디를 입력하세요"); return; }
      if(!password || password.length < 2){ toast("비밀번호를 입력하세요"); return; }
      if(!company_name){ toast("업체명은 필수입니다"); return; }
      if(login_id === MASTER_ID){ toast("생성 불가","마스터 계정 아이디는 사용할 수 없습니다."); return; }
      if(role === "ADMIN" && !isMasterAccount(profile)){ toast("권한 없음","관리자(ADMIN) 계정 생성은 마스터 계정만 가능합니다."); return; }
      const body = { login_id, password, role, company_name, loginId: login_id, pw: password, companyName: company_name, isMaster: false };
      const token = await getAccessToken();
      if(!token){ toast("계정 생성 실패","세션 토큰이 없습니다. 다시 로그인 후 시도하세요."); return; }
      try{
        const res = await fetch(`${SUPABASE_URL}/functions/v1/${EDGE_CREATE_USER}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}`, "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok){ console.error("function error:", data); toast("계정 생성 실패", data.error || `status ${res.status}`); return; }
        if(data?.error){ console.error("function returned error:", data); toast("계정 생성 실패", data.error); return; }
        logEvent(`계정 생성: ${login_id} (${role}) 업체명=${company_name}`);
        toast("계정 생성 완료",`${company_name}(${login_id}) / ${ROLE_LABEL[role] || role}`);
        document.getElementById("u_id").value = ""; document.getElementById("u_pw").value = ""; document.getElementById("u_company").value = "";
        await fetchUsersIfAdmin(); await fetchSlots(); renderUsers(); renderAssign();
        if(activePage==="cleanup") renderCleanup();
      } catch(e){ console.error("invoke exception:", e); toast("계정 생성 실패","Failed to send a request to the Edge Function"); }
    }

    function ensureUserDraft(u){
      if(!userDrafts.has(u.user_id)){
        userDrafts.set(u.user_id, { loginNew: u.login_id, companyNew: u.company_name || "", roleNew: u.role || "ADVERTISER" });
      }
      return userDrafts.get(u.user_id);
    }

    async function saveUserInline(userId){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      const u = usersCache.find(x=>x.user_id===userId);
      if(!u){ toast("사용자를 찾을 수 없음"); return; }
      if(u.login_id === MASTER_ID){ toast("불가","마스터 계정은 수정 불가"); return; }
      const d = userDrafts.get(userId);
      if(!d){ toast("수정값 없음"); return; }
      const loginNew = (d.loginNew || "").trim(), companyNew = (d.companyNew || "").trim(), roleNew = (d.roleNew || "").trim();
      if(!loginNew || loginNew.length < 2){ toast("아이디 오류","2글자 이상"); return; }
      if(!companyNew){ toast("업체명 필수"); return; }
      if(!ROLE_LABEL[roleNew]){ toast("역할 오류"); return; }
      if(loginNew === MASTER_ID){ toast("불가","마스터 아이디는 사용 불가"); return; }
      if(roleNew === "ADMIN" && !isMasterAccount(profile)){ toast("권한 없음","관리자(ADMIN) 변경은 마스터만 가능"); return; }
      const { error } = await sb.from(PROFILE_TABLE_PRIMARY).update({ login_id: loginNew, company_name: companyNew, role: roleNew }).eq("user_id", userId);
      if(error){ console.error(error); toast("수정 실패", error.message); return; }
      logEvent(`계정 수정: ${u.login_id} → ${loginNew}`); toast("수정 저장 완료",`${companyNew}(${loginNew})`);
      editingUserIds.delete(userId); userDrafts.delete(userId);
      await fetchUsersIfAdmin(); renderUsers(); renderAssign();
      if(activePage==="dash") renderDash();
      if(activePage==="slots") await refresh();
    }

    async function deleteUser(userId){
      if(!isAdminLike(profile)){ toast("권한 없음"); return; }
      if(!isMasterAccount(profile)){ toast("권한 없음","삭제는 마스터 계정만 가능합니다."); return; }
      const u = usersCache.find(x=>x.user_id===userId);
      const who = u ? `${u.company_name||""}(${u.login_id})` : userId;
      const ok = confirm(`정말 삭제할까요?\n\n${who}\n\n※ profiles + Auth 계정이 함께 삭제됩니다. (복구 불가)`);
      if(!ok) return;
      const token = await getAccessToken();
      if(!token){ toast("삭제 실패","세션 토큰이 없습니다. 다시 로그인 후 시도하세요."); return; }
      try{
        const res = await fetch(`${SUPABASE_URL}/functions/v1/${EDGE_DELETE_USER}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}`, "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok){ console.error("delete function error:", data); toast("삭제 실패", data.error || `status ${res.status}`); return; }
        if(data?.error){ console.error("delete function returned error:", data); toast("삭제 실패", data.error); return; }
        toast("삭제 완료", who); logEvent(`계정 삭제: ${who}`);
        await fetchUsersIfAdmin(); await fetchSlots(); renderUsers(); renderAssign();
        if(activePage==="dash") renderDash();
        if(activePage==="slots") renderSlotsPage();
        if(activePage==="cleanup") renderCleanup();
      } catch(e){ console.error("delete invoke exception:", e); toast("삭제 실패","Failed to send a request to the Edge Function"); }
    }

    function renderUsers(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }
      const tb = document.getElementById("userTbody");
      const users = usersCache.filter(u => !(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
      tb.innerHTML = "";
      
      // 역할별 색깔 매핑
      const roleColorMap = {
        "ADMIN": "blue",
        "MASTER": "purple",
        "ADVERTISER": "green",
        "AGENCY": "orange",
        "DISTRIBUTOR": "gold"
      };
      
      users.forEach(u=>{
        const tr = document.createElement("tr");
        const isEditing = editingUserIds.has(u.user_id);
        const roleColor = roleColorMap[u.role] || "gray";
        
        if(!isEditing){
          tr.innerHTML = `
            <td style="font-weight:700;font-size:13px">${escapeHtml(u.login_id)}</td>
            <td><span class="tag ${roleColor}">${escapeHtml(ROLE_LABEL[u.role] || u.role)}</span></td>
            <td class="muted">${escapeHtml(u.company_name||"")}</td>
            <td class="muted">-</td>
            <td><button class="btn mini btnGreen" data-uact="edit" data-uid="${escapeHtml(u.user_id)}">수정</button></td>
            <td><button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}">삭제</button></td>
          `;
        } else {
          const d = ensureUserDraft(u);
          const canSeeAdminOpt = isMasterAccount(profile);
          tr.innerHTML = `
            <td><input class="tInput" data-uf="loginNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.loginNew)}" placeholder="아이디" /></td>
            <td>
              <select class="tInput" style="min-width:150px" data-uf="roleNew" data-uid="${escapeHtml(u.user_id)}">
                <option value="ADVERTISER" ${d.roleNew==="ADVERTISER"?"selected":""}>광고주</option>
                <option value="AGENCY" ${d.roleNew==="AGENCY"?"selected":""}>대행사</option>
                <option value="DISTRIBUTOR" ${d.roleNew==="DISTRIBUTOR"?"selected":""}>총판사</option>
                ${canSeeAdminOpt ? `<option value="ADMIN" ${d.roleNew==="ADMIN"?"selected":""}>관리자(ADMIN)</option>` : ""}
              </select>
            </td>
            <td><input class="tInput" data-uf="companyNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.companyNew)}" placeholder="업체명" /></td>
            <td class="muted">-</td>
            <td>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-uact="save" data-uid="${escapeHtml(u.user_id)}">저장</button>
                <button class="btn mini" data-uact="cancel" data-uid="${escapeHtml(u.user_id)}">취소</button>
              </div>
            </td>
            <td><button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}">삭제</button></td>
          `;
        }
        tb.appendChild(tr);
      });

      tb.querySelectorAll('[data-uf]').forEach(el=>{
        const uid = el.getAttribute("data-uid"), f = el.getAttribute("data-uf");
        const handler = ()=>{
          if(!userDrafts.has(uid)) userDrafts.set(uid, {loginNew:"",companyNew:"",roleNew:"ADVERTISER"});
          const d = userDrafts.get(uid);
          if(f==="loginNew") d.loginNew = el.value;
          if(f==="companyNew") d.companyNew = el.value;
          if(f==="roleNew") d.roleNew = el.value;
        };
        el.addEventListener("input", handler); el.addEventListener("change", handler);
      });

      tb.querySelectorAll("button[data-uact]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-uact"), uid = btn.getAttribute("data-uid");
          if(act==="edit"){ editingUserIds.add(uid); const u = usersCache.find(x=>x.user_id===uid); if(u) ensureUserDraft(u); renderUsers(); toast("사용자 수정모드","아이디/업체명/역할 수정"); return; }
          if(act==="cancel"){ editingUserIds.delete(uid); userDrafts.delete(uid); renderUsers(); return; }
          if(act==="save"){ saveUserInline(uid); return; }
        });
      });

      tb.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{ deleteUser(btn.getAttribute("data-del")); });
      });
    }

    /***********************
     * 9) Cleanup / Dash / Logs
     ***********************/
    function renderCleanup(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }
      const slots = slotsCache.map(s=>({ ...s, expired: computeExpired(s) })).filter(s=>!!s.withdrawPending);
      const cleanUser = document.getElementById("cleanUser");
      const users = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
      const prev = cleanUser.value || "ALL";
      cleanUser.innerHTML = `<option value="ALL">전체</option>` +
        users.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
      cleanUser.value = prev;
      const q = (document.getElementById("cleanSearch").value || "").trim().toLowerCase();
      const ufi = cleanUser.value || "ALL";
      let rows = [...slots];
      if(ufi !== "ALL") rows = rows.filter(s=>s.user_uid===ufi);
      if(q){ rows = rows.filter(s => { const storeId = (s.storeId||"").toLowerCase(), linkAll = ((s.link||"")+" "+(s.catalogLink||"")).toLowerCase();
        return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) || linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q); }); }
      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      // ✅ 일괄 삭제 버튼
      const bulkBar = document.getElementById("cleanupBulkBar");
      if(rows.length > 0){
        bulkBar.innerHTML = `
          <button class="btn mini" onclick="selectAllCleanup()">전체선택</button>
          <button class="btn mini" onclick="invertCleanupSelection()">반전</button>
          ${selectedCleanupIds.size > 0 ? `
            <span class="tag gray" style="font-size:11px">${selectedCleanupIds.size}개 선택됨</span>
            <button class="btn mini btnRed" onclick="bulkDeleteCleanup()">선택 삭제</button>
          ` : ''}
        `;
      } else {
        bulkBar.innerHTML = "";
      }

      const tb = document.getElementById("cleanTbody");
      tb.innerHTML = "";
      rows.forEach(s=>{
        const who = usersCache.find(u=>u.user_id===s.user_uid);
        const whoText = who ? ((who.company_name||"") ? `${who.company_name}(${who.login_id})` : who.login_id) : "-";
        const tr = document.createElement("tr");

        const checkCell = `<input type="checkbox" class="chk chk-cleanup" data-slot-id="${escapeHtml(s.id)}" ${selectedCleanupIds.has(s.id) ? "checked" : ""} />`;

        tr.innerHTML = `
          <td>${checkCell}</td>
          <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${escapeHtml(String(s.no||"-"))}</td>
          <td style="font-weight:700;font-size:12px">${escapeHtml(whoText)}</td>
          <td><span class="tag gold typeTag">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td>${slotStateTag(s)}</td>
          <td>${escapeHtml(s.keyword||"")}</td>
          <td>${renderLinkCellReadOnly(s)}</td>
          <td>${escapeHtml(s.memo||"")}</td>
          <td><button class="btn mini btnRed" data-del-slot="${escapeHtml(s.id)}">삭제</button></td>
        `;
        tb.appendChild(tr);
      });

      // ✅ 체크박스 이벤트
      tb.querySelectorAll('.chk-cleanup').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const sid = chk.getAttribute("data-slot-id");
          if(chk.checked) selectedCleanupIds.add(sid);
          else selectedCleanupIds.delete(sid);
          renderCleanup();
        });
      });

      tb.querySelectorAll("button[data-del-slot]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del-slot");
          const ok = confirm("이 슬롯을 완전 삭제할까요? (복구 불가)");
          if(!ok) return;
          const { error } = await sb.from("slots").delete().eq("id", id);
          if(error){ toast("삭제 실패", error.message); return; }
          logEvent(`슬롯 완전삭제: slot=${id}`); toast("삭제 완료");
          selectedCleanupIds.delete(id);
          await fetchSlots(); renderCleanup();
          if(activePage==="dash") renderDash();
        });
      });
    }

    // ✅ 일괄 완전 삭제
    async function bulkDeleteCleanup(){
      if(!isAdminLike(profile) || selectedCleanupIds.size === 0){ toast("선택된 슬롯 없음"); return; }
      const ok = confirm(`선택한 ${selectedCleanupIds.size}개 슬롯을 완전 삭제할까요?\n\n※ 복구 불가`);
      if(!ok) return;

      for(const id of selectedCleanupIds){
        await sb.from("slots").delete().eq("id", id);
      }

      logEvent(`일괄 완전삭제: ${selectedCleanupIds.size}개`);
      toast("일괄 삭제 완료",`${selectedCleanupIds.size}개 슬롯 삭제됨`);
      selectedCleanupIds.clear();
      await fetchSlots(); renderCleanup();
      if(activePage==="dash") renderDash();
    }

    // ✅ 전체선택 (슬롯 삭제)
    function selectAllCleanup(){
      const slots = slotsCache.map(s=>({ ...s, expired: computeExpired(s) })).filter(s=>!!s.withdrawPending);
      const q = (document.getElementById("cleanSearch").value || "").trim().toLowerCase();
      const ufi = document.getElementById("cleanUser").value || "ALL";

      let rows = [...slots];
      if(ufi !== "ALL") rows = rows.filter(s=>s.user_uid===ufi);
      if(q){ rows = rows.filter(s => { const storeId = (s.storeId||"").toLowerCase(), linkAll = ((s.link||"")+" "+(s.catalogLink||"")).toLowerCase();
        return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) || linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q); }); }

      rows.forEach(s => selectedCleanupIds.add(s.id));
      renderCleanup();
      toast("전체 선택", `${rows.length}개 슬롯 선택됨`);
    }

    // ✅ 반전선택 (슬롯 삭제)
    function invertCleanupSelection(){
      const slots = slotsCache.map(s=>({ ...s, expired: computeExpired(s) })).filter(s=>!!s.withdrawPending);
      const q = (document.getElementById("cleanSearch").value || "").trim().toLowerCase();
      const ufi = document.getElementById("cleanUser").value || "ALL";

      let rows = [...slots];
      if(ufi !== "ALL") rows = rows.filter(s=>s.user_uid===ufi);
      if(q){ rows = rows.filter(s => { const storeId = (s.storeId||"").toLowerCase(), linkAll = ((s.link||"")+" "+(s.catalogLink||"")).toLowerCase();
        return (String(s.no||"").includes(q)) || (s.keyword||"").toLowerCase().includes(q) || linkAll.includes(q) || (s.memo||"").toLowerCase().includes(q) || storeId.includes(q); }); }

      rows.forEach(s => {
        if(selectedCleanupIds.has(s.id)) selectedCleanupIds.delete(s.id);
        else selectedCleanupIds.add(s.id);
      });
      renderCleanup();
      toast("반전 선택", `${selectedCleanupIds.size}개 슬롯 선택됨`);
    }

    function renderDash(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const visible = visibleSlotsForUser(all);
      const opened = visible.filter(s=>s.opened && !s.expired).length;
      const saved = visible.filter(s=>s.saved && !s.expired).length;
      const expired = visible.filter(s=>s.expired).length;
      const expiring = all.filter(s=>!s.expired && isExpiringTomorrow(s.endDate)).length;
      
      const kpi = document.getElementById("kpi");
      kpi.innerHTML = "";
      const items = (isAdminLike(profile))
        ? [
            { v: String(all.length), k: "전체", clickable: true, action: ()=>{ activePage="slots"; document.getElementById("slotFilter").value="ALL"; render(); } },
            { v: String(all.filter(s=>s.withdrawPending).length), k: "철회 대기" },
            { v: String(expiring), k: "만료 예정", clickable: true, action: ()=>{ activePage="slots"; document.getElementById("slotFilter").value="EXPIRING"; render(); } },
            { v: String(all.filter(s=>s.saved && !s.expired).length), k: "정상" },
          ]
        : [
            { v: String(visible.length), k: "전체", clickable: true, action: ()=>{ activePage="slots"; document.getElementById("slotFilter").value="ALL"; render(); } },
            { v: String(opened), k: "오픈됨" },
            { v: String(saved), k: "정상" },
            { v: String(expired), k: "만료" },
          ];
      items.forEach(it=>{
        const d = document.createElement("div");
        d.className = "box" + (it.clickable ? " clickable" : "");
        d.innerHTML = `<div class="v">${escapeHtml(it.v)}</div><div class="k">${escapeHtml(it.k)}</div>`;
        if(it.action) d.onclick = it.action;
        kpi.appendChild(d);
      });
    }

    function renderLogs(){
      const box = document.getElementById("logBox");
      box.textContent = logArr.length ? logArr.join("\n") : "로그가 없습니다.";
    }

    /***********************
     * 10) 초기 세션 복구
     ***********************/
    (async function init(){
      const { data } = await sb.auth.getSession();
      authUser = data?.session?.user || null;
      if(authUser){
        profile = await fetchMyProfile();
        if(profile){ await afterLoginBootstrap(); logEvent(`세션 복구: ${profile.login_id}`); }
        else { await sb.auth.signOut(); authUser = null; profile = null; }
      }
      sb.auth.onAuthStateChange(async (event, session) => {
        authUser = session?.user || null;
        if(!authUser){ profile = null; usersCache = []; slotsCache = []; activePage = "dash"; mount(); return; }
        profile = await fetchMyProfile();
        if(profile){ await afterLoginBootstrap(); mount(); }
      });
      mount();
    })();
  </script>
</body>
</html>
