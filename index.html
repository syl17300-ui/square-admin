<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Square | Admin Console</title>

  <style>
    :root{
      --bg:#070b18;
      --panel:#101428;
      --panel2:#151a33;
      --border:#2a2f55;
      --text:#eef2ff;
      --muted:#a7b0d6;

      /* í¬ì¸íŠ¸ */
      --neon:#49b6ff;
      --neon2:#7ee3ff;

      --gold:#d4af37;
      --gold2:#f3d77a;
      --green:#39d98a;
      --red:#ff5c5c;
      --gray:#8f93a8;

      --shadow: 0 12px 34px rgba(0,0,0,.42);
      --radius: 18px;
      --radius2: 14px;
      --focus: 0 0 0 4px rgba(73,182,255,.22);

      /* âœ… ë°°ê²½ ì´ë¯¸ì§€ (ì›í•˜ë©´ íŒŒì¼ëª…ë§Œ ë°”ê¾¸ê¸°) */
      --bgImg: url('chip-bg.png');
    }

    *{box-sizing:border-box}

    /* âœ… ë ‰ ë°©ì§€: ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜/íŠ¸ëœì§€ì…˜ ê°•ì œ OFF */
    *, *::before, *::after{
      animation: none !important;
      transition: none !important;
    }

    html{
      height:100%;
      min-height:100%;
      background: var(--bg);
    }

    body{
      margin:0;
      min-height:100vh;
      font-family:
        "Pretendard Variable","Pretendard","SUIT","Inter",
        ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        "Apple SD Gothic Neo","Noto Sans KR", sans-serif;

      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(73,182,255,.12), transparent 60%),
        radial-gradient(900px 520px at 85% 30%, rgba(126,227,255,.10), transparent 55%),
        radial-gradient(900px 520px at 50% 120%, rgba(73,182,255,.07), transparent 60%),

        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(rgba(73,182,255,.030) 1px, transparent 1px),
        linear-gradient(90deg, rgba(73,182,255,.030) 1px, transparent 1px),

        linear-gradient(rgba(6,9,22,.86), rgba(6,9,22,.86)),
        var(--bgImg);

      background-size:
        auto, auto, auto,
        64px 64px,
        64px 64px,
        16px 16px,
        16px 16px,
        auto,
        cover;

      background-position:
        center, center, center,
        0 0, 0 0,
        0 0, 0 0,
        center,
        center;

      background-repeat:
        no-repeat, no-repeat, no-repeat,
        repeat, repeat,
        repeat, repeat,
        no-repeat,
        no-repeat;

      color:var(--text);
      letter-spacing:-.2px;
      overflow-x:hidden;
    }

    a{color:inherit;text-decoration:none}

    .wrap{max-width:1440px;margin:0 auto;padding:24px}

    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(6,9,22,.66);
      border-bottom: 1px solid rgba(42,47,85,.75);
    }
    .topbar-inner{
      max-width:1440px;margin:0 auto;
      padding:16px 24px;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
    }

    .brand{
      display:flex;align-items:center;gap:12px;
      font-weight:1000;letter-spacing:.25px;
      white-space:nowrap;
    }
    .logoMark{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(73,182,255,.95), rgba(126,227,255,.9));
      box-shadow: 0 12px 28px rgba(73,182,255,.18);
      position:relative;
      flex:0 0 auto;
      overflow:hidden;
    }
    .logoMark:before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 55%),
        radial-gradient(22px 22px at 70% 70%, rgba(0,0,0,.18), transparent 60%);
      mix-blend-mode: overlay;
      opacity:.9;
    }
    .logoMark:after{
      content:"S";
      position:absolute;inset:0;
      display:grid;place-items:center;
      color:#081024;font-weight:1200;
      font-size:18px;
      letter-spacing:.2px;
      text-shadow: 0 1px 0 rgba(255,255,255,.15);
    }

    .brandTitle{display:flex;flex-direction:column;line-height:1.05}
    .brandTitle .t1{font-size:16px;color:rgba(255,255,255,.92)}
    .brandTitle .t2{font-size:13px;color:var(--muted);font-weight:800}

    .userBox{
      display:flex;align-items:center;gap:10px;
      color:var(--muted);font-size:14px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(12,16,34,.70);
      font-weight:900;
    }
    .pill .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 5px rgba(57,217,138,.12);
    }

    .btn{
      border:1px solid rgba(42,47,85,.95);
      background: rgba(12,16,34,.74);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      font-size:15px;
      line-height:1;
      white-space:nowrap;
    }
    .btn:active{transform:none}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .btnNeon{
      background: linear-gradient(135deg, rgba(73,182,255,.95), rgba(126,227,255,.92));
      border: 1px solid rgba(73,182,255,.45);
      color:#061026;
      font-weight:1100;
      box-shadow: 0 10px 26px rgba(73,182,255,.18);
    }
    .btnRed{
      border:1px solid rgba(255,92,92,.35);
      background: rgba(255,92,92,.10);
      color: #ffd6d6;
    }
    .btnGreen{
      border:1px solid rgba(57,217,138,.35);
      background: rgba(57,217,138,.10);
      color: #d7fff0;
    }
    .mini{padding:10px 12px;border-radius:12px;font-size:14px}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .tab{
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(42,47,85,.88);
      background: rgba(12,16,34,.55);
      color: var(--muted);
      font-weight:1100;
      cursor:pointer;
      font-size:14px;
      white-space:nowrap;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(73,182,255,.60);
      box-shadow: 0 0 0 4px rgba(73,182,255,.12);
      background: rgba(12,16,34,.82);
    }

    .grid{display:grid;gap:16px}
    .card{
      border: 1px solid rgba(42,47,85,.92);
      border-radius: 18px;
      background: rgba(10,14,32,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHeader{
      padding:18px 18px 12px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom: 1px solid rgba(42,47,85,.65);
      background: rgba(8,12,28,.40);
    }
    .cardHeader .h{display:flex;flex-direction:column;gap:6px;min-width:260px}
    .cardHeader .h .title{
      font-size:20px;
      font-weight:1300;
      letter-spacing:.1px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 0 18px rgba(73,182,255,.16);
      white-space:nowrap;
    }
    .cardHeader .h .sub{
      font-size:14px;
      color:rgba(233,233,255,.90);
      font-weight:1100;
      white-space:nowrap;
    }
    .cardBody{padding:18px}

    .row{display:flex;gap:14px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    .label{font-size:13px;color:var(--muted);font-weight:1000;margin-bottom:9px;white-space:nowrap}
    .input, select, textarea{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:15px;
    }
    .input:focus, select:focus, textarea:focus{box-shadow: var(--focus); border-color: rgba(73,182,255,.55)}
    textarea{min-height:92px;resize:vertical}
    .hint{font-size:13px;color:var(--muted);margin-top:9px;line-height:1.6;font-weight:800}
    .hr{height:1px;background: rgba(42,47,85,.65); margin:16px 0}

    .rightActions{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      font-weight:1200;
      padding:14px 14px;
      border-bottom: 1px solid rgba(42,47,85,.78);
      background: rgba(8,12,28,.70);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space:nowrap;
    }
    tbody td{
      padding:14px 14px;
      border-bottom: 1px solid rgba(42,47,85,.55);
      vertical-align:middle;
      white-space:nowrap;
      font-weight:900;
    }
    tbody tr:hover{background: rgba(73,182,255,.06)}

    .tag{
      display:inline-flex;align-items:center;gap:9px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color: var(--text);
      font-weight:1200;
      white-space:nowrap;
      font-size:13px;
      line-height:1;
    }
    .tag.gold{border-color: rgba(73,182,255,.55); color: rgba(255,255,255,.94)}
    .tag.gray{border-color: rgba(143,147,168,.35); color: #cfd2e2}
    .tag.green{border-color: rgba(57,217,138,.35); color: #bfffe6}
    .tag.red{border-color: rgba(255,92,92,.35); color: #ffd6d6}

    .typeTag{font-weight:1400}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns: repeat(4, 1fr);gap:12px}
    @media (max-width:980px){
      .kpi{grid-template-columns: repeat(2,1fr)}
      .topbar-inner{flex-wrap:wrap;justify-content:center}
    }
    .kpi .box{
      border:1px solid rgba(42,47,85,.9);
      background: rgba(6,10,24,.55);
      border-radius: 14px;
      padding:16px;
    }
    .kpi .box .v{font-size:20px;font-weight:1200;color:var(--text);white-space:nowrap}
    .kpi .box .k{font-size:13px;color:var(--muted);font-weight:1000;margin-top:7px;white-space:nowrap}
    .foot{padding:14px 24px;color:var(--muted);font-size:12px;text-align:center;opacity:.9}

    .loginWrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .loginCard{
      width:min(520px, 96vw);
      border:1px solid rgba(42,47,85,.9);
      border-radius: 20px;
      background: rgba(10,14,32,.78);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .loginTop{
      padding:22px 20px 18px 20px;
      border-bottom: 1px solid rgba(42,47,85,.65);
      display:flex;align-items:center;gap:12px;
      background: rgba(8,12,28,.35);
    }
    .loginTop .t{display:flex;flex-direction:column;gap:4px}
    .loginTop .t .a{
      font-weight:1300;
      color:rgba(255,255,255,.95);
      font-size:28px;
      letter-spacing:.2px;
      white-space:nowrap;
      text-shadow: 0 0 18px rgba(73,182,255,.20);
    }
    .loginTop .t .b{display:none}
    .loginBody{padding:20px}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 100;
      padding: 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(42,47,85,.9);
      background: rgba(10,14,32,.92);
      box-shadow: var(--shadow);
      color: var(--text);
      font-weight:1000;
      display:none;
      max-width: 560px;
      backdrop-filter: blur(12px);
    }
    .toast.show{display:block}
    .toast .s{color:var(--muted);font-weight:900;font-size:13px;margin-top:7px;white-space:pre-wrap}

    .tableScroll{
      overflow:auto;
      max-height: 70vh;
      border-top:1px solid rgba(42,47,85,.65);
      margin-top:14px;
    }

    .tInput{
      width:100%;
      min-width: 220px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    .tInput:focus{box-shadow: var(--focus); border-color: rgba(73,182,255,.55)}

    .colLink{
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
      vertical-align:bottom;
    }

    .chk{
      width:18px;height:18px;
      accent-color: var(--neon);
      cursor:pointer;
      transform: translateY(2px);
    }
    .actionBar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }

    .expSoon{ color: var(--red) !important; font-weight:1400 !important; }

    .linkCell{ white-space:normal !important; line-height:1.35; font-weight:900; }
    .linkCell .k{color:var(--muted);font-weight:1000;font-size:12px;margin-right:6px}
    .linkCell .v{
      display:inline-block;
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:bottom;
      white-space:nowrap;
    }

    .twoInputs{ display:flex; flex-direction:column; gap:10px; min-width:240px; }
  </style>
</head>

<body>
  <div id="loginView" class="loginWrap" style="display:none">
    <div class="loginCard">
      <div class="loginTop">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="t">
          <div class="a">Square</div>
          <div class="b"></div>
        </div>
      </div>
      <div class="loginBody">
        <div class="row">
          <div class="field">
            <div class="label">ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼</div>
            <input id="loginId" class="input" placeholder="ì˜ˆ: syl17300 ë˜ëŠ” syl17300@square.local" autocomplete="username" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <div class="label">ë¹„ë°€ë²ˆí˜¸</div>
            <input id="loginPw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;align-items:center">
          <button class="btn btnNeon" onclick="login()">ë¡œê·¸ì¸</button>
        </div>
        <div class="hint" style="margin-top:10px">
          â€» ì•„ì´ë””ë§Œ ì…ë ¥í•´ë„ ìë™ìœ¼ë¡œ ì´ë©”ì¼ë¡œ ë³€í™˜ë˜ì–´ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <div id="appView" style="display:none">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logoMark" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="t1">ìŠ¤í€˜ì–´</div>
            <div class="t2">Square Admin Console</div>
          </div>
        </div>

        <div class="nav" id="navTabs"></div>

        <div class="userBox">
          <div class="pill">
            <div class="dot"></div>
            <span id="whoText">-</span>
          </div>
          <button class="btn mini" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div id="page_dash" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ëŒ€ì‹œë³´ë“œ</div>
              <div class="sub">ìŠ¬ë¡¯ ìš´ì˜ í˜„í™©</div>
            </div>
            <div class="rightActions">
              <button class="btn mini" onclick="refresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="kpi" id="kpi"></div>
          </div>
        </div>
      </div>

      <div id="page_slots" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ìŠ¬ë¡¯ê´€ë¦¬</div>
              <div class="sub">âœ… ì›ë¶€ íƒ€ì…ì€ ìƒí’ˆë§í¬ + ì¹´íƒˆë¡œê·¸ ë§í¬ 2ì¹¸</div>
            </div>

            <div class="rightActions">
              <div class="actionBar" id="slotBulkBar"></div>
              <button class="btn mini" onclick="refresh()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>

          <div class="cardBody" style="padding-bottom:0">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">ê²€ìƒ‰</div>
                <input id="slotSearch" class="input" placeholder="í‚¤ì›Œë“œ / ì‚¬ìš©ìID / ë§í¬ ì¼ë¶€ / ìŠ¤í† ì–´ID" oninput="renderSlotsPage()" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">í•„í„°</div>
                <select id="slotFilter" onchange="renderSlotsPage()">
                  <option value="ALL">ì „ì²´</option>
                  <option value="OPENED">ì˜¤í”ˆë¨</option>
                  <option value="SAVED">ì •ìƒ</option>
                  <option value="ALLOCATED">ë¶€ì—¬ë¨(ìˆ¨ê¹€)</option>
                  <option value="EXPIRED">ë§Œë£Œ</option>
                </select>
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">ì‚¬ìš©ì(ê´€ë¦¬ììš©)</div>
                <select id="slotUserFilter" onchange="renderSlotsPage()"></select>
              </div>
            </div>
            <div class="hint" id="slotHint"></div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <!-- âœ… ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ -->
                  <th style="width:52px">
                    <input id="slotSelectAll" class="chk" type="checkbox" title="ì „ì²´ ì„ íƒ" />
                  </th>
                  <th style="width:86px">ë²ˆí˜¸</th>
                  <th style="width:260px">ì‚¬ìš©ì</th>
                  <th style="width:120px">íƒ€ì…</th>
                  <th style="width:200px">ìŠ¤í† ì–´ID</th>
                  <th style="width:130px">ì‹œì‘ì¼</th>
                  <th style="width:130px">ë§Œë£Œì¼</th>
                  <th style="width:140px">ìƒíƒœ</th>
                  <th style="width:170px">ìˆ˜ì •</th>
                  <th>í‚¤ì›Œë“œ</th>
                  <th style="width:240px">ë§í¬</th>
                  <th>ë©”ëª¨</th>
                  <th style="width:320px">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="slotTbody"></tbody>
            </table>
          </div>

          <div class="cardBody">
            <div class="smallNote" style="display:none"></div>
          </div>
        </div>
      </div>

      <div id="page_assign" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ìŠ¬ë¡¯ë¶€ì—¬</div>
              <div class="sub">ê¸°ë³¸ ì‹œì‘ì¼: ë‚´ì¼</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">ê´€ë¦¬ì ì „ìš©</span>
            </div>
          </div>
          <div class="cardBody">
            <div class="row">
              <div class="field">
                <div class="label">ì‚¬ìš©ì(ê´‘ê³ ì£¼/ëŒ€í–‰ì‚¬/ì´íŒì‚¬ ID)</div>
                <select id="assign_user"></select>
              </div>
              <div class="field">
                <div class="label">ìŠ¬ë¡¯íƒ€ì…</div>
                <select id="assign_type">
                  <option value="ìŠ¤í€˜ì–´(ë‹¨ì¼)">ìŠ¤í€˜ì–´(ë‹¨ì¼)</option>
                  <option value="ìŠ¤í€˜ì–´(ì›ë¶€)">ìŠ¤í€˜ì–´(ì›ë¶€)</option>
                </select>
              </div>
              <div class="field" style="min-width:180px">
                <div class="label">ìˆ˜ëŸ‰</div>
                <input id="assign_qty" class="input" type="number" min="1" value="10" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="label">ì‹œì‘ì¼</div>
                <input id="assign_start" class="input" type="date" onchange="syncAssignEndFromStart()" />
              </div>
              <div class="field">
                <div class="label">ë§Œë£Œì¼</div>
                <input id="assign_end" class="input" type="date" />
              </div>
              <div class="field" style="min-width:360px;display:flex;align-items:flex-end;gap:10px;justify-content:flex-end">
                <button class="btn mini" onclick="quickDays(1)">+1ì¼</button>
                <button class="btn mini" onclick="quickDays(7)">+7ì¼</button>
                <button class="btn mini" onclick="quickDays(10)">+10ì¼</button>
                <button class="btn btnNeon" onclick="allocateSlots()">ìŠ¬ë¡¯ë¶€ì—¬</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page_users" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ì‚¬ìš©ì ê´€ë¦¬</div>
              <div class="sub">âœ… ë§ˆìŠ¤í„° ê³„ì •ì€ ê´€ë¦¬ì(ADMIN) ê³„ì •ë„ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">ê´€ë¦¬ì ì „ìš©</span>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">ì•„ì´ë””(ìš”ì²­ ì•„ì´ë””)</div>
                <input id="u_id" class="input" placeholder="ì˜ˆ: brother_topbiz" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">ë¹„ë°€ë²ˆí˜¸</div>
                <input id="u_pw" class="input" placeholder="ì˜ˆ: 1234" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">ì—­í• </div>
                <select id="u_role">
                  <option value="ADVERTISER">ê´‘ê³ ì£¼</option>
                  <option value="AGENCY">ëŒ€í–‰ì‚¬</option>
                  <option value="DISTRIBUTOR">ì´íŒì‚¬</option>
                </select>
              </div>
              <div class="field" style="min-width:320px">
                <div class="label">ì—…ì²´ëª…(í•„ìˆ˜)</div>
                <input id="u_company" class="input" placeholder="ì˜ˆ: ë¸Œë¼ë”íƒ‘ë¹„ì¦ˆ" />
              </div>
              <div class="field" style="min-width:220px;display:flex;align-items:flex-end;justify-content:flex-end">
                <button class="btn btnNeon" onclick="createUser()">ë“±ë¡í•˜ê¸°</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="tableScroll" style="max-height:55vh;margin-top:0">
              <table>
                <thead>
                  <tr>
                    <th style="width:260px">ì•„ì´ë””</th>
                    <th style="width:180px">ì—­í• </th>
                    <th>ì—…ì²´ëª…</th>
                    <th style="width:240px">ë¹„ë°€ë²ˆí˜¸</th>
                    <th style="width:220px">ìˆ˜ì •</th>
                    <th style="width:160px">ì‚­ì œ</th>
                  </tr>
                </thead>
                <tbody id="userTbody"></tbody>
              </table>
            </div>
            <div class="hint">â€» ì´ í˜ì´ì§€ëŠ” Supabase Auth + profiles í…Œì´ë¸” ê¸°ë°˜ì…ë‹ˆë‹¤. (í˜¸í™˜: app_users ìˆìœ¼ë©´ ìë™ fallback)</div>
          </div>
        </div>
      </div>

      <div id="page_cleanup" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ìŠ¬ë¡¯ ì‚­ì œ</div>
              <div class="sub">ì² íšŒ ëŒ€ê¸° ìŠ¬ë¡¯ë§Œ í‘œì‹œ</div>
            </div>

            <div class="rightActions">
              <button class="btn mini" onclick="renderCleanup()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">ê²€ìƒ‰</div>
                <input id="cleanSearch" class="input" placeholder="ì‚¬ìš©ìID / í‚¤ì›Œë“œ / ë§í¬ ì¼ë¶€ / ìŠ¤í† ì–´ID" oninput="renderCleanup()" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">ì‚¬ìš©ì</div>
                <select id="cleanUser" onchange="renderCleanup()"></select>
              </div>
            </div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">ë²ˆí˜¸</th>
                  <th style="width:260px">ì‚¬ìš©ì</th>
                  <th style="width:110px">íƒ€ì…</th>
                  <th style="width:200px">ìŠ¤í† ì–´ID</th>
                  <th style="width:130px">ìƒíƒœ</th>
                  <th>í‚¤ì›Œë“œ</th>
                  <th style="width:240px">ë§í¬</th>
                  <th>ë©”ëª¨</th>
                  <th style="width:150px">ì™„ì „ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="cleanTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="page_logs" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">ë¡œê·¸</div>
              <div class="sub">ìµœê·¼ ë™ì‘ ë¡œê·¸</div>
            </div>
          </div>
          <div class="cardBody">
            <div id="logBox" class="muted" style="font-weight:1000;line-height:1.75;white-space:pre-wrap"></div>
          </div>
        </div>
      </div>

      <div class="foot">Â© Square Admin Console (Supabase Auth + DB)</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- âœ… supabase-js (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * 0) Supabase ì—°ê²°ê°’
     ***********************/
    const SUPABASE_URL = "https://wavosfsnwwrcmcsgvlho.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhdm9zZnNud3dyY21jc2d2bGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjgwNjEsImV4cCI6MjA4NTkwNDA2MX0.5hh7b9u12aCDTuGtjQycVzBEkplnotDvLkmt5DmJ8eU";

    // âœ… ë¡œê·¸ì¸IDë¥¼ ì´ë©”ì¼ë¡œ ë§¤í•‘ (username@square.local)
    const EMAIL_DOMAIN = "square.local";

    // âœ… ë§ˆìŠ¤í„° ê³„ì • ê³ ì •
    const MASTER_ID = "syl17300";

    // âœ… í”„ë¡œí•„ í…Œì´ë¸” ê¸°ë³¸ê°’(ë©”ì¸)
    const PROFILE_TABLE_PRIMARY = "profiles";
    // âœ… í˜¸í™˜ í…Œì´ë¸”(ìˆìœ¼ë©´ ìë™ ì‚¬ìš©) - ì—†ìœ¼ë©´ ë¬´ì‹œ
    const PROFILE_TABLE_FALLBACK = "app_users";

    // âœ… Edge Function ì´ë¦„
    const EDGE_CREATE_USER = "admin-create-user";
    const EDGE_DELETE_USER = "admin-delete-user";

    // âœ… Supabase Client
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 1) ìœ í‹¸
     ***********************/
    function nowISO(){ return new Date().toISOString(); }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function toast(title, sub){
      const el = document.getElementById("toast");
      el.innerHTML = `<div>${escapeHtml(title)}</div>${sub ? `<div class="s">${escapeHtml(sub)}</div>` : ""}`;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 3200);
    }

    function fmtDT(iso){
      if(!iso) return "-";
      const d = new Date(iso);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}-${mm}-${dd} ${hh}:${mi}`;
    }

    // âœ… (í•µì‹¬) ì•„ì´ë””/ì´ë©”ì¼ ì…ë ¥ì„ ì´ë©”ì¼ë¡œ ì •ê·œí™”
    function toEmail(input){
      const v = (input || "").trim().toLowerCase();
      if(!v) return "";
      if(v.includes("@")) return v;
      return `${v}@${EMAIL_DOMAIN}`;
    }

    function addDaysToDateStr(dateStr, days){
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }

    function isExpiringTomorrow(endDateStr){
      if(!endDateStr) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const end = new Date(endDateStr + "T00:00:00"); end.setHours(0,0,0,0);
      const diffDays = Math.round((end - today) / (24*60*60*1000));
      return diffDays === 1;
    }

    function extractStoreId(link){
      const u = (link || "").trim();
      if(!u) return "";
      let m = u.match(/smartstore\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      m = u.match(/storefarm\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      return "";
    }

    // âœ… (í•µì‹¬) Edge Function í˜¸ì¶œìš© í† í° ê°•ì œ íšë“
    async function getAccessToken(){
      const { data, error } = await sb.auth.getSession();
      if(error) return null;
      return data?.session?.access_token || null;
    }

    /***********************
     * 2) ìƒíƒœ(ë©”ëª¨ë¦¬)
     ***********************/
    const ROLE_LABEL = {
      "MASTER":"ë§ˆìŠ¤í„°",
      "ADMIN":"ê´€ë¦¬ì",
      "ADVERTISER":"ê´‘ê³ ì£¼",
      "AGENCY":"ëŒ€í–‰ì‚¬",
      "DISTRIBUTOR":"ì´íŒì‚¬"
    };

    // âœ… MASTERëŠ” ADMINì²˜ëŸ¼ ì·¨ê¸‰(ê¶Œí•œ/í˜ì´ì§€ ì ‘ê·¼)
    function isAdminLike(p){ return !!p && (p.role === "ADMIN" || p.role === "MASTER"); }
    function isMasterAccount(p){
      return !!p && (
        p.role === "MASTER" ||
        p.is_master === true ||
        p.login_id === MASTER_ID
      );
    }

    // âœ… ê´€ë¦¬ì ì‚­ì œ ê°€ëŠ¥ ë²”ìœ„(ë§ˆìŠ¤í„°=ì „ì²´ / ê´€ë¦¬ì=ì¼ë°˜ë§Œ)
    function canDeleteUserByRole(targetProfile){
      if(!profile || !isAdminLike(profile)) return false;
      if(isMasterAccount(profile)) return true;
      // ADMINì€ ì¼ë°˜ ê³„ì •ë§Œ ì‚­ì œ ê°€ëŠ¥
      const r = (targetProfile?.role || "").toUpperCase();
      return (r === "ADVERTISER" || r === "AGENCY" || r === "DISTRIBUTOR");
    }

    const PAGES = [
      { key:"dash", label:"ëŒ€ì‹œë³´ë“œ", roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"slots", label:"ìŠ¬ë¡¯ê´€ë¦¬", roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"assign", label:"ìŠ¬ë¡¯ë¶€ì—¬", roles:["ADMIN","MASTER"] },
      { key:"users", label:"ì‚¬ìš©ì ê´€ë¦¬", roles:["ADMIN","MASTER"] },
      { key:"cleanup", label:"ìŠ¬ë¡¯ ì‚­ì œ", roles:["ADMIN","MASTER"] },
      { key:"logs", label:"ë¡œê·¸", roles:["ADMIN","MASTER","ADVERTISER","AGENCY","DISTRIBUTOR"] },
    ];
    let activePage = "dash";

    const editingSlotIds = new Set();
    const slotDrafts = new Map();

    const editingUserIds = new Set();
    const userDrafts = new Map();

    const TYPE_DISPLAY_MAP = {
      "ë¦¬ì›Œë“œ(ë‹¨ì¼)": "ìŠ¤í€˜ì–´(ë‹¨ì¼)",
      "ë¦¬ì›Œë“œ(ì›ë¶€)": "ìŠ¤í€˜ì–´(ì›ë¶€)",
      "ë¦¬ì›Œë“œ1": "ìŠ¤í€˜ì–´(ë‹¨ì¼)",
      "ë¦¬ì›Œë“œ2": "ìŠ¤í€˜ì–´(ì›ë¶€)"
    };
    function typeDisplay(v){
      const t = (v || "").trim();
      return TYPE_DISPLAY_MAP[t] || t || "ìŠ¤í€˜ì–´(ë‹¨ì¼)";
    }
    function isTypeWonbu(typeVal){ return typeDisplay(typeVal).includes("ì›ë¶€"); }

    // âœ… ìºì‹œ
    let authUser = null;      // supabase.auth user
    let profile = null;       // profiles row
    let usersCache = [];      // profiles list (admin only)
    let slotsCache = [];      // slots list (RLSë¡œ í•„í„°ëœ ê²°ê³¼)

    // âœ… ìŠ¬ë¡¯ ì„ íƒ(ì¼ê´„ì²˜ë¦¬)
    const selectedSlotIds = new Set();

    // ê°„ë‹¨ ë¡œê·¸(í™”ë©´ í‘œì‹œìš©)
    const logArr = [];
    function logEvent(msg){
      logArr.unshift(`[${fmtDT(nowISO())}] ${msg}`);
      if(logArr.length > 400) logArr.pop();
    }

    /***********************
     * 3) DB ì ‘ê·¼ í•¨ìˆ˜ (app_users ì—ëŸ¬ ìë™ ìš°íšŒ)
     ***********************/
    async function fetchProfileFromTable(tableName){
      const { data, error } = await sb
        .from(tableName)
        .select("*")
        .eq("user_id", authUser.id)
        .maybeSingle();
      return { data, error };
    }

    async function fetchMyProfile(){
      if(!authUser) return null;

      // 1) profiles ìš°ì„ 
      {
        const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_PRIMARY);
        if(!error) return data || null;

        console.warn("profiles load error:", error);
        toast("í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨", error.message || "profiles ì¡°íšŒ ì˜¤ë¥˜");
      }

      // 2) fallback: app_users (ìˆìœ¼ë©´ ì‚¬ìš©)
      {
        const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_FALLBACK);
        if(!error) {
          toast("í˜¸í™˜ ëª¨ë“œ", "profiles ëŒ€ì‹  app_usersë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.");
          return data || null;
        }
        console.warn("app_users load error:", error);
        const msg = (error && error.message) ? error.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
        toast("í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨", msg);
        return null;
      }
    }

    async function fetchUsersIfAdmin(){
      if(!profile || !isAdminLike(profile)) { usersCache = [profile].filter(Boolean); return; }

      const { data, error } = await sb
        .from(PROFILE_TABLE_PRIMARY)
        .select("*")
        .order("created_at", { ascending: true });

      if(error){
        console.error(error);
        toast("ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨", error.message);

        const { data: d2, error: e2 } = await sb
          .from(PROFILE_TABLE_FALLBACK)
          .select("*")
          .order("created_at", { ascending: true });

        if(!e2){
          toast("í˜¸í™˜ ëª¨ë“œ", "ì‚¬ìš©ì ëª©ë¡ì„ app_usersì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
          usersCache = d2 || [];
          return;
        }

        usersCache = [profile].filter(Boolean);
        return;
      }
      usersCache = data || [];
    }

    async function fetchSlots(){
      const { data, error } = await sb
        .from("slots")
        .select("*")
        .order("no", { ascending: true });

      if(error){
        console.error(error);
        toast("ìŠ¬ë¡¯ ì¡°íšŒ ì‹¤íŒ¨", error.message);
        slotsCache = [];
        return;
      }
      slotsCache = (data || []).map(normalizeSlotFromDb);
    }

    function normalizeSlotFromDb(r){
      return {
        id: r.id,
        no: r.no,
        userId: r.login_id || r.user_login_id || r.userId || r.user_id_login || r.user_login || r.userIdLogin || r.user_loginid || r.user_login_id || r.user_id,
        user_uid: r.user_id,
        type: r.type,
        startDate: r.start_date,
        endDate: r.end_date,
        opened: !!r.opened,
        saved: !!r.saved,
        hiddenByAdmin: !!r.hidden_by_admin,
        withdrawPending: !!r.withdraw_pending,
        keyword: r.keyword || "",
        link: r.link || "",
        catalogLink: r.catalog_link || "",
        memo: r.memo || "",
        storeId: r.store_id || "",
        expired: false,
        createdAt: r.created_at
      };
    }

    function computeExpired(s){
      const now = new Date();
      if(s.endDate){
        const end = new Date(s.endDate + "T23:59:59");
        return end < now;
      }
      return false;
    }

    function slotStateTag(s){
      if(s.expired) return `<span class="tag red">ë§Œë£Œ</span>`;
      if(s.withdrawPending) return `<span class="tag gray">ì² íšŒ ëŒ€ê¸°</span>`;
      if(s.hiddenByAdmin) return `<span class="tag gray">ìˆ¨ê¹€</span>`;
      if(s.saved) return `<span class="tag green">ì •ìƒ</span>`;
      if(s.opened) return `<span class="tag gold">ì˜¤í”ˆë¨</span>`;
      return `<span class="tag gray">ë¶€ì—¬ë¨</span>`;
    }

    function storeIdTagHtml(s){
      const v = (s.storeId || "").trim();
      if(!v) return `<span class="muted">-</span>`;
      const cls = s.saved ? "green" : "gray";
      return `<span class="tag ${cls}" title="${escapeHtml(v)}">${escapeHtml(v)}</span>`;
    }

    function ensureSlotDraft(slot){
      if(!slotDrafts.has(slot.id)){
        slotDrafts.set(slot.id, {
          kw: slot.keyword || "",
          link: slot.link || "",
          catalogLink: slot.catalogLink || "",
          memo: slot.memo || ""
        });
      }
      return slotDrafts.get(slot.id);
    }

    function renderLinkCellReadOnly(s){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){
        return `<span class="colLink" title="${escapeHtml(s.link||"")}">${escapeHtml(s.link||"")}</span>`;
      }
      const a = s.link || "";
      const b = s.catalogLink || "";
      return `
        <div class="linkCell">
          <div><span class="k">ìƒí’ˆ</span><span class="v" title="${escapeHtml(a)}">${escapeHtml(a)}</span></div>
          <div style="margin-top:6px"><span class="k">ì¹´íƒˆë¡œê·¸</span><span class="v" title="${escapeHtml(b)}">${escapeHtml(b)}</span></div>
        </div>
      `;
    }

    function renderLinkCellEditing(s, d){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){
        return `<input class="tInput" style="min-width:240px" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="ìƒí’ˆ ë§í¬" />`;
      }
      return `
        <div class="twoInputs">
          <input class="tInput" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="ìƒí’ˆë§í¬" />
          <input class="tInput" data-f="catalogLink" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.catalogLink)}" placeholder="ì¹´íƒˆë¡œê·¸ ë§í¬" />
        </div>
      `;
    }

    /***********************
     * âœ… ìŠ¬ë¡¯ ì¼ê´„ë°”/ì„ íƒ ë¡œì§
     ***********************/
    function updateSlotBulkBar(){
      const bar = document.getElementById("slotBulkBar");
      if(!bar) return;

      if(!profile || !isAdminLike(profile)){
        bar.innerHTML = "";
        return;
      }

      const n = selectedSlotIds.size;
      if(n === 0){
        bar.innerHTML = `<span class="tag gray">ì„ íƒëœ ìŠ¬ë¡¯ ì—†ìŒ</span>`;
        return;
      }

      bar.innerHTML = `
        <span class="tag gold">ì„ íƒ ${n}ê°œ</span>
        <button class="btn mini btnNeon" onclick="bulkExtendSelected()">ì¼ê´„ ì—°ì¥</button>
        <button class="btn mini btnRed" onclick="bulkWithdrawSelected()">ì¼ê´„ ì² íšŒ</button>
        <button class="btn mini btnRed" onclick="bulkDeleteSelected()">ì¼ê´„ ì™„ì „ì‚­ì œ</button>
        <button class="btn mini" onclick="clearSlotSelection()">ì„ íƒ í•´ì œ</button>
      `;
    }

    function clearSlotSelection(){
      selectedSlotIds.clear();
      updateSlotBulkBar();
      renderSlotsPage();
    }

    /***********************
     * 4) ë¡œê·¸ì¸/ì„¸ì…˜
     ***********************/
    async function login(){
      const raw = document.getElementById("loginId").value.trim();
      const pw = document.getElementById("loginPw").value.trim();
      if(!raw || !pw){ toast("ì…ë ¥ í•„ìš”","ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

      const email = toEmail(raw);
      logEvent(`ë¡œê·¸ì¸ ì‹œë„: ${raw} â†’ ${email}`);

      const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error){
        console.error(error);
        toast("ë¡œê·¸ì¸ ì‹¤íŒ¨", error.message);
        return;
      }

      authUser = data.user;

      profile = await fetchMyProfile();
      if(!profile){
        logEvent(`í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨: uid=${authUser?.id || "-"}`);
        toast("í”„ë¡œí•„ ì—†ìŒ/ì¡°íšŒ ì‹¤íŒ¨", "AuthëŠ” ì„±ê³µí–ˆì§€ë§Œ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n- profilesì— user_id rowê°€ ìˆëŠ”ì§€\n- RLSì—ì„œ SELECT selfê°€ í—ˆìš©ì¸ì§€ í™•ì¸");
        await sb.auth.signOut();
        authUser = null;
        return;
      }

      logEvent(`ë¡œê·¸ì¸: ${profile.login_id} (${profile.role}${isMasterAccount(profile) ? "/MASTER" : ""})`);

      await afterLoginBootstrap();
      activePage = "dash";
      mount();
    }

    async function logout(){
      await sb.auth.signOut();
      authUser = null;
      profile = null;
      usersCache = [];
      slotsCache = [];
      activePage = "dash";
      selectedSlotIds.clear();
      mount();
    }

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && document.getElementById("loginView").style.display!=="none"){
        login();
      }
    });

    async function afterLoginBootstrap(){
      await fetchUsersIfAdmin();
      await fetchSlots();
    }

    /***********************
     * 5) í™”ë©´ ë§ˆìš´íŠ¸/ë„¤ë¹„
     ***********************/
    function mount(){
      const isLoggedIn = !!profile;

      document.getElementById("loginView").style.display = isLoggedIn ? "none" : "grid";
      document.getElementById("appView").style.display = isLoggedIn ? "block" : "none";
      if(!isLoggedIn) return;

      const roleText = isMasterAccount(profile) ? "ë§ˆìŠ¤í„° ê³„ì •" : (ROLE_LABEL[profile.role] || profile.role);
      document.getElementById("whoText").textContent =
        `${profile.company_name ? profile.company_name + " " : ""}${profile.login_id} (${roleText})`;

      const nav = document.getElementById("navTabs");
      nav.innerHTML = "";
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      allowed.forEach(p=>{
        const b = document.createElement("button");
        b.className = "tab" + (p.key===activePage ? " active" : "");
        b.textContent = p.label;
        b.onclick = ()=>{ activePage = p.key; render(); };
        nav.appendChild(b);
      });

      // ë§ˆìŠ¤í„°ë©´ ì‚¬ìš©ì ìƒì„± roleì— ADMIN ì˜µì…˜ ì¶”ê°€
      const roleSel = document.getElementById("u_role");
      if(roleSel){
        const hasAdmin = [...roleSel.options].some(o=>o.value==="ADMIN");
        if(isMasterAccount(profile) && !hasAdmin){
          const opt = document.createElement("option");
          opt.value = "ADMIN";
          opt.textContent = "ê´€ë¦¬ì(ADMIN)";
          roleSel.appendChild(opt);
        }
      }

      render();
    }

    function showPage(key){
      for(const p of PAGES){
        const el = document.getElementById("page_"+p.key);
        if(el) el.style.display = (p.key===key) ? "grid" : "none";
      }
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      const nav = document.getElementById("navTabs");
      [...nav.children].forEach((node, idx)=>{
        node.classList.toggle("active", allowed[idx]?.key === key);
      });
    }

    function render(){
      showPage(activePage);
      if(activePage==="dash") renderDash();
      if(activePage==="slots") renderSlotsPage();
      if(activePage==="assign") renderAssign();
      if(activePage==="users") renderUsers();
      if(activePage==="cleanup") renderCleanup();
      if(activePage==="logs") renderLogs();
    }

    async function refresh(){
      if(!profile) return;
      await afterLoginBootstrap();
      render();
      toast("ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
    }

/***********************
 * 6) ìŠ¬ë¡¯ í‘œì‹œ/ìˆ˜ì •/ê´€ë¦¬
 ***********************/

// ğŸ”¥ ì—¬ê¸°ë‹¤ê°€ ì¶”ê°€
function getEditInputsValue(slotId){
  const pick = (f) => {
    const el = document.querySelector(`#slotTbody [data-id="${slotId}"][data-f="${f}"]`);
    return el ? (el.value || "") : "";
  };
  return {
    kw: pick("kw"),
    link: pick("link"),
    catalogLink: pick("catalogLink"),
    memo: pick("memo"),
  };
}

    function visibleSlotsForUser(allSlots){
      const slots = allSlots.map(s=>({ ...s, expired: computeExpired(s) }));
      if(isAdminLike(profile)) return slots;
      return slots.filter(s =>
        (s.user_uid === authUser.id) &&
        !s.hiddenByAdmin &&
        !s.withdrawPending &&
        (s.opened || s.saved)
      );
    }

    function renderSlotsPage(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const slots = visibleSlotsForUser(all);

      const uf = document.getElementById("slotUserFilter");
      if(isAdminLike(profile)){
        const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
        const current = uf.value || "ALL";
        uf.innerHTML =
          `<option value="ALL">ì „ì²´</option>` +
          targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
        uf.value = current;
        uf.disabled = false;
      } else {
        uf.innerHTML = `<option value="${escapeHtml(authUser.id)}">${escapeHtml(profile.company_name ? `${profile.company_name}(${profile.login_id})` : profile.login_id)}</option>`;
        uf.value = authUser.id;
        uf.disabled = true;
      }

      const hint = document.getElementById("slotHint");
      hint.innerHTML = (isAdminLike(profile))
        ? `ê´€ë¦¬ì ëª¨ë“œ: ì „ì²´ ìŠ¬ë¡¯ ì¡°íšŒ Â· ì‚¬ìš©ìì—ê²ŒëŠ” <b style="color:rgba(255,255,255,.95)">ì˜¤í”ˆ/ì •ìƒ</b> ìŠ¬ë¡¯ë§Œ ë…¸ì¶œ`
        : `ì‚¬ìš©ì ëª¨ë“œ: <b style="color:rgba(255,255,255,.95)">ì˜¤í”ˆë¨/ì •ìƒ</b> ìŠ¬ë¡¯ë§Œ ë³´ì…ë‹ˆë‹¤.`;

      const q = (document.getElementById("slotSearch").value || "").trim().toLowerCase();
      const st = document.getElementById("slotFilter").value || "ALL";
      const ufi = document.getElementById("slotUserFilter").value || "ALL";

      let rows = [...slots];

      if(isAdminLike(profile) && ufi !== "ALL"){
        rows = rows.filter(s => (s.user_uid === ufi));
      }

      if(st !== "ALL"){
        if(st==="ALLOCATED") rows = rows.filter(s => !s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="OPENED") rows = rows.filter(s => s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="SAVED") rows = rows.filter(s => s.saved && !s.expired && !s.withdrawPending);
        if(st==="EXPIRED") rows = rows.filter(s => s.expired);
      }

      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          const u = usersCache.find(u=>u.user_id===s.user_uid);
          const uname = (isAdminLike(profile))
            ? ((u?.company_name || "") + " " + (u?.login_id || ""))
            : ((profile.company_name||"") + " " + (profile.login_id||""));
          return (
            (String(s.no||"").includes(q)) ||
            (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) ||
            (s.memo||"").toLowerCase().includes(q) ||
            storeId.includes(q) ||
            uname.toLowerCase().includes(q)
          );
        });
      }

      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      const tb = document.getElementById("slotTbody");
      tb.innerHTML = "";

      for(const s of rows){
        const tr = document.createElement("tr");

        // âœ… ê´€ë¦¬ì/ë§ˆìŠ¤í„°ëŠ” "ë¶€ì—¬ë¨" ìƒíƒœë„ í¸ì§‘ ê°€ëŠ¥
        const canEdit =
          (!s.expired) &&
          (!s.withdrawPending) &&
          (isAdminLike(profile) || s.user_uid === authUser.id) &&
          (isAdminLike(profile) ? true : (s.opened || s.saved));

        const isEditing = editingSlotIds.has(s.id);

        let manage = "";
        if(isAdminLike(profile)){
          const withdrawBtn = (!s.expired && !s.withdrawPending)
            ? `<button class="btn mini btnRed" data-act="withdraw" data-id="${escapeHtml(s.id)}">ì² íšŒ</button>`
            : "";

          const extendBtn = (!s.expired && !s.withdrawPending && s.opened && s.saved)
            ? `<button class="btn mini btnNeon" data-act="extend" data-id="${escapeHtml(s.id)}">ì—°ì¥</button>`
            : "";

          if(s.withdrawPending){
            manage = `<span class="muted">ì² íšŒ ëŒ€ê¸°</span>`;
          } else if(s.hiddenByAdmin && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">ì˜¤í”ˆ</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else if(!s.opened && !s.saved && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">ì˜¤í”ˆ</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else if((s.opened || s.saved) && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini" data-act="hide" data-id="${escapeHtml(s.id)}">ìˆ¨ê¹€</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else {
            manage = `<span class="muted">-</span>`;
          }
        } else {
          manage = s.expired ? `<span class="tag red">ë§Œë£Œ</span>` : `<span class="muted">-</span>`;
        }

        let editCell = `<span class="muted">-</span>`;
        if(canEdit){
          if(!isEditing){
            editCell = `<button class="btn mini btnGreen" data-act="edit" data-id="${escapeHtml(s.id)}">ìˆ˜ì •</button>`;
          } else {
            editCell = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="save" data-id="${escapeHtml(s.id)}">ì €ì¥</button>
                <button class="btn mini" data-act="cancel" data-id="${escapeHtml(s.id)}">ì·¨ì†Œ</button>
              </div>
            `;
          }
        }

        let kwCell, linkCell, memoCell;
        if(isEditing){
          const d = ensureSlotDraft(s);
          kwCell = `<input class="tInput" data-f="kw" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.kw)}" placeholder="í‚¤ì›Œë“œ" />`;
          linkCell = renderLinkCellEditing(s, d);
          memoCell = `<input class="tInput" data-f="memo" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.memo)}" placeholder="ë©”ëª¨" />`;
        } else {
          kwCell = `${escapeHtml(s.keyword||"")}`;
          linkCell = renderLinkCellReadOnly(s);
          memoCell = `${escapeHtml(s.memo||"")}`;
        }

        const expSoon = isExpiringTomorrow(s.endDate);

        const u = usersCache.find(u=>u.user_id===s.user_uid);
        const who = (isAdminLike(profile))
          ? (u ? ((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id) : "-")
          : (profile.company_name ? `${profile.company_name}(${profile.login_id})` : profile.login_id);

        tr.innerHTML = `
          <td>
            ${isAdminLike(profile) ? `<input type="checkbox" class="chk" data-sel="${escapeHtml(s.id)}" ${selectedSlotIds.has(s.id) ? "checked" : ""} />` : `<span class="muted">-</span>`}
          </td>
          <td>${escapeHtml(String(s.no||"-"))}</td>
          <td><div style="font-weight:1200">${escapeHtml(who)}</div></td>
          <td><span class="tag gold typeTag">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td>${escapeHtml(s.startDate||"-")}</td>
          <td class="${expSoon ? "expSoon" : ""}">${escapeHtml(s.endDate||"-")}</td>
          <td>${slotStateTag(s)}</td>
          <td>${editCell}</td>
          <td>${kwCell}</td>
          <td>${linkCell}</td>
          <td>${memoCell}</td>
          <td>${manage}</td>
        `;
        tb.appendChild(tr);
      }

      // ì…ë ¥ ë°˜ì˜
      tb.querySelectorAll('input[data-f]').forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const id = inp.getAttribute("data-id");
          const f = inp.getAttribute("data-f");
          if(!slotDrafts.has(id)) slotDrafts.set(id, {kw:"",link:"",catalogLink:"",memo:""});
          const d = slotDrafts.get(id);
          if(f==="kw") d.kw = inp.value;
          if(f==="link") d.link = inp.value;
          if(f==="catalogLink") d.catalogLink = inp.value;
          if(f==="memo") d.memo = inp.value;
        });
      });

      // âœ… ì²´í¬ë°•ìŠ¤ ì„ íƒ
      tb.querySelectorAll('input[data-sel]').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const id = chk.getAttribute("data-sel");
          if(!id) return;
          if(chk.checked) selectedSlotIds.add(id);
          else selectedSlotIds.delete(id);
          updateSlotBulkBar();
          syncSelectAllCheckbox();
        });
      });

      // âœ… ì „ì²´ ì„ íƒ
      const selAll = document.getElementById("slotSelectAll");
      if(selAll){
        if(!isAdminLike(profile)){
          selAll.checked = false;
          selAll.disabled = true;
        } else {
          selAll.disabled = false;
          syncSelectAllCheckbox();
          selAll.onchange = ()=>{
            const visibleIds = [...tb.querySelectorAll('input[data-sel]')]
              .map(x=>x.getAttribute("data-sel"))
              .filter(Boolean);

            if(selAll.checked){
              visibleIds.forEach(id=>selectedSlotIds.add(id));
            } else {
              visibleIds.forEach(id=>selectedSlotIds.delete(id));
            }
            updateSlotBulkBar();
            renderSlotsPage(); // ì²´í¬ UI ë°˜ì˜
          };
        }
      }

      // âœ… ë²„íŠ¼ í•¸ë“¤ëŸ¬: async + try/catch ë¡œ ë¨¹í†µ ë°©ì§€
      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          try{
            const act = btn.getAttribute("data-act");
            const id = btn.getAttribute("data-id");

            if(act==="edit"){
              editingSlotIds.add(id);
              const s = slotsCache.find(x=>x.id===id);
              if(s) ensureSlotDraft(s);
              renderSlotsPage();
              toast("ìˆ˜ì • ëª¨ë“œ", "ì €ì¥/ì·¨ì†Œ ê°€ëŠ¥");
              return;
            }
            if(act==="cancel"){
              editingSlotIds.delete(id);
              slotDrafts.delete(id);
              renderSlotsPage();
              return;
            }
            if(act==="save"){ await saveSlotInline(id); return; }
            if(act==="open"){ await openSlot(id); return; }
            if(act==="hide"){ await hideSlot(id); return; }
            if(act==="withdraw"){ await withdrawSlot(id); return; }
            if(act==="extend"){ await extendSlotUI(id); return; }

          } catch(e){
            console.error(e);
            toast("ì˜¤ë¥˜", e?.message ? e.message : String(e));
          }
        });
      });

      updateSlotBulkBar();
    }

    function syncSelectAllCheckbox(){
      const selAll = document.getElementById("slotSelectAll");
      const tb = document.getElementById("slotTbody");
      if(!selAll || !tb) return;
      const visibleIds = [...tb.querySelectorAll('input[data-sel]')]
        .map(x=>x.getAttribute("data-sel"))
        .filter(Boolean);
      const allChecked = visibleIds.length > 0 && visibleIds.every(id => selectedSlotIds.has(id));
      selAll.checked = allChecked;
    }

async function saveSlotInline(id){
  const s = slotsCache.find(x=>x.id===id);
  if(!s){ toast("ìŠ¬ë¡¯ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"); return; }
  if(computeExpired(s)){ toast("ë§Œë£Œëœ ìŠ¬ë¡¯"); return; }
  if(s.withdrawPending){ toast("ì² íšŒ ëŒ€ê¸° ìŠ¬ë¡¯"); return; }

  // âœ… ì €ì¥ ì‹œì ì— DOMì—ì„œ ìµœì‹  ê°’ ì§ì ‘ ì½ê¸° (slotDrafts ì˜ì¡´ ì œê±°)
  const domVals = getEditInputsValue(id);

  // fallback: í˜¹ì‹œ DOMì´ ì—†ìœ¼ë©´ ê¸°ì¡´ draft/ì›ë³¸ ì‚¬ìš©
  const d = slotDrafts.get(id) || { kw: s.keyword||"", link: s.link||"", catalogLink: s.catalogLink||"", memo: s.memo||"" };

  const kw = (domVals.kw || d.kw || "").trim();
  const link = (domVals.link || d.link || "").trim();
  const catalogLink = (domVals.catalogLink || d.catalogLink || "").trim();
  const memo = (domVals.memo || d.memo || "").trim();

  const wonbu = isTypeWonbu(s.type);

  if(!kw || !link){
    toast("ì €ì¥ ì‹¤íŒ¨", "í‚¤ì›Œë“œ/ìƒí’ˆë§í¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }
  if(wonbu && !catalogLink){
    toast("ì €ì¥ ì‹¤íŒ¨", "ì›ë¶€ íƒ€ì…ì€ ì¹´íƒˆë¡œê·¸ ë§í¬ë„ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }

  const storeId = extractStoreId(link);

  const payload = {
    keyword: kw,
    link: link,
    catalog_link: wonbu ? catalogLink : "",
    memo: memo,
    store_id: storeId,
    opened: true,
    saved: true,
    hidden_by_admin: false,
    withdraw_pending: false
  };

  // âœ… select()ë¥¼ ë¶™ì´ë©´ ì—…ë°ì´íŠ¸ê°€ ì‹¤ì œë¡œ ëëŠ”ì§€/ê¶Œí•œ ë¬¸ì œì¸ì§€ ë” í™•ì‹¤íˆ ì¡í˜
const { data, error } = await sb
  .from("slots")
  .update(payload)
  .eq("id", id)
  .select("id"); // âœ… ì—…ë°ì´íŠ¸ëœ rowë¥¼ ë°˜í™˜í•˜ê²Œ ê°•ì œ

if (error) {
  console.error(error);
  toast("ì €ì¥ ì‹¤íŒ¨", error.message);
  return;
}

if (!data || data.length === 0) {
  // âœ… ì—¬ê¸°ì„œë§Œ 'ì§„ì§œ 0ê±´' (RLS/ì¡°ê±´ ë¶ˆì¼ì¹˜ ë“±)
  toast("ì €ì¥ ì‹¤íŒ¨", "ì—…ë°ì´íŠ¸ 0ê±´(ê¶Œí•œ/RLS ë˜ëŠ” ì¡°ê±´ ë¶ˆì¼ì¹˜).");
  return;
}

  if(!data || !data.length){
    // RLS ë•Œë¬¸ì— updateê°€ 0í–‰ ì²˜ë¦¬ë˜ëŠ” ê²½ìš°ë¥¼ í™•ì‹¤íˆ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤Œ
    toast("ì €ì¥ ì‹¤íŒ¨", "ì—…ë°ì´íŠ¸ê°€ 0ê±´ì…ë‹ˆë‹¤. (RLS/ê¶Œí•œ ì •ì±…ì—ì„œ updateê°€ ë§‰í˜”ì„ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤)");
    return;
  }

  logEvent(`ìŠ¬ë¡¯ ì €ì¥: no=${s.no}, kw=${kw}, storeId=${storeId||"-"}`);
  toast("ì €ì¥ ì™„ë£Œ", storeId ? `ìŠ¤í† ì–´ID: ${storeId}` : "ìŠ¤í† ì–´ID ì¶”ì¶œ ì‹¤íŒ¨(ë§í¬ í™•ì¸)");

  editingSlotIds.delete(id);
  slotDrafts.delete(id);

  await fetchSlots();
  renderSlotsPage();
  if(activePage==="dash") renderDash();
}

    async function openSlot(id){
      const { error } = await sb.from("slots").update({
        hidden_by_admin:false,
        withdraw_pending:false,
        opened:true
      }).eq("id", id);
      if(error){ toast("ì˜¤í”ˆ ì‹¤íŒ¨", error.message); return; }
      logEvent(`ìŠ¬ë¡¯ ì˜¤í”ˆ: slot=${id}`);
      toast("ì˜¤í”ˆ ì™„ë£Œ", "ì‚¬ìš©ì í™”ë©´ì— ë…¸ì¶œë©ë‹ˆë‹¤.");
      await fetchSlots();
      renderSlotsPage();
    }

    async function hideSlot(id){
      const { error } = await sb.from("slots").update({
        hidden_by_admin:true,
        opened:false
      }).eq("id", id);
      if(error){ toast("ìˆ¨ê¹€ ì‹¤íŒ¨", error.message); return; }
      logEvent(`ìŠ¬ë¡¯ ìˆ¨ê¹€: slot=${id}`);
      toast("ìˆ¨ê¹€ ì²˜ë¦¬", "ê´€ë¦¬ìì—ê²Œë§Œ ë³´ì´ê²Œ ìˆ¨ê¹€");
      editingSlotIds.delete(id);
      slotDrafts.delete(id);
      await fetchSlots();
      renderSlotsPage();
    }

    async function withdrawSlot(id){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("ìŠ¬ë¡¯ ì—†ìŒ"); return; }
      if(computeExpired(s)){ toast("ë§Œë£Œëœ ìŠ¬ë¡¯"); return; }

      const ok = confirm(
        `ì² íšŒ ì²˜ë¦¬(ì² íšŒ ëŒ€ê¸°)ë¡œ ë³€ê²½í• ê¹Œìš”?\n\në²ˆí˜¸: ${s.no}\n\n* ì‚¬ìš©ì í™”ë©´ ìˆ¨ê¹€\n* â€˜ìŠ¬ë¡¯ ì‚­ì œâ€™ì—ë§Œ í‘œì‹œ`
      );
      if(!ok) return;

      const { error } = await sb.from("slots").update({
        withdraw_pending:true,
        hidden_by_admin:true,
        opened:false,
        saved:false
      }).eq("id", id);

      if(error){ toast("ì² íšŒ ì‹¤íŒ¨", error.message); return; }

      logEvent(`ìŠ¬ë¡¯ ì² íšŒëŒ€ê¸°: no=${s.no}`);
      toast("ì² íšŒ ëŒ€ê¸°", `ë²ˆí˜¸ ${s.no} â†’ ìŠ¬ë¡¯ ì‚­ì œ ë©”ë‰´ë¡œ ì´ë™`);

      editingSlotIds.delete(id);
      slotDrafts.delete(id);

      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    function askExtendDays(defaultVal="7"){
      const v = prompt("ì—°ì¥í•  ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 7)", defaultVal);
      if(v===null) return null;
      const d = parseInt(String(v).trim(), 10);
      if(!d || d < 1) return null;
      return d;
    }

    async function extendSlotUI(id){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("ìŠ¬ë¡¯ ì—†ìŒ"); return; }
      if(!(s.opened && s.saved)){ toast("ì—°ì¥ ë¶ˆê°€", "ì˜¤í”ˆ+ì €ì¥ì™„ë£Œ ìŠ¬ë¡¯ë§Œ ì—°ì¥ë©ë‹ˆë‹¤."); return; }

      const d = askExtendDays("7");
      if(!d){ toast("ì—°ì¥ ì·¨ì†Œ/ì˜¤ë¥˜"); return; }

      const newEnd = addDaysToDateStr(s.endDate, d);
      const ok = confirm(`ë²ˆí˜¸ ${s.no} ìŠ¬ë¡¯ì„ +${d}ì¼ ì—°ì¥í• ê¹Œìš”?\n(ë§Œë£Œì¼: ${s.endDate} â†’ ${newEnd})`);
      if(!ok) return;

      const { error } = await sb.from("slots").update({ end_date: newEnd }).eq("id", id);
      if(error){ toast("ì—°ì¥ ì‹¤íŒ¨", error.message); return; }

      logEvent(`ì—°ì¥: no=${s.no}, +${d}ì¼`);
      toast("ì—°ì¥ ì™„ë£Œ", `ë²ˆí˜¸ ${s.no} +${d}ì¼`);

      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    /***********************
     * âœ… ì¼ê´„ ì—°ì¥/ì² íšŒ/ì™„ì „ì‚­ì œ
     ***********************/
    async function bulkExtendSelected(){
      if(!profile || !isAdminLike(profile)) return toast("ê¶Œí•œ ì—†ìŒ");
      const ids = [...selectedSlotIds];
      if(ids.length === 0) return toast("ì„ íƒ ì—†ìŒ");

      const days = askExtendDays("7");
      if(!days) return toast("ì—°ì¥ ì·¨ì†Œ");

      const targets = slotsCache.filter(s => ids.includes(s.id)).map(s=>({ ...s, expired: computeExpired(s) }));
      const ok = confirm(`ì„ íƒ ${targets.length}ê°œ ìŠ¬ë¡¯ì„ +${days}ì¼ ì—°ì¥í• ê¹Œìš”?\n(ì˜¤í”ˆ+ì •ìƒë§Œ ì—°ì¥ ëŒ€ìƒ)`);
      if(!ok) return;

      for(const s of targets){
        if(s.expired || s.withdrawPending) continue;
        if(!(s.opened && s.saved)) continue;
        if(!s.endDate) continue;

        const newEnd = addDaysToDateStr(s.endDate, days);
        const { error } = await sb.from("slots").update({ end_date: newEnd }).eq("id", s.id);
        if(error){
          console.error(error);
          toast("ì¼ê´„ ì—°ì¥ ì‹¤íŒ¨", error.message);
          return;
        }
      }

      toast("ì¼ê´„ ì—°ì¥ ì™„ë£Œ");
      logEvent(`ì¼ê´„ ì—°ì¥: ${targets.length}ê°œ, +${days}ì¼`);
      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    async function bulkWithdrawSelected(){
      if(!profile || !isAdminLike(profile)) return toast("ê¶Œí•œ ì—†ìŒ");
      const ids = [...selectedSlotIds];
      if(ids.length === 0) return toast("ì„ íƒ ì—†ìŒ");

      const ok = confirm(`ì„ íƒ ${ids.length}ê°œ ìŠ¬ë¡¯ì„ ì² íšŒ(ì² íšŒ ëŒ€ê¸°) ì²˜ë¦¬í• ê¹Œìš”?\n(ì‚¬ìš©ì í™”ë©´ ìˆ¨ê¹€ + 'ìŠ¬ë¡¯ ì‚­ì œ' ë©”ë‰´ë¡œ ì´ë™)`);
      if(!ok) return;

      const { error } = await sb.from("slots").update({
        withdraw_pending:true,
        hidden_by_admin:true,
        opened:false,
        saved:false
      }).in("id", ids);

      if(error){
        console.error(error);
        toast("ì¼ê´„ ì² íšŒ ì‹¤íŒ¨", error.message);
        return;
      }

      toast("ì¼ê´„ ì² íšŒ ì™„ë£Œ");
      logEvent(`ì¼ê´„ ì² íšŒ: ${ids.length}ê°œ`);
      selectedSlotIds.clear();
      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    async function bulkDeleteSelected(){
      if(!profile || !isAdminLike(profile)) return toast("ê¶Œí•œ ì—†ìŒ");
      const ids = [...selectedSlotIds];
      if(ids.length === 0) return toast("ì„ íƒ ì—†ìŒ");

      const ok = confirm(`ì„ íƒ ${ids.length}ê°œ ìŠ¬ë¡¯ì„ ì™„ì „ ì‚­ì œí• ê¹Œìš”?\n(ë³µêµ¬ ë¶ˆê°€)`);
      if(!ok) return;

      const { error } = await sb.from("slots").delete().in("id", ids);
      if(error){
        console.error(error);
        toast("ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨", error.message);
        return;
      }

      toast("ì¼ê´„ ì™„ì „ì‚­ì œ ì™„ë£Œ");
      logEvent(`ì¼ê´„ ì™„ì „ì‚­ì œ: ${ids.length}ê°œ`);
      selectedSlotIds.clear();
      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
      if(activePage==="cleanup") renderCleanup();
    }

    /***********************
     * 7) ìŠ¬ë¡¯ë¶€ì—¬(ê´€ë¦¬ì)
     ***********************/
    function syncAssignEndFromStart(){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, 10);
    }

    function renderAssign(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }

      const sel = document.getElementById("assign_user");
      const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
      sel.innerHTML = targets.length
        ? targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)} (${ROLE_LABEL[u.role]||u.role})</option>`).join("")
        : `<option value="">(ì‚¬ìš©ì ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤)</option>`;
      sel.disabled = targets.length===0;

      const st = document.getElementById("assign_start");
      const en = document.getElementById("assign_end");

      if(!st.value){
        const d = new Date();
        d.setDate(d.getDate() + 1);
        st.value = d.toISOString().slice(0,10);
      }
      if(!en.value){
        en.value = addDaysToDateStr(st.value, 10);
      }
    }

    function quickDays(n){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, n);
    }

    async function allocateSlots(){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }

      const uid = document.getElementById("assign_user").value;
      const type = document.getElementById("assign_type").value || "ìŠ¤í€˜ì–´(ë‹¨ì¼)";
      const qty = parseInt(document.getElementById("assign_qty").value || "0", 10);
      const start = document.getElementById("assign_start").value;
      const end = document.getElementById("assign_end").value;

      if(!uid){ toast("ì‚¬ìš©ì ì„ íƒ í•„ìš”"); return; }
      if(!qty || qty<1){ toast("ìˆ˜ëŸ‰ì€ 1 ì´ìƒ"); return; }
      if(!start || !end){ toast("ê¸°ê°„ ì…ë ¥ í•„ìš”"); return; }

      const maxNo = (slotsCache || []).reduce((m,s)=>Math.max(m, s.no||0), 0);

      const newRows = [];
      for(let i=0;i<qty;i++){
        newRows.push({
          id: crypto.randomUUID(),
          no: maxNo + i + 1,
          user_id: uid,
          type: type,
          start_date: start,
          end_date: end,
          opened: false,
          saved: false,
          hidden_by_admin: false,
          withdraw_pending: false,
          keyword: "",
          link: "",
          catalog_link: "",
          memo: "",
          store_id: "",
          created_at: nowISO()
        });
      }

      const { error } = await sb.from("slots").insert(newRows);
      if(error){
        console.error(error);
        toast("ìŠ¬ë¡¯ë¶€ì—¬ ì‹¤íŒ¨", error.message);
        return;
      }

      logEvent(`ìŠ¬ë¡¯ë¶€ì—¬: user=${uid}, qty=${qty}, íƒ€ì…=${type}, ê¸°ê°„=${start}~${end}`);
      toast("ìŠ¬ë¡¯ë¶€ì—¬ ì™„ë£Œ", `ì´ ${qty}ê°œ ìƒì„±ë¨ (ìŠ¬ë¡¯ê´€ë¦¬ì—ì„œ â€˜ì˜¤í”ˆâ€™ í•„ìš”)`);

      await fetchSlots();
      activePage = "slots";
      render();
    }

    /***********************
     * 8) ì‚¬ìš©ì(ê³„ì •) ìƒì„±/ìˆ˜ì •/ì‚­ì œ (ê´€ë¦¬ì)
     ***********************/
    async function createUser(){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }

      const login_id = document.getElementById("u_id").value.trim();
      const password = document.getElementById("u_pw").value.trim();
      const role = document.getElementById("u_role").value;
      const company_name = document.getElementById("u_company").value.trim();

      if(!login_id || login_id.length < 2){ toast("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
      if(!password || password.length < 2){ toast("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
      if(!company_name){ toast("ì—…ì²´ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤"); return; }

      if(login_id === MASTER_ID){
        toast("ìƒì„± ë¶ˆê°€", "ë§ˆìŠ¤í„° ê³„ì • ì•„ì´ë””ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      if(role === "ADMIN" && !isMasterAccount(profile)){
        toast("ê¶Œí•œ ì—†ìŒ", "ê´€ë¦¬ì(ADMIN) ê³„ì • ìƒì„±ì€ ë§ˆìŠ¤í„° ê³„ì •ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }

      const body = {
        login_id,
        password,
        role,
        company_name,
        loginId: login_id,
        pw: password,
        companyName: company_name,
        isMaster: false
      };

      const token = await getAccessToken();
      if(!token){
        toast("ê³„ì • ìƒì„± ì‹¤íŒ¨", "ì„¸ì…˜ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.");
        return;
      }

      try{
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/${EDGE_CREATE_USER}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
              "apikey": SUPABASE_ANON_KEY
            },
            body: JSON.stringify(body)
          }
        );

        const data = await res.json().catch(()=> ({}));

        if(!res.ok){
          console.error("function error:", data);
          toast("ê³„ì • ìƒì„± ì‹¤íŒ¨", data.error || `status ${res.status}`);
          return;
        }

        if(data?.error){
          console.error("function returned error:", data);
          toast("ê³„ì • ìƒì„± ì‹¤íŒ¨", data.error);
          return;
        }

        logEvent(`ê³„ì • ìƒì„±: ${login_id} (${role}) ì—…ì²´ëª…=${company_name}`);
        toast("ê³„ì • ìƒì„± ì™„ë£Œ", `${company_name}(${login_id}) / ${ROLE_LABEL[role] || role}`);

        document.getElementById("u_id").value = "";
        document.getElementById("u_pw").value = "";
        document.getElementById("u_company").value = "";

        await fetchUsersIfAdmin();
        await fetchSlots();
        renderUsers();
        renderAssign();
        if(activePage==="cleanup") renderCleanup();
      } catch (e){
        console.error("invoke exception:", e);
        toast("ê³„ì • ìƒì„± ì‹¤íŒ¨", "Failed to send a request to the Edge Function");
      }
    }

    function ensureUserDraft(u){
      if(!userDrafts.has(u.user_id)){
        userDrafts.set(u.user_id, {
          loginNew: u.login_id,
          companyNew: u.company_name || "",
          roleNew: u.role || "ADVERTISER"
        });
      }
      return userDrafts.get(u.user_id);
    }

    async function saveUserInline(userId){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }
      const u = usersCache.find(x=>x.user_id===userId);
      if(!u){ toast("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"); return; }
      if(u.login_id === MASTER_ID){ toast("ë¶ˆê°€","ë§ˆìŠ¤í„° ê³„ì •ì€ ìˆ˜ì • ë¶ˆê°€"); return; }

      const d = userDrafts.get(userId);
      if(!d){ toast("ìˆ˜ì •ê°’ ì—†ìŒ"); return; }

      const loginNew = (d.loginNew || "").trim();
      const companyNew = (d.companyNew || "").trim();
      const roleNew = (d.roleNew || "").trim();

      if(!loginNew || loginNew.length < 2){ toast("ì•„ì´ë”” ì˜¤ë¥˜","2ê¸€ì ì´ìƒ"); return; }
      if(!companyNew){ toast("ì—…ì²´ëª… í•„ìˆ˜"); return; }
      if(!ROLE_LABEL[roleNew]){ toast("ì—­í•  ì˜¤ë¥˜"); return; }

      if(loginNew === MASTER_ID){ toast("ë¶ˆê°€","ë§ˆìŠ¤í„° ì•„ì´ë””ëŠ” ì‚¬ìš© ë¶ˆê°€"); return; }
      if(roleNew === "ADMIN" && !isMasterAccount(profile)){
        toast("ê¶Œí•œ ì—†ìŒ","ê´€ë¦¬ì(ADMIN) ë³€ê²½ì€ ë§ˆìŠ¤í„°ë§Œ ê°€ëŠ¥");
        return;
      }

      const { error } = await sb.from(PROFILE_TABLE_PRIMARY).update({
        login_id: loginNew,
        company_name: companyNew,
        role: roleNew
      }).eq("user_id", userId);

      if(error){
        console.error(error);
        toast("ìˆ˜ì • ì‹¤íŒ¨", error.message);
        return;
      }

      logEvent(`ê³„ì • ìˆ˜ì •: ${u.login_id} â†’ ${loginNew}`);
      toast("ìˆ˜ì • ì €ì¥ ì™„ë£Œ", `${companyNew}(${loginNew})`);

      editingUserIds.delete(userId);
      userDrafts.delete(userId);

      await fetchUsersIfAdmin();
      renderUsers();
      renderAssign();
      if(activePage==="dash") renderDash();
      if(activePage==="slots") await refresh();
    }

    async function deleteUser(userId){
      if(!isAdminLike(profile)){ toast("ê¶Œí•œ ì—†ìŒ"); return; }

      // âœ… ìê¸° ìì‹  ì‚­ì œ ë°©ì§€
      if(userId === authUser?.id){
        toast("ì‚­ì œ ë¶ˆê°€", "ìê¸° ìì‹  ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const u = usersCache.find(x=>x.user_id===userId);
      const who = u ? `${u.company_name||""}(${u.login_id})` : userId;

      // âœ… ê¶Œí•œ ì²´í¬ (ë§ˆìŠ¤í„°=ì „ì²´ / ê´€ë¦¬ì=ì¼ë°˜ë§Œ)
      if(!canDeleteUserByRole(u)){
        toast("ê¶Œí•œ ì—†ìŒ", "ê´€ë¦¬ìëŠ” ì¼ë°˜ ê³„ì •(ê´‘ê³ ì£¼/ëŒ€í–‰ì‚¬/ì´íŒì‚¬)ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nADMIN/MASTER ì‚­ì œëŠ” ë§ˆìŠ¤í„°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }

      // âœ… ë§ˆìŠ¤í„° ê³„ì • ë³´í˜¸
      if(u && u.login_id === MASTER_ID){
        toast("ì‚­ì œ ë¶ˆê°€", "ë§ˆìŠ¤í„° ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const ok = confirm(
        `ì •ë§ ì‚­ì œí• ê¹Œìš”?\n\n${who}\n\nâ€» profiles + Auth ê³„ì •ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. (ë³µêµ¬ ë¶ˆê°€)`
      );
      if(!ok) return;

      const token = await getAccessToken();
      if(!token){
        toast("ì‚­ì œ ì‹¤íŒ¨", "ì„¸ì…˜ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.");
        return;
      }

      try{
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/${EDGE_DELETE_USER}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
              "apikey": SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ user_id: userId })
          }
        );

        const data = await res.json().catch(()=> ({}));

        if(!res.ok){
          console.error("delete function error:", data);
          toast("ì‚­ì œ ì‹¤íŒ¨", data.error || `status ${res.status}`);
          return;
        }

        if(data?.error){
          console.error("delete function returned error:", data);
          toast("ì‚­ì œ ì‹¤íŒ¨", data.error);
          return;
        }

        toast("ì‚­ì œ ì™„ë£Œ", who);
        logEvent(`ê³„ì • ì‚­ì œ: ${who}`);

        await fetchUsersIfAdmin();
        await fetchSlots();
        renderUsers();
        renderAssign();
        if(activePage==="dash") renderDash();
        if(activePage==="slots") renderSlotsPage();
        if(activePage==="cleanup") renderCleanup();
      } catch(e){
        console.error("delete invoke exception:", e);
        toast("ì‚­ì œ ì‹¤íŒ¨", "Failed to send a request to the Edge Function");
      }
    }

    function renderUsers(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }

      const tb = document.getElementById("userTbody");
      const users = usersCache.filter(u => !(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));

      tb.innerHTML = "";
      users.forEach(u=>{
        const tr = document.createElement("tr");
        const isEditing = editingUserIds.has(u.user_id);

        const delDisabled =
          (u.user_id === authUser?.id) ||
          (u.login_id === MASTER_ID) ||
          (!canDeleteUserByRole(u));

        if(!isEditing){
          tr.innerHTML = `
            <td style="font-weight:1200">${escapeHtml(u.login_id)}</td>
            <td><span class="tag gray">${escapeHtml(ROLE_LABEL[u.role] || u.role)}</span></td>
            <td class="muted" style="font-weight:1100">${escapeHtml(u.company_name||"")}</td>
            <td class="muted" style="font-weight:1100">-</td>
            <td>
              <button class="btn mini btnGreen" data-uact="edit" data-uid="${escapeHtml(u.user_id)}">ìˆ˜ì •</button>
            </td>
            <td>
              <button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}" ${delDisabled ? "disabled" : ""}>
                ì‚­ì œ
              </button>
            </td>
          `;
        } else {
          const d = ensureUserDraft(u);
          const canSeeAdminOpt = isMasterAccount(profile);
          tr.innerHTML = `
            <td>
              <input class="tInput" data-uf="loginNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.loginNew)}" placeholder="ì•„ì´ë””" />
            </td>
            <td>
              <select class="tInput" style="min-width:160px" data-uf="roleNew" data-uid="${escapeHtml(u.user_id)}">
                <option value="ADVERTISER" ${d.roleNew==="ADVERTISER"?"selected":""}>ê´‘ê³ ì£¼</option>
                <option value="AGENCY" ${d.roleNew==="AGENCY"?"selected":""}>ëŒ€í–‰ì‚¬</option>
                <option value="DISTRIBUTOR" ${d.roleNew==="DISTRIBUTOR"?"selected":""}>ì´íŒì‚¬</option>
                ${canSeeAdminOpt ? `<option value="ADMIN" ${d.roleNew==="ADMIN"?"selected":""}>ê´€ë¦¬ì(ADMIN)</option>` : ``}
              </select>
            </td>
            <td>
              <input class="tInput" data-uf="companyNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.companyNew)}" placeholder="ì—…ì²´ëª…" />
            </td>
            <td class="muted" style="font-weight:1100">-</td>
            <td>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-uact="save" data-uid="${escapeHtml(u.user_id)}">ì €ì¥</button>
                <button class="btn mini" data-uact="cancel" data-uid="${escapeHtml(u.user_id)}">ì·¨ì†Œ</button>
              </div>
            </td>
            <td>
              <button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}" ${delDisabled ? "disabled" : ""}>
                ì‚­ì œ
              </button>
            </td>
          `;
        }
        tb.appendChild(tr);
      });

      tb.querySelectorAll('[data-uf]').forEach(el=>{
        const uid = el.getAttribute("data-uid");
        const f = el.getAttribute("data-uf");

        const handler = ()=>{
          if(!userDrafts.has(uid)) userDrafts.set(uid, {loginNew:"",companyNew:"",roleNew:"ADVERTISER"});
          const d = userDrafts.get(uid);
          if(f==="loginNew") d.loginNew = el.value;
          if(f==="companyNew") d.companyNew = el.value;
          if(f==="roleNew") d.roleNew = el.value;
        };

        el.addEventListener("input", handler);
        el.addEventListener("change", handler);
      });

      tb.querySelectorAll("button[data-uact]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-uact");
          const uid = btn.getAttribute("data-uid");

          if(act==="edit"){
            editingUserIds.add(uid);
            const u = usersCache.find(x=>x.user_id===uid);
            if(u) ensureUserDraft(u);
            renderUsers();
            toast("ì‚¬ìš©ì ìˆ˜ì •ëª¨ë“œ", "ì•„ì´ë””/ì—…ì²´ëª…/ì—­í•  ìˆ˜ì •");
            return;
          }
          if(act==="cancel"){
            editingUserIds.delete(uid);
            userDrafts.delete(uid);
            renderUsers();
            return;
          }
          if(act==="save"){
            saveUserInline(uid);
            return;
          }
        });
      });

      tb.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const uid = btn.getAttribute("data-del");
          deleteUser(uid);
        });
      });
    }

    /***********************
     * 9) Cleanup / Dash / Logs
     ***********************/
    function renderCleanup(){
      if(!isAdminLike(profile)){ activePage="slots"; render(); return; }

      const slots = slotsCache.map(s=>({ ...s, expired: computeExpired(s) })).filter(s=>!!s.withdrawPending);

      const cleanUser = document.getElementById("cleanUser");
      const users = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID) && !(u.role==="MASTER" && u.login_id===MASTER_ID));
      const prev = cleanUser.value || "ALL";
      cleanUser.innerHTML =
        `<option value="ALL">ì „ì²´</option>` +
        users.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
      cleanUser.value = prev;

      const q = (document.getElementById("cleanSearch").value || "").trim().toLowerCase();
      const ufi = cleanUser.value || "ALL";

      let rows = [...slots];
      if(ufi !== "ALL") rows = rows.filter(s=>s.user_uid===ufi);

      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          return (
            (String(s.no||"").includes(q)) ||
            (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) ||
            (s.memo||"").toLowerCase().includes(q) ||
            storeId.includes(q)
          );
        });
      }

      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      const tb = document.getElementById("cleanTbody");
      tb.innerHTML = "";
      rows.forEach(s=>{
        const who = usersCache.find(u=>u.user_id===s.user_uid);
        const whoText = who ? ((who.company_name||"") ? `${who.company_name}(${who.login_id})` : who.login_id) : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(String(s.no||"-"))}</td>
          <td style="font-weight:1200">${escapeHtml(whoText)}</td>
          <td><span class="tag gold typeTag">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td>${slotStateTag(s)}</td>
          <td>${escapeHtml(s.keyword||"")}</td>
          <td>${renderLinkCellReadOnly(s)}</td>
          <td>${escapeHtml(s.memo||"")}</td>
          <td><button class="btn mini btnRed" data-del-slot="${escapeHtml(s.id)}">ì‚­ì œ</button></td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll("button[data-del-slot]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del-slot");
          const ok = confirm("ì´ ìŠ¬ë¡¯ì„ ì™„ì „ ì‚­ì œí• ê¹Œìš”? (ë³µêµ¬ ë¶ˆê°€)");
          if(!ok) return;
          const { error } = await sb.from("slots").delete().eq("id", id);
          if(error){ toast("ì‚­ì œ ì‹¤íŒ¨", error.message); return; }
          logEvent(`ìŠ¬ë¡¯ ì™„ì „ì‚­ì œ: slot=${id}`);
          toast("ì‚­ì œ ì™„ë£Œ");
          await fetchSlots();
          renderCleanup();
          if(activePage==="dash") renderDash();
        });
      });
    }

    function renderDash(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const visible = visibleSlotsForUser(all);

      const opened = visible.filter(s=>s.opened && !s.expired).length;
      const saved = visible.filter(s=>s.saved && !s.expired).length;
      const expired = visible.filter(s=>s.expired).length;

      const kpi = document.getElementById("kpi");
      kpi.innerHTML = "";

      const items = (isAdminLike(profile))
        ? [
            { v: String(all.length), k: "ì „ì²´ ìŠ¬ë¡¯" },
            { v: String(all.filter(s=>s.withdrawPending).length), k: "ì² íšŒ ëŒ€ê¸°" },
            { v: String(all.filter(s=>s.hiddenByAdmin && !s.withdrawPending && !s.expired).length), k: "ìˆ¨ê¹€" },
            { v: String(all.filter(s=>s.saved && !s.expired).length), k: "ì •ìƒ" },
          ]
        : [
            { v: String(visible.length), k: "ì „ì²´ ìŠ¬ë¡¯" },
            { v: String(opened), k: "ì˜¤í”ˆë¨" },
            { v: String(saved), k: "ì •ìƒ" },
            { v: String(expired), k: "ë§Œë£Œ" },
          ];

      items.forEach(it=>{
        const d = document.createElement("div");
        d.className = "box";
        d.innerHTML = `<div class="v">${escapeHtml(it.v)}</div><div class="k">${escapeHtml(it.k)}</div>`;
        kpi.appendChild(d);
      });
    }

    function renderLogs(){
      const box = document.getElementById("logBox");
      box.textContent = logArr.length ? logArr.join("\n") : "ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
    }

    /***********************
     * 10) ìµœì´ˆ ë¡œë”©: ì„¸ì…˜ ìë™ ë³µêµ¬
     ***********************/
    (async function init(){
      const { data } = await sb.auth.getSession();
      authUser = data?.session?.user || null;
      if(authUser){
        profile = await fetchMyProfile();
        if(profile){
          await afterLoginBootstrap();
          logEvent(`ì„¸ì…˜ ë³µêµ¬: ${profile.login_id}`);
        } else {
          await sb.auth.signOut();
          authUser = null;
          profile = null;
        }
      }

      sb.auth.onAuthStateChange(async (event, session) => {
        authUser = session?.user || null;
        if(!authUser){
          profile = null;
          usersCache = [];
          slotsCache = [];
          activePage = "dash";
          selectedSlotIds.clear();
          mount();
          return;
        }
        profile = await fetchMyProfile();
        if(profile){
          await afterLoginBootstrap();
          mount();
        }
      });

      mount();
    })();
  </script>
</body>
</html>
