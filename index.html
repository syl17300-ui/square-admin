<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Square | Admin Console</title>

  <style>
    :root{
      --bg:#070b18;
      --panel:#101428;
      --panel2:#151a33;
      --border:#2a2f55;
      --text:#eef2ff;
      --muted:#a7b0d6;

      /* 포인트 */
      --neon:#49b6ff;
      --neon2:#7ee3ff;

      --gold:#d4af37;
      --gold2:#f3d77a;
      --green:#39d98a;
      --red:#ff5c5c;
      --gray:#8f93a8;

      --shadow: 0 12px 34px rgba(0,0,0,.42);
      --radius: 18px;
      --radius2: 14px;
      --focus: 0 0 0 4px rgba(73,182,255,.22);

      /* ✅ 배경 이미지 (원하면 파일명만 바꾸기) */
      --bgImg: url('chip-bg.png');
    }

    *{box-sizing:border-box}

    /* ✅ 렉 방지: 모든 애니메이션/트랜지션 강제 OFF */
    *, *::before, *::after{
      animation: none !important;
      transition: none !important;
    }

    html{
      height:100%;
      min-height:100%;
      background: var(--bg);
    }

    body{
      margin:0;
      min-height:100vh;
      font-family:
        "Pretendard Variable","Pretendard","SUIT","Inter",
        ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        "Apple SD Gothic Neo","Noto Sans KR", sans-serif;

      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(73,182,255,.12), transparent 60%),
        radial-gradient(900px 520px at 85% 30%, rgba(126,227,255,.10), transparent 55%),
        radial-gradient(900px 520px at 50% 120%, rgba(73,182,255,.07), transparent 60%),

        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(rgba(73,182,255,.030) 1px, transparent 1px),
        linear-gradient(90deg, rgba(73,182,255,.030) 1px, transparent 1px),

        linear-gradient(rgba(6,9,22,.86), rgba(6,9,22,.86)),
        var(--bgImg);

      background-size:
        auto, auto, auto,
        64px 64px,
        64px 64px,
        16px 16px,
        16px 16px,
        auto,
        cover;

      background-position:
        center, center, center,
        0 0, 0 0,
        0 0, 0 0,
        center,
        center;

      background-repeat:
        no-repeat, no-repeat, no-repeat,
        repeat, repeat,
        repeat, repeat,
        no-repeat,
        no-repeat;

      color:var(--text);
      letter-spacing:-.2px;
      overflow-x:hidden;
    }

    a{color:inherit;text-decoration:none}

    .wrap{max-width:1440px;margin:0 auto;padding:24px}

    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(6,9,22,.66);
      border-bottom: 1px solid rgba(42,47,85,.75);
    }
    .topbar-inner{
      max-width:1440px;margin:0 auto;
      padding:16px 24px;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
    }

    .brand{
      display:flex;align-items:center;gap:12px;
      font-weight:1000;letter-spacing:.25px;
      white-space:nowrap;
    }
    .logoMark{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(73,182,255,.95), rgba(126,227,255,.9));
      box-shadow: 0 12px 28px rgba(73,182,255,.18);
      position:relative;
      flex:0 0 auto;
      overflow:hidden;
    }
    .logoMark:before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 55%),
        radial-gradient(22px 22px at 70% 70%, rgba(0,0,0,.18), transparent 60%);
      mix-blend-mode: overlay;
      opacity:.9;
    }
    .logoMark:after{
      content:"S";
      position:absolute;inset:0;
      display:grid;place-items:center;
      color:#081024;font-weight:1200;
      font-size:18px;
      letter-spacing:.2px;
      text-shadow: 0 1px 0 rgba(255,255,255,.15);
    }

    .brandTitle{display:flex;flex-direction:column;line-height:1.05}
    .brandTitle .t1{font-size:16px;color:rgba(255,255,255,.92)}
    .brandTitle .t2{font-size:13px;color:var(--muted);font-weight:800}

    .userBox{
      display:flex;align-items:center;gap:10px;
      color:var(--muted);font-size:14px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(12,16,34,.70);
      font-weight:900;
    }
    .pill .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 5px rgba(57,217,138,.12);
    }

    .btn{
      border:1px solid rgba(42,47,85,.95);
      background: rgba(12,16,34,.74);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      font-size:15px;
      line-height:1;
      white-space:nowrap;
    }
    .btn:active{transform:none}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .btnNeon{
      background: linear-gradient(135deg, rgba(73,182,255,.95), rgba(126,227,255,.92));
      border: 1px solid rgba(73,182,255,.45);
      color:#061026;
      font-weight:1100;
      box-shadow: 0 10px 26px rgba(73,182,255,.18);
    }
    .btnRed{
      border:1px solid rgba(255,92,92,.35);
      background: rgba(255,92,92,.10);
      color: #ffd6d6;
    }
    .btnGreen{
      border:1px solid rgba(57,217,138,.35);
      background: rgba(57,217,138,.10);
      color: #d7fff0;
    }
    .mini{padding:10px 12px;border-radius:12px;font-size:14px}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .tab{
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(42,47,85,.88);
      background: rgba(12,16,34,.55);
      color: var(--muted);
      font-weight:1100;
      cursor:pointer;
      font-size:14px;
      white-space:nowrap;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(73,182,255,.60);
      box-shadow: 0 0 0 4px rgba(73,182,255,.12);
      background: rgba(12,16,34,.82);
    }

    .grid{display:grid;gap:16px}
    .card{
      border: 1px solid rgba(42,47,85,.92);
      border-radius: 18px;
      background: rgba(10,14,32,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHeader{
      padding:18px 18px 12px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom: 1px solid rgba(42,47,85,.65);
      background: rgba(8,12,28,.40);
    }
    .cardHeader .h{display:flex;flex-direction:column;gap:6px;min-width:260px}
    .cardHeader .h .title{
      font-size:20px;
      font-weight:1300;
      letter-spacing:.1px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 0 18px rgba(73,182,255,.16);
      white-space:nowrap;
    }
    .cardHeader .h .sub{
      font-size:14px;
      color:rgba(233,233,255,.90);
      font-weight:1100;
      white-space:nowrap;
    }
    .cardBody{padding:18px}

    .row{display:flex;gap:14px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    .label{font-size:13px;color:var(--muted);font-weight:1000;margin-bottom:9px;white-space:nowrap}
    .input, select, textarea{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:15px;
    }
    .input:focus, select:focus, textarea:focus{box-shadow: var(--focus); border-color: rgba(73,182,255,.55)}
    textarea{min-height:92px;resize:vertical}
    .hint{font-size:13px;color:var(--muted);margin-top:9px;line-height:1.6;font-weight:800}
    .hr{height:1px;background: rgba(42,47,85,.65); margin:16px 0}

    .rightActions{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      font-weight:1200;
      padding:14px 14px;
      border-bottom: 1px solid rgba(42,47,85,.78);
      background: rgba(8,12,28,.70);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space:nowrap;
    }
    tbody td{
      padding:14px 14px;
      border-bottom: 1px solid rgba(42,47,85,.55);
      vertical-align:middle;
      white-space:nowrap;
      font-weight:900;
    }
    tbody tr:hover{background: rgba(73,182,255,.06)}

    .tag{
      display:inline-flex;align-items:center;gap:9px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color: var(--text);
      font-weight:1200;
      white-space:nowrap;
      font-size:13px;
      line-height:1;
    }
    .tag.gold{border-color: rgba(73,182,255,.55); color: rgba(255,255,255,.94)}
    .tag.gray{border-color: rgba(143,147,168,.35); color: #cfd2e2}
    .tag.green{border-color: rgba(57,217,138,.35); color: #bfffe6}
    .tag.red{border-color: rgba(255,92,92,.35); color: #ffd6d6}

    .typeTag{font-weight:1400}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns: repeat(4, 1fr);gap:12px}
    @media (max-width:980px){
      .kpi{grid-template-columns: repeat(2,1fr)}
      .topbar-inner{flex-wrap:wrap;justify-content:center}
    }
    .kpi .box{
      border:1px solid rgba(42,47,85,.9);
      background: rgba(6,10,24,.55);
      border-radius: 14px;
      padding:16px;
    }
    .kpi .box .v{font-size:20px;font-weight:1200;color:var(--text);white-space:nowrap}
    .kpi .box .k{font-size:13px;color:var(--muted);font-weight:1000;margin-top:7px;white-space:nowrap}
    .foot{padding:14px 24px;color:var(--muted);font-size:12px;text-align:center;opacity:.9}

    .loginWrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .loginCard{
      width:min(520px, 96vw);
      border:1px solid rgba(42,47,85,.9);
      border-radius: 20px;
      background: rgba(10,14,32,.78);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .loginTop{
      padding:22px 20px 18px 20px;
      border-bottom: 1px solid rgba(42,47,85,.65);
      display:flex;align-items:center;gap:12px;
      background: rgba(8,12,28,.35);
    }
    .loginTop .t{display:flex;flex-direction:column;gap:4px}
    .loginTop .t .a{
      font-weight:1300;
      color:rgba(255,255,255,.95);
      font-size:28px;
      letter-spacing:.2px;
      white-space:nowrap;
      text-shadow: 0 0 18px rgba(73,182,255,.20);
    }
    .loginTop .t .b{display:none}
    .loginBody{padding:20px}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 100;
      padding: 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(42,47,85,.9);
      background: rgba(10,14,32,.92);
      box-shadow: var(--shadow);
      color: var(--text);
      font-weight:1000;
      display:none;
      max-width: 560px;
      backdrop-filter: blur(12px);
    }
    .toast.show{display:block}
    .toast .s{color:var(--muted);font-weight:900;font-size:13px;margin-top:7px}

    .tableScroll{
      overflow:auto;
      max-height: 70vh;
      border-top:1px solid rgba(42,47,85,.65);
      margin-top:14px;
    }

    .tInput{
      width:100%;
      min-width: 220px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(42,47,85,.95);
      background: rgba(6,10,24,.72);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    .tInput:focus{box-shadow: var(--focus); border-color: rgba(73,182,255,.55)}

    .colLink{
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
      vertical-align:bottom;
    }

    .chk{
      width:18px;height:18px;
      accent-color: var(--neon);
      cursor:pointer;
      transform: translateY(2px);
    }
    .actionBar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }

    .expSoon{ color: var(--red) !important; font-weight:1400 !important; }

    .linkCell{ white-space:normal !important; line-height:1.35; font-weight:900; }
    .linkCell .k{color:var(--muted);font-weight:1000;font-size:12px;margin-right:6px}
    .linkCell .v{
      display:inline-block;
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:bottom;
      white-space:nowrap;
    }

    .twoInputs{ display:flex; flex-direction:column; gap:10px; min-width:240px; }
  </style>
</head>

<body>
  <div id="loginView" class="loginWrap" style="display:none">
    <div class="loginCard">
      <div class="loginTop">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="t">
          <div class="a">Square</div>
          <div class="b"></div>
        </div>
      </div>
      <div class="loginBody">
        <div class="row">
          <div class="field">
            <div class="label">아이디</div>
            <input id="loginId" class="input" placeholder="아이디" autocomplete="username" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <div class="label">비밀번호</div>
            <input id="loginPw" class="input" type="password" placeholder="비밀번호" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;align-items:center">
          <button class="btn btnNeon" onclick="login()">로그인</button>
        </div>
      </div>
    </div>
  </div>

  <div id="appView" style="display:none">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logoMark" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="t1">스퀘어</div>
            <div class="t2">Square Admin Console</div>
          </div>
        </div>

        <div class="nav" id="navTabs"></div>

        <div class="userBox">
          <div class="pill">
            <div class="dot"></div>
            <span id="whoText">-</span>
          </div>
          <button class="btn mini" onclick="logout()">로그아웃</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div id="page_dash" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">대시보드</div>
              <div class="sub">슬롯 운영 현황</div>
            </div>
            <div class="rightActions">
              <button class="btn mini" onclick="refresh()">새로고침</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="kpi" id="kpi"></div>
          </div>
        </div>
      </div>

      <div id="page_slots" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯관리</div>
              <div class="sub">✅ 원부 타입은 상품링크 + 카탈로그 링크 2칸</div>
            </div>

            <div class="rightActions">
              <div class="actionBar" id="slotBulkBar"></div>
              <button class="btn mini" onclick="refresh()">새로고침</button>
            </div>
          </div>

          <div class="cardBody" style="padding-bottom:0">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">검색</div>
                <input id="slotSearch" class="input" placeholder="키워드 / 사용자ID / 링크 일부 / 스토어ID" oninput="renderSlotsPage()" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">필터</div>
                <select id="slotFilter" onchange="renderSlotsPage()">
                  <option value="ALL">전체</option>
                  <option value="OPENED">오픈됨</option>
                  <option value="SAVED">정상</option>
                  <option value="ALLOCATED">부여됨(숨김)</option>
                  <option value="EXPIRED">만료</option>
                </select>
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">사용자(관리자용)</div>
                <select id="slotUserFilter" onchange="renderSlotsPage()"></select>
              </div>
            </div>
            <div class="hint" id="slotHint"></div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:52px">선택</th>
                  <th style="width:86px">번호</th>
                  <th style="width:260px">사용자</th>
                  <th style="width:120px">타입</th>
                  <th style="width:200px">스토어ID</th>
                  <th style="width:130px">시작일</th>
                  <th style="width:130px">만료일</th>
                  <th style="width:140px">상태</th>
                  <th style="width:170px">수정</th>
                  <th>키워드</th>
                  <th style="width:240px">링크</th>
                  <th>메모</th>
                  <th style="width:320px">관리</th>
                </tr>
              </thead>
              <tbody id="slotTbody"></tbody>
            </table>
          </div>

          <div class="cardBody">
            <div class="smallNote" style="display:none"></div>
          </div>
        </div>
      </div>

      <div id="page_assign" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯부여</div>
              <div class="sub">기본 시작일: 내일</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">관리자 전용</span>
            </div>
          </div>
          <div class="cardBody">
            <div class="row">
              <div class="field">
                <div class="label">사용자(광고주/대행사/총판사 ID)</div>
                <select id="assign_user"></select>
              </div>
              <div class="field">
                <div class="label">슬롯타입</div>
                <select id="assign_type">
                  <option value="스퀘어(단일)">스퀘어(단일)</option>
                  <option value="스퀘어(원부)">스퀘어(원부)</option>
                </select>
              </div>
              <div class="field" style="min-width:180px">
                <div class="label">수량</div>
                <input id="assign_qty" class="input" type="number" min="1" value="10" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="label">시작일</div>
                <input id="assign_start" class="input" type="date" onchange="syncAssignEndFromStart()" />
              </div>
              <div class="field">
                <div class="label">만료일</div>
                <input id="assign_end" class="input" type="date" />
              </div>
              <div class="field" style="min-width:360px;display:flex;align-items:flex-end;gap:10px;justify-content:flex-end">
                <button class="btn mini" onclick="quickDays(1)">+1일</button>
                <button class="btn mini" onclick="quickDays(7)">+7일</button>
                <button class="btn mini" onclick="quickDays(10)">+10일</button>
                <button class="btn btnNeon" onclick="allocateSlots()">슬롯부여</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page_users" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">사용자 관리</div>
              <div class="sub">✅ 마스터 계정은 관리자(ADMIN) 계정도 생성/수정 가능</div>
            </div>
            <div class="rightActions">
              <span class="tag gold">관리자 전용</span>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">아이디(요청 아이디)</div>
                <input id="u_id" class="input" placeholder="예: brother_topbiz" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">비밀번호</div>
                <input id="u_pw" class="input" placeholder="예: 1234" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">역할</div>
                <select id="u_role">
                  <option value="ADVERTISER">광고주</option>
                  <option value="AGENCY">대행사</option>
                  <option value="DISTRIBUTOR">총판사</option>
                </select>
              </div>
              <div class="field" style="min-width:320px">
                <div class="label">업체명(필수)</div>
                <input id="u_company" class="input" placeholder="예: 브라더탑비즈" />
              </div>
              <div class="field" style="min-width:220px;display:flex;align-items:flex-end;justify-content:flex-end">
                <button class="btn btnNeon" onclick="createUser()">등록하기</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="tableScroll" style="max-height:55vh;margin-top:0">
              <table>
                <thead>
                  <tr>
                    <th style="width:260px">아이디</th>
                    <th style="width:180px">역할</th>
                    <th>업체명</th>
                    <th style="width:240px">비밀번호</th>
                    <th style="width:220px">수정</th>
                    <th style="width:160px">삭제</th>
                  </tr>
                </thead>
                <tbody id="userTbody"></tbody>
              </table>
            </div>
            <div class="hint">※ 이 페이지는 Supabase Auth + profiles 테이블 기반입니다. (호환: app_users 있으면 자동 fallback)</div>
          </div>
        </div>
      </div>

      <div id="page_cleanup" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">슬롯 삭제</div>
              <div class="sub">철회 대기 슬롯만 표시</div>
            </div>

            <div class="rightActions">
              <button class="btn mini" onclick="renderCleanup()">새로고침</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field" style="min-width:260px">
                <div class="label">검색</div>
                <input id="cleanSearch" class="input" placeholder="사용자ID / 키워드 / 링크 일부 / 스토어ID" oninput="renderCleanup()" />
              </div>
              <div class="field" style="min-width:220px">
                <div class="label">사용자</div>
                <select id="cleanUser" onchange="renderCleanup()"></select>
              </div>
            </div>
          </div>

          <div class="tableScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">번호</th>
                  <th style="width:260px">사용자</th>
                  <th style="width:110px">타입</th>
                  <th style="width:200px">스토어ID</th>
                  <th style="width:130px">상태</th>
                  <th>키워드</th>
                  <th style="width:240px">링크</th>
                  <th>메모</th>
                  <th style="width:150px">완전삭제</th>
                </tr>
              </thead>
              <tbody id="cleanTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="page_logs" class="grid" style="display:none">
        <div class="card">
          <div class="cardHeader">
            <div class="h">
              <div class="title">로그</div>
              <div class="sub">최근 동작 로그</div>
            </div>
          </div>
          <div class="cardBody">
            <div id="logBox" class="muted" style="font-weight:1000;line-height:1.75;white-space:pre-wrap"></div>
          </div>
        </div>
      </div>

      <div class="foot">© Square Admin Console (Supabase Auth + DB)</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ✅ supabase-js (브라우저용) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * 0) Supabase 연결값
     ***********************/
    const SUPABASE_URL = "https://wavosfsnwwrcmcsgvlho.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhdm9zZnNud3dyY21jc2d2bGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjgwNjEsImV4cCI6MjA4NTkwNDA2MX0.5hh7b9u12aCDTuGtjQycVzBEkplnotDvLkmt5DmJ8eU";

    // ✅ 로그인ID를 이메일로 매핑 (username@square.local)
    const EMAIL_DOMAIN = "square.local";

    // ✅ 마스터 계정 고정
    const MASTER_ID = "syl17300";

    // ✅ 프로필 테이블 기본값(메인)
    const PROFILE_TABLE_PRIMARY = "profiles";
    // ✅ 호환 테이블(있으면 자동 사용) - 없으면 무시
    const PROFILE_TABLE_FALLBACK = "app_users";

    // Edge Function 이름 (너가 만든 것)
    const EDGE_CREATE_USER = "admin-create-user";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 1) 유틸
     ***********************/
    function nowISO(){ return new Date().toISOString(); }
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toast(title, sub){
      const el = document.getElementById("toast");
      el.innerHTML = `<div>${escapeHtml(title)}</div>${sub ? `<div class="s">${escapeHtml(sub)}</div>` : ""}`;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 2800);
    }
    function fmtDT(iso){
      if(!iso) return "-";
      const d = new Date(iso);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}-${mm}-${dd} ${hh}:${mi}`;
    }
    function toEmail(loginId){
      return `${loginId}@${EMAIL_DOMAIN}`;
    }
    function todayStr(){
      return new Date().toISOString().slice(0,10);
    }
    function addDaysToDateStr(dateStr, days){
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    function isExpiringTomorrow(endDateStr){
      if(!endDateStr) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const end = new Date(endDateStr + "T00:00:00"); end.setHours(0,0,0,0);
      const diffDays = Math.round((end - today) / (24*60*60*1000));
      return diffDays === 1;
    }
    function extractStoreId(link){
      const u = (link || "").trim();
      if(!u) return "";
      let m = u.match(/smartstore\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      m = u.match(/storefarm\.naver\.com\/([^\/\?\#]+)/i);
      if(m && m[1]) return decodeURIComponent(m[1]);
      return "";
    }

    /***********************
     * 2) 상태(메모리)
     ***********************/
    const ROLE_LABEL = {
      "ADMIN":"관리자",
      "ADVERTISER":"광고주",
      "AGENCY":"대행사",
      "DISTRIBUTOR":"총판사"
    };

    const PAGES = [
      { key:"dash", label:"대시보드", roles:["ADMIN","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"slots", label:"슬롯관리", roles:["ADMIN","ADVERTISER","AGENCY","DISTRIBUTOR"] },
      { key:"assign", label:"슬롯부여", roles:["ADMIN"] },
      { key:"users", label:"사용자 관리", roles:["ADMIN"] },
      { key:"cleanup", label:"슬롯 삭제", roles:["ADMIN"] },
      { key:"logs", label:"로그", roles:["ADMIN","ADVERTISER","AGENCY","DISTRIBUTOR"] },
    ];
    let activePage = "dash";

    const selectedSlotIds  = new Set();
    const editingSlotIds = new Set();
    const slotDrafts = new Map();

    const editingUserIds = new Set();
    const userDrafts = new Map();

    const TYPE_DISPLAY_MAP = {
      "리워드(단일)": "스퀘어(단일)",
      "리워드(원부)": "스퀘어(원부)",
      "리워드1": "스퀘어(단일)",
      "리워드2": "스퀘어(원부)"
    };
    function typeDisplay(v){
      const t = (v || "").trim();
      return TYPE_DISPLAY_MAP[t] || t || "스퀘어(단일)";
    }
    function isTypeWonbu(typeVal){ return typeDisplay(typeVal).includes("원부"); }

    // ✅ 캐시
    let authUser = null;      // supabase.auth user
    let profile = null;       // profiles row
    let usersCache = [];      // profiles list (admin only)
    let slotsCache = [];      // slots list (RLS로 필터된 결과)

    // 간단 로그(화면 표시용)
    const logArr = [];
    function logEvent(msg){
      logArr.unshift(`[${fmtDT(nowISO())}] ${msg}`);
      if(logArr.length > 400) logArr.pop();
    }

    function isMasterAccount(p){
      return !!p && p.role === "ADMIN" && p.login_id === MASTER_ID;
    }

    /***********************
     * 3) DB 접근 함수
     * ✅ 여기서 app_users 에러가 나도 자동 우회하도록 수정
     ***********************/
    async function fetchProfileFromTable(tableName){
      const { data, error } = await sb
        .from(tableName)
        .select("*")
        .eq("user_id", authUser.id)
        .maybeSingle();
      return { data, error };
    }

    async function fetchMyProfile(){
      if(!authUser) return null;

      // 1) profiles 우선
      {
        const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_PRIMARY);
        if(!error) return data || null;

        // profiles 자체가 없거나 RLS/권한 문제 등
        console.warn("profiles load error:", error);
        // 여기서는 바로 실패시키지 말고, fallback도 시도
      }

      // 2) fallback: app_users (있으면 사용, 없으면 무시)
      {
        const { data, error } = await fetchProfileFromTable(PROFILE_TABLE_FALLBACK);
        if(!error) {
          toast("호환 모드", "profiles 대신 app_users를 사용 중입니다.");
          return data || null;
        }

        // app_users 테이블 없음/권한 문제라면 최종 실패
        console.warn("app_users load error:", error);

        // 에러 메시지 더 친절하게 표시
        const msg = (error && error.message) ? error.message : "알 수 없는 오류";
        toast("프로필 로드 실패", msg);
        return null;
      }
    }

    async function fetchUsersIfAdmin(){
      if(!profile || profile.role !== "ADMIN") { usersCache = [profile].filter(Boolean); return; }

      // 관리자: 전체 profiles 조회 (RLS가 admin만 허용해야 함)
      const { data, error } = await sb
        .from(PROFILE_TABLE_PRIMARY)
        .select("*")
        .order("created_at", { ascending: true });

      if(error){
        console.error(error);
        toast("사용자 목록 조회 실패", error.message);

        // profiles가 아니라 fallback만 있는 환경이면 거기도 한번 시도
        const { data: d2, error: e2 } = await sb
          .from(PROFILE_TABLE_FALLBACK)
          .select("*")
          .order("created_at", { ascending: true });

        if(!e2){
          toast("호환 모드", "사용자 목록을 app_users에서 불러옵니다.");
          usersCache = d2 || [];
          return;
        }

        usersCache = [profile].filter(Boolean);
        return;
      }
      usersCache = data || [];
    }

    async function fetchSlots(){
      const { data, error } = await sb
        .from("slots")
        .select("*")
        .order("no", { ascending: true });

      if(error){
        console.error(error);
        toast("슬롯 조회 실패", error.message);
        slotsCache = [];
        return;
      }
      slotsCache = (data || []).map(normalizeSlotFromDb);
    }

    function normalizeSlotFromDb(r){
      return {
        id: r.id,
        no: r.no,
        userId: r.login_id || r.user_login_id || r.userId || r.user_id_login || r.user_login || r.userIdLogin || r.user_loginid || r.user_login_id || r.user_id,
        user_uid: r.user_id,
        type: r.type,
        startDate: r.start_date,
        endDate: r.end_date,
        opened: !!r.opened,
        saved: !!r.saved,
        hiddenByAdmin: !!r.hidden_by_admin,
        withdrawPending: !!r.withdraw_pending,
        keyword: r.keyword || "",
        link: r.link || "",
        catalogLink: r.catalog_link || "",
        memo: r.memo || "",
        storeId: r.store_id || "",
        expired: false,
        createdAt: r.created_at
      };
    }

    function computeExpired(s){
      const now = new Date();
      if(s.endDate){
        const end = new Date(s.endDate + "T23:59:59");
        return end < now;
      }
      return false;
    }

    function slotStateTag(s){
      if(s.expired) return `<span class="tag red">만료</span>`;
      if(s.withdrawPending) return `<span class="tag gray">철회 대기</span>`;
      if(s.hiddenByAdmin) return `<span class="tag gray">숨김</span>`;
      if(s.saved) return `<span class="tag green">정상</span>`;
      if(s.opened) return `<span class="tag gold">오픈됨</span>`;
      return `<span class="tag gray">부여됨</span>`;
    }

    function storeIdTagHtml(s){
      const v = (s.storeId || "").trim();
      if(!v) return `<span class="muted">-</span>`;
      const cls = s.saved ? "green" : "gray";
      return `<span class="tag ${cls}" title="${escapeHtml(v)}">${escapeHtml(v)}</span>`;
    }

    function ensureSlotDraft(slot){
      if(!slotDrafts.has(slot.id)){
        slotDrafts.set(slot.id, {
          kw: slot.keyword || "",
          link: slot.link || "",
          catalogLink: slot.catalogLink || "",
          memo: slot.memo || ""
        });
      }
      return slotDrafts.get(slot.id);
    }

    function renderLinkCellReadOnly(s){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){
        return `<span class="colLink" title="${escapeHtml(s.link||"")}">${escapeHtml(s.link||"")}</span>`;
      }
      const a = s.link || "";
      const b = s.catalogLink || "";
      return `
        <div class="linkCell">
          <div><span class="k">상품</span><span class="v" title="${escapeHtml(a)}">${escapeHtml(a)}</span></div>
          <div style="margin-top:6px"><span class="k">카탈로그</span><span class="v" title="${escapeHtml(b)}">${escapeHtml(b)}</span></div>
        </div>
      `;
    }

    function renderLinkCellEditing(s, d){
      const wonbu = isTypeWonbu(s.type);
      if(!wonbu){
        return `<input class="tInput" style="min-width:240px" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="상품 링크" />`;
      }
      return `
        <div class="twoInputs">
          <input class="tInput" data-f="link" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.link)}" placeholder="상품링크" />
          <input class="tInput" data-f="catalogLink" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.catalogLink)}" placeholder="카탈로그 링크" />
        </div>
      `;
    }

    /***********************
     * 4) 로그인/세션
     ***********************/
    async function login(){
      const id = document.getElementById("loginId").value.trim();
      const pw = document.getElementById("loginPw").value.trim();
      if(!id || !pw){ toast("입력 필요","아이디/비밀번호를 입력하세요."); return; }

      const email = toEmail(id);
      logEvent(`로그인 시도: ${id} → ${email}`);

      const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error){
        console.error(error);
        toast("로그인 실패", error.message);
        return;
      }

      authUser = data.user;

      // ✅ 여기서 프로필을 못 읽으면 "왜 못 읽는지"를 정확히 토스트로 보여주고 signOut
      profile = await fetchMyProfile();
      if(!profile){
        logEvent(`프로필 로드 실패: uid=${authUser?.id || "-"}`);
        toast("프로필 없음", "Auth는 성공했지만 프로필 테이블에서 사용자를 찾지 못했습니다.\n(테이블/정책/RLS 확인 필요)");
        await sb.auth.signOut();
        authUser = null;
        return;
      }

      logEvent(`로그인: ${profile.login_id} (${profile.role}${isMasterAccount(profile) ? "/MASTER" : ""})`);

      await afterLoginBootstrap();
      activePage = "dash";
      mount();
    }

    async function logout(){
      await sb.auth.signOut();
      authUser = null;
      profile = null;
      usersCache = [];
      slotsCache = [];
      activePage = "dash";
      mount();
    }

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && document.getElementById("loginView").style.display!=="none"){
        login();
      }
    });

    async function afterLoginBootstrap(){
      await fetchUsersIfAdmin();
      await fetchSlots();
    }

    /***********************
     * 5) 화면 마운트/네비
     ***********************/
    function mount(){
      const isLoggedIn = !!profile;

      document.getElementById("loginView").style.display = isLoggedIn ? "none" : "grid";
      document.getElementById("appView").style.display = isLoggedIn ? "block" : "none";
      if(!isLoggedIn) return;

      const roleText = isMasterAccount(profile) ? "마스터 계정" : (ROLE_LABEL[profile.role] || profile.role);
      document.getElementById("whoText").textContent =
        `${profile.company_name ? profile.company_name + " " : ""}${profile.login_id} (${roleText})`;

      // 네비
      const nav = document.getElementById("navTabs");
      nav.innerHTML = "";
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      allowed.forEach(p=>{
        const b = document.createElement("button");
        b.className = "tab" + (p.key===activePage ? " active" : "");
        b.textContent = p.label;
        b.onclick = ()=>{ activePage = p.key; render(); };
        nav.appendChild(b);
      });

      // 마스터면 사용자 생성 role에 ADMIN 옵션 추가
      const roleSel = document.getElementById("u_role");
      if(roleSel){
        const hasAdmin = [...roleSel.options].some(o=>o.value==="ADMIN");
        if(isMasterAccount(profile) && !hasAdmin){
          const opt = document.createElement("option");
          opt.value = "ADMIN";
          opt.textContent = "관리자(ADMIN)";
          roleSel.appendChild(opt);
        }
      }

      render();
    }

    function showPage(key){
      for(const p of PAGES){
        const el = document.getElementById("page_"+p.key);
        if(el) el.style.display = (p.key===key) ? "grid" : "none";
      }
      const allowed = PAGES.filter(p => p.roles.includes(profile.role));
      const nav = document.getElementById("navTabs");
      [...nav.children].forEach((node, idx)=>{
        node.classList.toggle("active", allowed[idx]?.key === key);
      });
    }

    function render(){
      showPage(activePage);
      if(activePage==="dash") renderDash();
      if(activePage==="slots") renderSlotsPage();
      if(activePage==="assign") renderAssign();
      if(activePage==="users") renderUsers();
      if(activePage==="cleanup") renderCleanup();
      if(activePage==="logs") renderLogs();
    }

    async function refresh(){
      if(!profile) return;
      await afterLoginBootstrap();
      render();
      toast("새로고침 완료");
    }

    /***********************
     * 6) 슬롯 표시/수정/관리
     ***********************/
    function visibleSlotsForUser(allSlots){
      const slots = allSlots.map(s=>({ ...s, expired: computeExpired(s) }));
      if(profile.role==="ADMIN") return slots;
      return slots.filter(s =>
        (s.user_uid === authUser.id) &&
        !s.hiddenByAdmin &&
        !s.withdrawPending &&
        (s.opened || s.saved)
      );
    }

    function renderSlotsPage(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const slots = visibleSlotsForUser(all);

      const uf = document.getElementById("slotUserFilter");
      if(profile.role==="ADMIN"){
        const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID));
        const current = uf.value || "ALL";
        uf.innerHTML =
          `<option value="ALL">전체</option>` +
          targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
        uf.value = current;
        uf.disabled = false;
      } else {
        uf.innerHTML = `<option value="${escapeHtml(authUser.id)}">${escapeHtml(profile.company_name ? `${profile.company_name}(${profile.login_id})` : profile.login_id)}</option>`;
        uf.value = authUser.id;
        uf.disabled = true;
      }

      const hint = document.getElementById("slotHint");
      hint.innerHTML = (profile.role==="ADMIN")
        ? `관리자 모드: 전체 슬롯 조회 · 사용자에게는 <b style="color:rgba(255,255,255,.95)">오픈/정상</b> 슬롯만 노출`
        : `사용자 모드: <b style="color:rgba(255,255,255,.95)">오픈됨/정상</b> 슬롯만 보입니다.`;

      const q = (document.getElementById("slotSearch").value || "").trim().toLowerCase();
      const st = document.getElementById("slotFilter").value || "ALL";
      const ufi = document.getElementById("slotUserFilter").value || "ALL";

      let rows = [...slots];

      if(profile.role==="ADMIN" && ufi !== "ALL"){
        rows = rows.filter(s => (s.user_uid === ufi));
      }

      if(st !== "ALL"){
        if(st==="ALLOCATED") rows = rows.filter(s => !s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="OPENED") rows = rows.filter(s => s.opened && !s.saved && !s.expired && !s.withdrawPending);
        if(st==="SAVED") rows = rows.filter(s => s.saved && !s.expired && !s.withdrawPending);
        if(st==="EXPIRED") rows = rows.filter(s => s.expired);
      }

      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          const uname = (profile.role==="ADMIN")
            ? (usersCache.find(u=>u.user_id===s.user_uid)?.company_name || "") + " " + (usersCache.find(u=>u.user_id===s.user_uid)?.login_id || "")
            : (profile.company_name||"") + " " + (profile.login_id||"");
          return (
            (String(s.no||"").includes(q)) ||
            (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) ||
            (s.memo||"").toLowerCase().includes(q) ||
            storeId.includes(q) ||
            uname.toLowerCase().includes(q)
          );
        });
      }

      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      const tb = document.getElementById("slotTbody");
      tb.innerHTML = "";

      for(const s of rows){
        const tr = document.createElement("tr");

        const canEdit =
          (!s.expired) &&
          (!s.withdrawPending) &&
          (profile.role==="ADMIN" || s.user_uid === authUser.id) &&
          (s.opened || s.saved);

        const isEditing = editingSlotIds.has(s.id);

        let manage = "";
        if(profile.role==="ADMIN"){
          const withdrawBtn = (!s.expired && !s.withdrawPending)
            ? `<button class="btn mini btnRed" data-act="withdraw" data-id="${escapeHtml(s.id)}">철회</button>`
            : "";

          const extendBtn = (!s.expired && !s.withdrawPending && s.opened && s.saved)
            ? `<button class="btn mini btnNeon" data-act="extend" data-id="${escapeHtml(s.id)}">연장</button>`
            : "";

          if(s.withdrawPending){
            manage = `<span class="muted">철회 대기</span>`;
          } else if(s.hiddenByAdmin && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">오픈</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else if(!s.opened && !s.saved && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="open" data-id="${escapeHtml(s.id)}">오픈</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else if((s.opened || s.saved) && !s.expired){
            manage = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini" data-act="hide" data-id="${escapeHtml(s.id)}">숨김</button>
                ${extendBtn}
                ${withdrawBtn}
              </div>
            `;
          } else {
            manage = `<span class="muted">-</span>`;
          }
        } else {
          manage = s.expired ? `<span class="tag red">만료</span>` : `<span class="muted">-</span>`;
        }

        let editCell = `<span class="muted">-</span>`;
        if(canEdit){
          if(!isEditing){
            editCell = `<button class="btn mini btnGreen" data-act="edit" data-id="${escapeHtml(s.id)}">수정</button>`;
          } else {
            editCell = `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-act="save" data-id="${escapeHtml(s.id)}">저장</button>
                <button class="btn mini" data-act="cancel" data-id="${escapeHtml(s.id)}">취소</button>
              </div>
            `;
          }
        }

        let kwCell, linkCell, memoCell;
        if(isEditing){
          const d = ensureSlotDraft(s);
          kwCell = `<input class="tInput" data-f="kw" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.kw)}" placeholder="키워드" />`;
          linkCell = renderLinkCellEditing(s, d);
          memoCell = `<input class="tInput" data-f="memo" data-id="${escapeHtml(s.id)}" value="${escapeHtml(d.memo)}" placeholder="메모" />`;
        } else {
          kwCell = `${escapeHtml(s.keyword||"")}`;
          linkCell = renderLinkCellReadOnly(s);
          memoCell = `${escapeHtml(s.memo||"")}`;
        }

        const expSoon = isExpiringTomorrow(s.endDate);

        const who = (profile.role==="ADMIN")
          ? (usersCache.find(u=>u.user_id===s.user_uid) ? ((usersCache.find(u=>u.user_id===s.user_uid).company_name||"") ? `${usersCache.find(u=>u.user_id===s.user_uid).company_name}(${usersCache.find(u=>u.user_id===s.user_uid).login_id})` : usersCache.find(u=>u.user_id===s.user_uid).login_id) : "-")
          : (profile.company_name ? `${profile.company_name}(${profile.login_id})` : profile.login_id);

        tr.innerHTML = `
          <td><span class="muted">-</span></td>
          <td>${escapeHtml(String(s.no||"-"))}</td>
          <td><div style="font-weight:1200">${escapeHtml(who)}</div></td>
          <td><span class="tag gold typeTag">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td>${escapeHtml(s.startDate||"-")}</td>
          <td class="${expSoon ? "expSoon" : ""}">${escapeHtml(s.endDate||"-")}</td>
          <td>${slotStateTag(s)}</td>
          <td>${editCell}</td>
          <td>${kwCell}</td>
          <td>${linkCell}</td>
          <td>${memoCell}</td>
          <td>${manage}</td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll('input[data-f]').forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const id = inp.getAttribute("data-id");
          const f = inp.getAttribute("data-f");
          if(!slotDrafts.has(id)) slotDrafts.set(id, {kw:"",link:"",catalogLink:"",memo:""});
          const d = slotDrafts.get(id);
          if(f==="kw") d.kw = inp.value;
          if(f==="link") d.link = inp.value;
          if(f==="catalogLink") d.catalogLink = inp.value;
          if(f==="memo") d.memo = inp.value;
        });
      });

      tb.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act==="edit"){
            editingSlotIds.add(id);
            const s = slotsCache.find(x=>x.id===id);
            if(s) ensureSlotDraft(s);
            renderSlotsPage();
            toast("수정 모드", "저장/취소 가능");
            return;
          }
          if(act==="cancel"){
            editingSlotIds.delete(id);
            slotDrafts.delete(id);
            renderSlotsPage();
            return;
          }
          if(act==="save"){ saveSlotInline(id); return; }
          if(act==="open"){ openSlot(id); return; }
          if(act==="hide"){ hideSlot(id); return; }
          if(act==="withdraw"){ withdrawSlot(id); return; }
          if(act==="extend"){ extendSlotUI(id); return; }
        });
      });
    }

    async function saveSlotInline(id){
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("슬롯을 찾을 수 없음"); return; }
      if(computeExpired(s)){ toast("만료된 슬롯"); return; }
      if(s.withdrawPending){ toast("철회 대기 슬롯"); return; }

      const d = slotDrafts.get(id) || { kw: s.keyword||"", link: s.link||"", catalogLink: s.catalogLink||"", memo: s.memo||"" };
      const kw = (d.kw || "").trim();
      const link = (d.link || "").trim();
      const catalogLink = (d.catalogLink || "").trim();
      const memo = (d.memo || "").trim();

      const wonbu = isTypeWonbu(s.type);
      if(!kw || !link){
        toast("저장 실패", "키워드/상품링크는 필수입니다.");
        return;
      }
      if(wonbu && !catalogLink){
        toast("저장 실패", "원부 타입은 카탈로그 링크도 필수입니다.");
        return;
      }

      const storeId = extractStoreId(link);

      const payload = {
        keyword: kw,
        link: link,
        catalog_link: wonbu ? catalogLink : "",
        memo: memo,
        store_id: storeId,
        opened: true,
        saved: true,
        hidden_by_admin: false,
        withdraw_pending: false
      };

      const { error } = await sb.from("slots").update(payload).eq("id", id);
      if(error){
        console.error(error);
        toast("저장 실패", error.message);
        return;
      }

      logEvent(`슬롯 저장: no=${s.no}, kw=${kw}, storeId=${storeId||"-"}`);
      toast("저장 완료", storeId ? `스토어ID: ${storeId}` : "스토어ID 추출 실패(링크 확인)");

      editingSlotIds.delete(id);
      slotDrafts.delete(id);

      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    async function openSlot(id){
      const { error } = await sb.from("slots").update({
        hidden_by_admin:false,
        withdraw_pending:false,
        opened:true
      }).eq("id", id);
      if(error){ toast("오픈 실패", error.message); return; }
      logEvent(`슬롯 오픈: slot=${id}`);
      toast("오픈 완료", "사용자 화면에 노출됩니다.");
      await fetchSlots();
      renderSlotsPage();
    }

    async function hideSlot(id){
      const { error } = await sb.from("slots").update({
        hidden_by_admin:true,
        opened:false
      }).eq("id", id);
      if(error){ toast("숨김 실패", error.message); return; }
      logEvent(`슬롯 숨김: slot=${id}`);
      toast("숨김 처리", "관리자에게만 보이게 숨김");
      editingSlotIds.delete(id);
      slotDrafts.delete(id);
      await fetchSlots();
      renderSlotsPage();
    }

    async function withdrawSlot(id){
      if(profile.role !== "ADMIN"){ toast("권한 없음"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("슬롯 없음"); return; }
      if(computeExpired(s)){ toast("만료된 슬롯"); return; }

      const ok = confirm(
        `철회 처리(철회 대기)로 변경할까요?\n\n번호: ${s.no}\n\n* 사용자 화면 숨김\n* ‘슬롯 삭제’에만 표시`
      );
      if(!ok) return;

      const { error } = await sb.from("slots").update({
        withdraw_pending:true,
        hidden_by_admin:true,
        opened:false,
        saved:false
      }).eq("id", id);

      if(error){ toast("철회 실패", error.message); return; }

      logEvent(`슬롯 철회대기: no=${s.no}`);
      toast("철회 대기", `번호 ${s.no} → 슬롯 삭제 메뉴로 이동`);

      editingSlotIds.delete(id);
      slotDrafts.delete(id);

      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    function askExtendDays(defaultVal="7"){
      const v = prompt("연장할 일수를 입력하세요 (예: 7)", defaultVal);
      if(v===null) return null;
      const d = parseInt(String(v).trim(), 10);
      if(!d || d < 1) return null;
      return d;
    }

    async function extendSlotUI(id){
      if(profile.role !== "ADMIN"){ toast("권한 없음"); return; }
      const s = slotsCache.find(x=>x.id===id);
      if(!s){ toast("슬롯 없음"); return; }
      if(!(s.opened && s.saved)){ toast("연장 불가", "오픈+저장완료 슬롯만 연장됩니다."); return; }

      const d = askExtendDays("7");
      if(!d){ toast("연장 취소/오류"); return; }

      const newEnd = addDaysToDateStr(s.endDate, d);
      const ok = confirm(`번호 ${s.no} 슬롯을 +${d}일 연장할까요?\n(만료일: ${s.endDate} → ${newEnd})`);
      if(!ok) return;

      const { error } = await sb.from("slots").update({ end_date: newEnd }).eq("id", id);
      if(error){ toast("연장 실패", error.message); return; }

      logEvent(`연장: no=${s.no}, +${d}일`);
      toast("연장 완료", `번호 ${s.no} +${d}일`);

      await fetchSlots();
      renderSlotsPage();
      if(activePage==="dash") renderDash();
    }

    /***********************
     * 7) 슬롯부여(관리자)
     ***********************/
    function syncAssignEndFromStart(){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, 10);
    }

    function renderAssign(){
      if(profile.role!=="ADMIN"){ activePage="slots"; render(); return; }

      const sel = document.getElementById("assign_user");
      const targets = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID));
      sel.innerHTML = targets.length
        ? targets.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)} (${ROLE_LABEL[u.role]||u.role})</option>`).join("")
        : `<option value="">(사용자 계정이 없습니다)</option>`;
      sel.disabled = targets.length===0;

      const st = document.getElementById("assign_start");
      const en = document.getElementById("assign_end");

      if(!st.value){
        const d = new Date();
        d.setDate(d.getDate() + 1);
        st.value = d.toISOString().slice(0,10);
      }
      if(!en.value){
        en.value = addDaysToDateStr(st.value, 10);
      }
    }

    function quickDays(n){
      const stVal = document.getElementById("assign_start").value;
      if(!stVal) return;
      document.getElementById("assign_end").value = addDaysToDateStr(stVal, n);
    }

    async function allocateSlots(){
      if(profile.role!=="ADMIN"){ toast("권한 없음"); return; }

      const uid = document.getElementById("assign_user").value;
      const type = document.getElementById("assign_type").value || "스퀘어(단일)";
      const qty = parseInt(document.getElementById("assign_qty").value || "0", 10);
      const start = document.getElementById("assign_start").value;
      const end = document.getElementById("assign_end").value;

      if(!uid){ toast("사용자 선택 필요"); return; }
      if(!qty || qty<1){ toast("수량은 1 이상"); return; }
      if(!start || !end){ toast("기간 입력 필요"); return; }

      const maxNo = (slotsCache || []).reduce((m,s)=>Math.max(m, s.no||0), 0);

      const newRows = [];
      for(let i=0;i<qty;i++){
        newRows.push({
          id: crypto.randomUUID(),
          no: maxNo + i + 1,
          user_id: uid,
          type: type,
          start_date: start,
          end_date: end,
          opened: false,
          saved: false,
          hidden_by_admin: false,
          withdraw_pending: false,
          keyword: "",
          link: "",
          catalog_link: "",
          memo: "",
          store_id: "",
          created_at: nowISO()
        });
      }

      const { error } = await sb.from("slots").insert(newRows);
      if(error){
        console.error(error);
        toast("슬롯부여 실패", error.message);
        return;
      }

      logEvent(`슬롯부여: user=${uid}, qty=${qty}, 타입=${type}, 기간=${start}~${end}`);
      toast("슬롯부여 완료", `총 ${qty}개 생성됨 (슬롯관리에서 ‘오픈’ 필요)`);

      await fetchSlots();
      activePage = "slots";
      render();
    }

    /***********************
     * 8) 사용자(계정) 생성/수정/삭제 (관리자)
     ***********************/
    async function createUser(){
      if(profile.role!=="ADMIN"){ toast("권한 없음"); return; }

      const login_id = document.getElementById("u_id").value.trim();
      const password = document.getElementById("u_pw").value.trim();
      const role = document.getElementById("u_role").value;
      const company_name = document.getElementById("u_company").value.trim();

      if(!login_id || login_id.length < 2){ toast("아이디를 입력하세요"); return; }
      if(!password || password.length < 2){ toast("비밀번호를 입력하세요"); return; }
      if(!company_name){ toast("업체명은 필수입니다"); return; }

      if(login_id === MASTER_ID){
        toast("생성 불가", "마스터 계정 아이디는 사용할 수 없습니다.");
        return;
      }

      if(role === "ADMIN" && !isMasterAccount(profile)){
        toast("권한 없음", "관리자(ADMIN) 계정 생성은 마스터 계정만 가능합니다.");
        return;
      }

      const body = {
        login_id, password, role, company_name,
        loginId: login_id,
        pw: password,
        companyName: company_name,
        isMaster: false
      };

      const { data, error } = await sb.functions.invoke(EDGE_CREATE_USER, { body });
      if(error){
        console.error(error);
        toast("계정 생성 실패", error.message);
        return;
      }

      logEvent(`계정 생성: ${login_id} (${role}) 업체명=${company_name}`);
      toast("계정 생성 완료", `${company_name}(${login_id}) / ${ROLE_LABEL[role] || role}`);

      document.getElementById("u_id").value = "";
      document.getElementById("u_pw").value = "";
      document.getElementById("u_company").value = "";

      await fetchUsersIfAdmin();
      await fetchSlots();
      renderUsers();
      renderAssign();
      if(activePage==="cleanup") renderCleanup();
    }

    function ensureUserDraft(u){
      if(!userDrafts.has(u.user_id)){
        userDrafts.set(u.user_id, {
          loginNew: u.login_id,
          companyNew: u.company_name || "",
          roleNew: u.role || "ADVERTISER"
        });
      }
      return userDrafts.get(u.user_id);
    }

    async function saveUserInline(userId){
      if(profile.role!=="ADMIN"){ toast("권한 없음"); return; }
      const u = usersCache.find(x=>x.user_id===userId);
      if(!u){ toast("사용자를 찾을 수 없음"); return; }
      if(u.login_id === MASTER_ID){ toast("불가","마스터 계정은 수정 불가"); return; }

      const d = userDrafts.get(userId);
      if(!d){ toast("수정값 없음"); return; }

      const loginNew = (d.loginNew || "").trim();
      const companyNew = (d.companyNew || "").trim();
      const roleNew = (d.roleNew || "").trim();

      if(!loginNew || loginNew.length < 2){ toast("아이디 오류","2글자 이상"); return; }
      if(!companyNew){ toast("업체명 필수"); return; }
      if(!ROLE_LABEL[roleNew]){ toast("역할 오류"); return; }

      if(loginNew === MASTER_ID){ toast("불가","마스터 아이디는 사용 불가"); return; }
      if(roleNew === "ADMIN" && !isMasterAccount(profile)){
        toast("권한 없음","관리자(ADMIN) 변경은 마스터만 가능");
        return;
      }

      const { error } = await sb.from(PROFILE_TABLE_PRIMARY).update({
        login_id: loginNew,
        company_name: companyNew,
        role: roleNew
      }).eq("user_id", userId);

      if(error){
        console.error(error);
        toast("수정 실패", error.message);
        return;
      }

      logEvent(`계정 수정: ${u.login_id} → ${loginNew}`);
      toast("수정 저장 완료", `${companyNew}(${loginNew})`);

      editingUserIds.delete(userId);
      userDrafts.delete(userId);

      await fetchUsersIfAdmin();
      renderUsers();
      renderAssign();
      if(activePage==="dash") renderDash();
      if(activePage==="slots") await refresh();
    }

    async function deleteUser(userId){
      toast("삭제 불가", "Auth 유저 삭제는 서버(Edge Function)로만 가능합니다.\n원하면 삭제용 함수도 만들어줄게.");
    }

    function renderUsers(){
      if(profile.role!=="ADMIN"){ activePage="slots"; render(); return; }

      const tb = document.getElementById("userTbody");

      const users = usersCache.filter(u => !(u.role==="ADMIN" && u.login_id===MASTER_ID));

      tb.innerHTML = "";
      users.forEach(u=>{
        const tr = document.createElement("tr");
        const isEditing = editingUserIds.has(u.user_id);

        if(!isEditing){
          tr.innerHTML = `
            <td style="font-weight:1200">${escapeHtml(u.login_id)}</td>
            <td><span class="tag gray">${escapeHtml(ROLE_LABEL[u.role] || u.role)}</span></td>
            <td class="muted" style="font-weight:1100">${escapeHtml(u.company_name||"")}</td>
            <td class="muted" style="font-weight:1100">-</td>
            <td>
              <button class="btn mini btnGreen" data-uact="edit" data-uid="${escapeHtml(u.user_id)}">수정</button>
            </td>
            <td><button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}">삭제</button></td>
          `;
        } else {
          const d = ensureUserDraft(u);
          const canSeeAdminOpt = isMasterAccount(profile);
          tr.innerHTML = `
            <td>
              <input class="tInput" data-uf="loginNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.loginNew)}" placeholder="아이디" />
            </td>
            <td>
              <select class="tInput" style="min-width:160px" data-uf="roleNew" data-uid="${escapeHtml(u.user_id)}">
                <option value="ADVERTISER" ${d.roleNew==="ADVERTISER"?"selected":""}>광고주</option>
                <option value="AGENCY" ${d.roleNew==="AGENCY"?"selected":""}>대행사</option>
                <option value="DISTRIBUTOR" ${d.roleNew==="DISTRIBUTOR"?"selected":""}>총판사</option>
                ${canSeeAdminOpt ? `<option value="ADMIN" ${d.roleNew==="ADMIN"?"selected":""}>관리자(ADMIN)</option>` : ``}
              </select>
            </td>
            <td>
              <input class="tInput" data-uf="companyNew" data-uid="${escapeHtml(u.user_id)}" value="${escapeHtml(d.companyNew)}" placeholder="업체명" />
            </td>
            <td class="muted" style="font-weight:1100">-</td>
            <td>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn mini btnNeon" data-uact="save" data-uid="${escapeHtml(u.user_id)}">저장</button>
                <button class="btn mini" data-uact="cancel" data-uid="${escapeHtml(u.user_id)}">취소</button>
              </div>
            </td>
            <td><button class="btn mini btnRed" data-del="${escapeHtml(u.user_id)}">삭제</button></td>
          `;
        }
        tb.appendChild(tr);
      });

      tb.querySelectorAll('[data-uf]').forEach(el=>{
        const uid = el.getAttribute("data-uid");
        const f = el.getAttribute("data-uf");

        const handler = ()=>{
          if(!userDrafts.has(uid)) userDrafts.set(uid, {loginNew:"",companyNew:"",roleNew:"ADVERTISER"});
          const d = userDrafts.get(uid);
          if(f==="loginNew") d.loginNew = el.value;
          if(f==="companyNew") d.companyNew = el.value;
          if(f==="roleNew") d.roleNew = el.value;
        };

        el.addEventListener("input", handler);
        el.addEventListener("change", handler);
      });

      tb.querySelectorAll("button[data-uact]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-uact");
          const uid = btn.getAttribute("data-uid");

          if(act==="edit"){
            editingUserIds.add(uid);
            const u = usersCache.find(x=>x.user_id===uid);
            if(u) ensureUserDraft(u);
            renderUsers();
            toast("사용자 수정모드", "아이디/업체명/역할 수정");
            return;
          }
          if(act==="cancel"){
            editingUserIds.delete(uid);
            userDrafts.delete(uid);
            renderUsers();
            return;
          }
          if(act==="save"){
            saveUserInline(uid);
            return;
          }
        });
      });

      tb.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const uid = btn.getAttribute("data-del");
          deleteUser(uid);
        });
      });
    }

    /***********************
     * 9) Cleanup / Dash / Logs
     ***********************/
    function renderCleanup(){
      if(profile.role!=="ADMIN"){ activePage="slots"; render(); return; }

      const slots = slotsCache.map(s=>({ ...s, expired: computeExpired(s) })).filter(s=>!!s.withdrawPending);

      const cleanUser = document.getElementById("cleanUser");
      const users = usersCache.filter(u=>!(u.role==="ADMIN" && u.login_id===MASTER_ID));
      const prev = cleanUser.value || "ALL";
      cleanUser.innerHTML =
        `<option value="ALL">전체</option>` +
        users.map(u=>`<option value="${escapeHtml(u.user_id)}">${escapeHtml((u.company_name||"") ? `${u.company_name}(${u.login_id})` : u.login_id)}</option>`).join("");
      cleanUser.value = prev;

      const q = (document.getElementById("cleanSearch").value || "").trim().toLowerCase();
      const ufi = cleanUser.value || "ALL";

      let rows = [...slots];
      if(ufi !== "ALL") rows = rows.filter(s=>s.user_uid===ufi);

      if(q){
        rows = rows.filter(s => {
          const storeId = (s.storeId || "").toLowerCase();
          const linkAll = ((s.link||"") + " " + (s.catalogLink||"")).toLowerCase();
          return (
            (String(s.no||"").includes(q)) ||
            (s.keyword||"").toLowerCase().includes(q) ||
            linkAll.includes(q) ||
            (s.memo||"").toLowerCase().includes(q) ||
            storeId.includes(q)
          );
        });
      }

      rows.sort((a,b)=> (a.no||0)-(b.no||0));

      const tb = document.getElementById("cleanTbody");
      tb.innerHTML = "";
      rows.forEach(s=>{
        const who = usersCache.find(u=>u.user_id===s.user_uid);
        const whoText = who ? ((who.company_name||"") ? `${who.company_name}(${who.login_id})` : who.login_id) : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(String(s.no||"-"))}</td>
          <td style="font-weight:1200">${escapeHtml(whoText)}</td>
          <td><span class="tag gold typeTag">${escapeHtml(typeDisplay(s.type))}</span></td>
          <td>${storeIdTagHtml(s)}</td>
          <td>${slotStateTag(s)}</td>
          <td>${escapeHtml(s.keyword||"")}</td>
          <td>${renderLinkCellReadOnly(s)}</td>
          <td>${escapeHtml(s.memo||"")}</td>
          <td><button class="btn mini btnRed" data-del-slot="${escapeHtml(s.id)}">삭제</button></td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll("button[data-del-slot]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-del-slot");
          const ok = confirm("이 슬롯을 완전 삭제할까요? (복구 불가)");
          if(!ok) return;
          const { error } = await sb.from("slots").delete().eq("id", id);
          if(error){ toast("삭제 실패", error.message); return; }
          logEvent(`슬롯 완전삭제: slot=${id}`);
          toast("삭제 완료");
          await fetchSlots();
          renderCleanup();
          if(activePage==="dash") renderDash();
        });
      });
    }

    function renderDash(){
      const all = slotsCache.map(s=>({ ...s, expired: computeExpired(s) }));
      const visible = visibleSlotsForUser(all);

      const opened = visible.filter(s=>s.opened && !s.expired).length;
      const saved = visible.filter(s=>s.saved && !s.expired).length;
      const expired = visible.filter(s=>s.expired).length;

      const kpi = document.getElementById("kpi");
      kpi.innerHTML = "";

      const items = (profile.role==="ADMIN")
        ? [
            { v: String(all.length), k: "전체 슬롯" },
            { v: String(all.filter(s=>s.withdrawPending).length), k: "철회 대기" },
            { v: String(all.filter(s=>s.hiddenByAdmin && !s.withdrawPending && !s.expired).length), k: "숨김" },
            { v: String(all.filter(s=>s.saved && !s.expired).length), k: "정상" },
          ]
        : [
            { v: String(visible.length), k: "전체 슬롯" },
            { v: String(opened), k: "오픈됨" },
            { v: String(saved), k: "정상" },
            { v: String(expired), k: "만료" },
          ];

      items.forEach(it=>{
        const d = document.createElement("div");
        d.className = "box";
        d.innerHTML = `<div class="v">${escapeHtml(it.v)}</div><div class="k">${escapeHtml(it.k)}</div>`;
        kpi.appendChild(d);
      });
    }

    function renderLogs(){
      const box = document.getElementById("logBox");
      box.textContent = logArr.length ? logArr.join("\n") : "로그가 없습니다.";
    }

    /***********************
     * 10) 최초 로딩: 세션 자동 복구
     ***********************/
    (async function init(){
      const { data } = await sb.auth.getSession();
      authUser = data?.session?.user || null;
      if(authUser){
        profile = await fetchMyProfile();
        if(profile){
          await afterLoginBootstrap();
          logEvent(`세션 복구: ${profile.login_id}`);
        } else {
          await sb.auth.signOut();
          authUser = null;
          profile = null;
        }
      }

      sb.auth.onAuthStateChange(async (event, session) => {
        authUser = session?.user || null;
        if(!authUser){
          profile = null;
          usersCache = [];
          slotsCache = [];
          activePage = "dash";
          mount();
          return;
        }
        profile = await fetchMyProfile();
        if(profile){
          await afterLoginBootstrap();
          mount();
        }
      });

      mount();
    })();
  </script>
</body>
</html>
